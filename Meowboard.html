<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± Meowboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Tema claro por defecto */
            --project-bg-gradient: linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comfortaa', cursive;
            background: linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-cat {
            position: relative;
            margin-bottom: 40px;
        }

        .cat-body {
            width: 120px;
            height: 80px;
            background: #FFEAF0;
            border-radius: 50px;
            position: relative;
            border: 3px solid #FFB8CC;
            animation: catBreathe 2s ease-in-out infinite;
        }

        .cat-head {
            width: 100px;
            height: 90px;
            background: #FFEAF0;
            border-radius: 50px;
            position: absolute;
            top: -60px;
            left: 10px;
            border: 3px solid #FFB8CC;
            animation: catHeadBob 3s ease-in-out infinite;
        }

        .cat-ear {
            width: 25px;
            height: 35px;
            background: #FFB8CC;
            border-radius: 25px 25px 0 0;
            position: absolute;
            top: -15px;
            animation: earWiggle 2.5s ease-in-out infinite;
        }

        .cat-ear.left {
            left: 20px;
            transform: rotate(-20deg);
        }

        .cat-ear.right {
            right: 20px;
            transform: rotate(20deg);
        }

        .cat-ear-inner {
            width: 15px;
            height: 20px;
            background: #FF9DB8;
            border-radius: 15px 15px 0 0;
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .cat-eye {
            width: 12px;
            height: 12px;
            background: #5A5A5A;
            border-radius: 50%;
            position: absolute;
            top: 35px;
            animation: blink 4s infinite;
        }

        .cat-eye.left {
            left: 25px;
        }

        .cat-eye.right {
            right: 25px;
        }

        .cat-nose {
            width: 8px;
            height: 6px;
            background: #FF9DB8;
            border-radius: 0 0 8px 8px;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
        }

        .cat-mouth {
            width: 20px;
            height: 10px;
            border: 2px solid #FF8FA3;
            border-top: none;
            border-radius: 0 0 20px 20px;
            position: absolute;
            top: 58px;
            left: 50%;
            transform: translateX(-50%);
        }

        .cat-whisker {
            width: 30px;
            height: 2px;
            background: #FF9DB8;
            position: absolute;
            top: 45px;
            border-radius: 2px;
        }

        .cat-whisker.left1 {
            left: -25px;
            transform: rotate(-10deg);
        }

        .cat-whisker.left2 {
            left: -25px;
            top: 55px;
            transform: rotate(10deg);
        }

        .cat-whisker.right1 {
            right: -25px;
            transform: rotate(10deg);
        }

        .cat-whisker.right2 {
            right: -25px;
            top: 55px;
            transform: rotate(-10deg);
        }

        .cat-tail {
            width: 15px;
            height: 60px;
            background: #FFB8CC;
            border-radius: 15px;
            position: absolute;
            right: -20px;
            top: -10px;
            transform-origin: top center;
            animation: tailWag 1.5s ease-in-out infinite;
        }

        .cat-paw {
            width: 20px;
            height: 15px;
            background: #FFB8CC;
            border-radius: 15px;
            position: absolute;
            bottom: -10px;
        }

        .cat-paw.left {
            left: 20px;
        }

        .cat-paw.right {
            right: 20px;
        }

        /* Loading Text */
        .loading-text {
            font-size: 28px;
            font-weight: 700;
            color: #E85A9A;
            margin-bottom: 30px;
            animation: textGlow 2s ease-in-out infinite;
        }

        /* Loading Bar */
        .loading-bar-container {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 25px;
            border: 3px solid #FFB8CC;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFB8CC, #FF9DB8, #DEB3F0);
            border-radius: 25px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .loading-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .loading-percentage {
            font-size: 14px;
            color: #E85A9A;
            font-weight: 600;
            margin-top: 10px;
        }

        .loading-tips {
            font-size: 12px;
            color: #C285D1;
            text-align: center;
            max-width: 250px;
            line-height: 1.4;
        }

        /* Paw prints background */
        .paw-prints {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .paw-print {
            position: absolute;
            font-size: 20px;
            color: rgba(255, 184, 204, 0.3);
            animation: pawFloat 8s linear infinite;
        }

        /* Animations */
        @keyframes catBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes catHeadBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes earWiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        @keyframes tailWag {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        @keyframes textGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(255, 184, 204, 0.7); }
            50% { text-shadow: 0 0 20px rgba(255, 184, 204, 1.0), 0 0 30px rgba(222, 179, 240, 0.5); }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pawFloat {
            0% { 
                transform: translateY(100vh) rotate(0deg); 
                opacity: 0; 
            }
            10% { 
                opacity: 1; 
            }
            90% { 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-100px) rotate(360deg); 
                opacity: 0; 
            }
        }

        /* Slogan Styles */
        .loading-slogan {
            font-size: 18px;
            font-weight: 500;
            color: #C285D1;
            margin-bottom: 20px;
            text-align: center;
            animation: sloganFloat 3s ease-in-out infinite;
            text-shadow: 0 2px 10px rgba(194, 133, 209, 0.5);
            max-width: 400px;
            line-height: 1.3;
            font-style: italic;
        }

        /* Constellation Canvas */
        #loading-constellation-canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1;
            opacity: 0.7;
        }

        /* Corner decorations */
        .corner-decoration {
            position: absolute;
            font-size: 40px;
            opacity: 0.6;
            animation: cornerPulse 4s ease-in-out infinite;
        }

        .corner-decoration.top-left {
            top: 50px;
            left: 50px;
        }

        .corner-decoration.top-right {
            top: 50px;
            right: 50px;
        }

        .corner-decoration.bottom-left {
            bottom: 50px;
            left: 50px;
        }

        .corner-decoration.bottom-right {
            bottom: 50px;
            right: 50px;
        }

        /* Floating elements around the cat */
        .cat-decoration {
            position: absolute;
            font-size: 16px;
            animation: orbitCat 20s ease-in-out infinite;
            opacity: 0.7;
        }

        .cat-decoration.orbit1 {
            animation-delay: 0s;
        }

        .cat-decoration.orbit2 {
            animation-delay: -5s;
        }

        .cat-decoration.orbit3 {
            animation-delay: -10s;
        }

        .cat-decoration.orbit4 {
            animation-delay: -15s;
        }

        /* New Animations */
        @keyframes sloganFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }



        @keyframes cornerPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.6;
            }
            50% { 
                transform: scale(1.2); 
                opacity: 1;
            }
        }

        @keyframes orbitCat {
            0% { 
                transform: rotate(0deg) translateX(60px) rotate(0deg) scale(0.9); 
                opacity: 0.5;
            }
            25% { 
                transform: rotate(90deg) translateX(70px) rotate(-90deg) scale(1); 
                opacity: 0.8;
            }
            50% { 
                transform: rotate(180deg) translateX(60px) rotate(-180deg) scale(1.1); 
                opacity: 0.6;
            }
            75% { 
                transform: rotate(270deg) translateX(70px) rotate(-270deg) scale(1); 
                opacity: 0.8;
            }
            100% { 
                transform: rotate(360deg) translateX(60px) rotate(-360deg) scale(0.9); 
                opacity: 0.5;
            }
        }

        @keyframes specialExplode {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(calc(-50% + var(--random-x, 0px)), calc(-50% + var(--random-y, 0px))) scale(0.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-bottom: 3px solid #FFB8CC;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Tabs System */
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .tabs-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
        }

        .tab-btn {
            background: rgba(255, 184, 204, 0.15);
            border: 2px solid transparent;
            padding: 8px 16px;
            border-radius: 20px;
            color: #E85A9A;
            font-family: 'Comfortaa', cursive;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover {
            background: rgba(255, 184, 204, 0.28);
            border-color: rgba(255, 184, 204, 0.6);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #FFB8CC, #FF9DB8);
            color: white;
            border-color: #FF9DB8;
            box-shadow: 0 4px 15px rgba(255, 184, 204, 0.4);
        }

        .toolbar-section {
            width: 100%;
            margin-top: 10px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .toolbar-section.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #E85A9A;
        }

        .logo::before {
            content: "üê±";
            font-size: 28px;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: linear-gradient(45deg, #FFB8CC, #FF9DB8);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-family: 'Comfortaa', cursive;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 184, 204, 0.5);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 184, 204, 0.7);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #DEB3F0, #C285D1);
            box-shadow: 0 4px 15px rgba(222, 179, 240, 0.5);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(222, 179, 240, 0.7);
        }

        .btn-success {
            background: linear-gradient(45deg, #B8E6D3, #9EDDC0);
            box-shadow: 0 4px 15px rgba(184, 230, 211, 0.5);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(184, 230, 211, 0.7);
        }

        /* Workspace */
        .workspace {
            height: calc(100vh - 80px);
            position: relative;
            overflow: hidden;
            background: var(--project-bg-gradient, linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%));
            transition: background 0.5s ease;
        }

        .canvas {
            width: 10000px;
            height: 10000px;
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
            background: var(--project-bg-gradient, linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%));
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.3) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 50px 50px;
            background-attachment: local;
            transform-origin: 0 0;
        }

        /* Template-specific backgrounds */
        .canvas.template-brainstorm {
            background: linear-gradient(45deg, #F2C2C6 0%, #F4E4F2 50%, #F4E4F2 100%);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.35) 3px, transparent 3px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.15) 2px, transparent 2px),
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.08) 32%, rgba(255, 255, 255, 0.08) 34%, transparent 36%);
            background-size: 60px 60px, 40px 40px, 80px 80px;
        }

        .canvas.template-project {
            background: linear-gradient(135deg, #B8C4E8 0%, #C2AFCA 100%);
            background-image: 
                linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(180deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                repeating-linear-gradient(0deg, transparent, transparent 250px, rgba(255, 255, 255, 0.04) 252px, rgba(255, 255, 255, 0.04) 254px);
            background-size: 250px 250px, 250px 250px, 250px 250px;
        }

        .canvas.template-mindmap {
            background: radial-gradient(circle at center, #D4EDE8 0%, #F4E0E8 100%);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.25) 1px, transparent 1px),
                radial-gradient(circle at 25% 75%, rgba(255, 255, 255, 0.15) 2px, transparent 2px),
                radial-gradient(circle at 75% 25%, rgba(255, 255, 255, 0.15) 1px, transparent 1px);
            background-size: 100px 100px, 150px 150px, 120px 120px;
        }

        .canvas.template-timeline {
            background: linear-gradient(to right, #F9F0E2 0%, #F2CDB4 100%);
            background-image: 
                linear-gradient(90deg, rgba(255, 255, 255, 0.25) 2px, transparent 2px),
                repeating-linear-gradient(90deg, transparent, transparent 200px, rgba(255, 255, 255, 0.15) 202px, rgba(255, 255, 255, 0.15) 204px);
            background-size: 50px 50px, 200px 200px;
        }



        .canvas.template-story {
            background: linear-gradient(45deg, #F2B8C2 0%, #F9E8A6 100%);
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 150px, rgba(255, 255, 255, 0.08) 152px, rgba(255, 255, 255, 0.08) 154px),
                repeating-linear-gradient(-45deg, transparent, transparent 150px, rgba(255, 255, 255, 0.08) 152px, rgba(255, 255, 255, 0.08) 154px);
            background-size: 150px 150px;
            transition: background 0.5s ease;
        }

        .canvas:active {
            cursor: grabbing;
        }

        /* Sticky Notes */
        .sticky-note {
            position: absolute;
            width: 200px;
            min-height: 150px;
            background: #FFF5D6;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            cursor: grab;
            padding: 15px;
            border: 3px solid #FFD700;
            transition: all 0.3s ease;
            resize: both;
            overflow: auto;
        }

        .sticky-note:active {
            cursor: grabbing;
        }

        .sticky-note:hover {
            transform: rotate(1deg) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .sticky-note.pink {
            background: #FFEAF0;
            border-color: #FFB8CC;
        }

        .sticky-note.blue {
            background: #E8F4FF;
            border-color: #A8CEEB;
        }

        .sticky-note.green {
            background: #EAFBEA;
            border-color: #B8E6D3;
        }

        .sticky-note.purple {
            background: #F2E8FF;
            border-color: #DEB3F0;
        }

        .sticky-note textarea {
            width: 100%;
            height: 120px;
            border: none;
            background: transparent;
            font-family: 'Comfortaa', cursive;
            font-size: 14px;
            resize: none;
            outline: none;
            color: #5A5A5A;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .note-emoji {
            font-size: 18px;
            cursor: pointer;
        }

        .note-close {
            background: #ff6b6b;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .note-close:hover {
            background: #ff5252;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4);
        }

        .note-close:active {
            transform: scale(0.9);
            background: #f44336;
        }

        /* Asegurar que el bot√≥n est√© siempre clickeable */
        .note-close {
            pointer-events: all;
            user-select: none;
        }

        /* Estilo espec√≠fico para botones en headers */
        .image-header .note-close,
        .video-header .note-close {
            background: rgba(255, 107, 107, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .image-header .note-close:hover,
        .video-header .note-close:hover {
            background: rgba(255, 82, 82, 0.95);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Image Cards */
        .image-card {
            position: absolute;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            cursor: grab;
            border: 3px solid #FFB6D9;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .image-card:active {
            cursor: grabbing;
        }

        .image-card:hover {
            transform: rotate(-1deg) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        /* Estilos espec√≠ficos para diagramas */
        .image-card.diagram-card {
            border-color: #667eea;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .image-card.diagram-card:hover {
            border-color: #764ba2;
            transform: rotate(-0.5deg) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }

        .image-card.diagram-card::after {
            content: "üìä Doble clic para editar";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px;
            font-size: 11px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-card.diagram-card:hover::after {
            opacity: 1;
        }

        .image-card img {
            width: 100%;
            height: calc(100% - 25px); /* Restar altura de la barra */
            object-fit: cover;
            margin-top: 25px; /* Espacio para la barra */
        }

        /* Mini barra de t√≠tulo para im√°genes */
        .image-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            font-weight: bold;
            z-index: 10;
            border-radius: 12px 12px 0 0;
        }

        .image-header:active {
            cursor: grabbing;
            background: linear-gradient(45deg, #FF8FA3, #FFB6D9);
        }

        .image-header .drag-icon {
            font-size: 12px;
            opacity: 0.8;
        }

        .image-header .image-title {
            flex: 1;
            text-align: center;
            font-size: 10px;
            opacity: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 5px;
        }

        /* Text Blocks */
        .text-block {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            cursor: grab;
            border: 3px solid #A8E6CF;
            min-width: 250px;
            transition: all 0.3s ease;
        }

        .text-block:active {
            cursor: grabbing;
        }

        .text-block:hover {
            transform: rotate(0.5deg) scale(1.01);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .text-block h3 {
            color: #FF6B9D;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .text-block p {
            color: #555;
            line-height: 1.6;
            font-weight: 400;
        }

        /* Links */
        .link-card {
            position: absolute;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            cursor: grab;
            border: 3px solid #87CEEB;
            transition: all 0.3s ease;
        }

        .link-card:active {
            cursor: grabbing;
        }

        .link-card:hover {
            transform: rotate(-0.5deg) scale(1.01);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .link-preview {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .link-icon {
            width: 40px;
            height: 40px;
            background: #87CEEB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .link-info h4 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .link-info p {
            color: #666;
            font-size: 12px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 182, 217, 0.4);
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 35px rgba(255, 182, 217, 0.6);
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            padding: 10px;
            display: none;
            z-index: 1000;
            border: 2px solid #FFB6D9;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #FFB6D9;
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
            border: 3px solid #FFB6D9;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Estilos espec√≠ficos para Assets */
        .asset-element {
            transition: all 0.3s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        }

        .asset-element:hover {
            transform: scale(1.1);
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.3));
        }

        .custom-asset-element {
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .custom-asset-element:hover {
            transform: scale(1.05);
            border-color: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .context-menu {
            animation: contextMenuAppear 0.2s ease-out;
        }

        @keyframes contextMenuAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #assetsGrid::-webkit-scrollbar {
            width: 8px;
        }

        #assetsGrid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #assetsGrid::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #assetsGrid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-title {
            color: #FF6B9D;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: #ff6b6b;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #FFB6D9;
            border-radius: 10px;
            font-family: 'Comfortaa', cursive;
            font-size: 14px;
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #FF6B9D;
        }

        .form-group input[type="file"] {
            padding: 15px;
            background: #F8F9FA;
            border: 2px dashed #FFB6D9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-group input[type="file"]:hover {
            background: #FFE4E6;
            border-color: #FF6B9D;
        }

        .image-options {
            width: 100%;
        }

        .image-options .btn {
            flex: 1;
            margin: 0;
        }

        /* Image Viewer */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            cursor: grab;
        }

        .image-viewer:active {
            cursor: grabbing;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 3px solid #FFB6D9;
        }

        .image-viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 3001;
        }

        .viewer-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 182, 217, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .viewer-btn:hover {
            background: rgba(255, 182, 217, 1);
            transform: scale(1.1);
        }

        .image-viewer-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 182, 217, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: 'Comfortaa', cursive;
            font-size: 14px;
            backdrop-filter: blur(10px);
            z-index: 3001;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: fixed;
            bottom: 30px;
            left: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFB6D9;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #FF6B9D;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: #FFB6D9;
            color: white;
            transform: scale(1.1);
        }

        /* Navigation Info */
        .nav-info {
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFB6D9;
            border-radius: 10px;
            padding: 10px 15px;
            font-family: 'Comfortaa', cursive;
            font-size: 12px;
            color: #FF6B9D;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s ease;
            transform-origin: top right;
        }

        .nav-info.hidden {
            transform: translateX(100%) scale(0.8);
            opacity: 0;
            pointer-events: none;
        }

        .nav-info div {
            margin-bottom: 3px;
        }

        .nav-info .title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-toggle {
            position: fixed;
            top: 90px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 182, 217, 0.9);
            border: 2px solid #FFB6D9;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1001;
        }

        .nav-toggle:hover {
            background: rgba(255, 182, 217, 1);
            transform: scale(1.1);
        }

        .nav-toggle.show {
            display: flex;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .nav-close {
            background: none;
            border: none;
            color: #FF6B9D;
            cursor: pointer;
            font-size: 14px;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .nav-close:hover {
            background: rgba(255, 182, 217, 0.2);
            transform: scale(1.1);
        }

        /* Cute animations */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .bounce {
            animation: bounce 2s infinite;
        }

        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }

        .wiggle {
            animation: wiggle 0.5s ease-in-out;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-right: 3px solid #FFB6D9;
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-content {
            padding: 20px;
        }

        .projects-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #FF6B9D;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .project-item:hover {
            background: rgba(255, 182, 217, 0.1);
            border-color: rgba(255, 182, 217, 0.3);
        }

        .project-item.active {
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            color: white;
            border-color: #FF8FA3;
            box-shadow: 0 4px 15px rgba(255, 182, 217, 0.3);
        }

        .project-emoji {
            font-size: 20px;
            margin-right: 12px;
            min-width: 30px;
            text-align: center;
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-meta {
            font-size: 11px;
            opacity: 0.7;
            display: flex;
            gap: 10px;
        }

        .project-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .project-item:hover .project-actions {
            opacity: 1;
        }

        .project-item.active .project-actions {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .create-project-btn {
            width: 100%;
            background: linear-gradient(45deg, #D4A5FF, #B794F6);
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            color: white;
            font-family: 'Comfortaa', cursive;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .create-project-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 165, 255, 0.4);
        }

        .sidebar-toggle {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            border: none;
            border-radius: 0 15px 15px 0;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 1999;
            box-shadow: 3px 0 15px rgba(255, 182, 217, 0.4);
        }

        .sidebar-toggle:hover {
            background: linear-gradient(45deg, #FF8FA3, #FFB6D9);
            transform: translateY(-50%) translateX(5px);
        }

        .sidebar.open + .sidebar-toggle {
            left: 315px;
            border-radius: 15px 0 0 15px;
        }

        /* Custom Scrollbar for Sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 182, 217, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 182, 217, 0.5);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 182, 217, 0.7);
        }

        /* Project Customization Section */
        .customization-section {
            border-top: 1px solid rgba(255, 182, 217, 0.2);
            padding-top: 20px;
        }

        /* Theme Selector Styles */
        .section-subtitle {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-color, #333);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .theme-btn {
            padding: 8px 12px;
            border: 2px solid var(--accent-color, #FFB6D9);
            background: transparent;
            color: var(--text-color, #333);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .theme-btn:hover {
            background: var(--accent-color, #FFB6D9);
            color: white;
            transform: scale(1.05);
        }

        .theme-btn.active {
            background: var(--accent-color, #FFB6D9);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 182, 217, 0.4);
        }

        .color-section {
            border-top: 1px solid rgba(255, 182, 217, 0.2);
            padding-top: 15px;
        }

        /* Dark Theme Styles */
        body.dark-theme {
            --bg-color: #1a1a1a;
            --surface-color: rgba(40, 40, 40, 0.95);
            --text-color: #e0e0e0;
            --border-color: #404040;
            --accent-color: #bb86fc;
            --project-bg-gradient: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 50%, #16213e 100%);
        }

        body.dark-theme .workspace {
            background: var(--project-bg-gradient);
        }

        body.dark-theme .canvas {
            background: var(--project-bg-gradient);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }

        body.dark-theme .sidebar {
            background: rgba(30, 30, 30, 0.98);
            border-right: 3px solid #bb86fc;
            color: #e0e0e0;
        }

        body.dark-theme .header {
            background: rgba(30, 30, 30, 0.95);
            border-bottom: 2px solid #bb86fc;
            color: #e0e0e0;
        }

        /* Midnight Theme Styles */
        body.midnight-theme {
            --bg-color: #0f0f0f;
            --surface-color: rgba(20, 20, 30, 0.95);
            --text-color: #f0f0f0;
            --border-color: #2a2a3a;
            --accent-color: #64ffda;
            --project-bg-gradient: linear-gradient(135deg, #000428 0%, #004e92 100%);
        }

        body.midnight-theme .workspace {
            background: var(--project-bg-gradient);
        }

        body.midnight-theme .canvas {
            background: var(--project-bg-gradient);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(100, 255, 218, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(100, 255, 218, 0.05) 1px, transparent 1px);
        }

        body.midnight-theme .sidebar {
            background: rgba(15, 15, 25, 0.98);
            border-right: 3px solid #64ffda;
            color: #f0f0f0;
        }

        body.midnight-theme .header {
            background: rgba(15, 15, 25, 0.95);
            border-bottom: 2px solid #64ffda;
            color: #f0f0f0;
        }

        /* Neon Theme Styles */
        body.neon-theme {
            --bg-color: #0a0a0a;
            --surface-color: rgba(15, 15, 25, 0.95);
            --text-color: #ff00ff;
            --border-color: #ff00ff;
            --accent-color: #00ffff;
            --project-bg-gradient: linear-gradient(135deg, #0f0f23 0%, #1a0b2e 50%, #2d1b69 100%);
        }

        body.neon-theme .workspace {
            background: var(--project-bg-gradient);
        }

        body.neon-theme .canvas {
            background: var(--project-bg-gradient);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 0, 255, 0.2) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
        }

        body.neon-theme .sidebar {
            background: rgba(10, 10, 20, 0.98);
            border-right: 3px solid #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }

        body.neon-theme .header {
            background: rgba(10, 10, 20, 0.95);
            border-bottom: 2px solid #00ffff;
            color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        /* Audio & Video Elements */
        .audio-note {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            cursor: grab;
            border: 3px solid #FF8FA3;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .audio-note:hover {
            transform: rotate(0.5deg) scale(1.01);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .audio-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .record-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
        }

        .record-btn.recording {
            animation: pulse 1s infinite;
            background: linear-gradient(45deg, #FF3333, #FF5555);
        }

        .play-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 182, 217, 0.2);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .wave-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to top, #FF8FA3, #FFB6D9);
            border-radius: 1px;
            transition: height 0.1s ease;
        }

        /* Video Elements */
        .video-note {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            overflow: hidden;
            cursor: grab;
            border: 3px solid #FF8FA3;
            transition: all 0.3s ease;
        }

        .video-note:hover {
            transform: rotate(-0.5deg) scale(1.01);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
        }

        .video-note video {
            width: 100%;
            height: calc(100% - 25px);
            object-fit: cover;
            margin-top: 25px;
        }

        .video-note iframe {
            width: 100%;
            height: calc(100% - 25px);
            margin-top: 25px;
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 0 0 12px 12px;
        }

        .video-note:hover .video-controls {
            opacity: 1;
        }

        /* Mini barra de t√≠tulo para videos */
        .video-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: linear-gradient(45deg, #FF8FA3, #FFB6D9);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            font-weight: bold;
            z-index: 10;
            border-radius: 12px 12px 0 0;
        }

        .video-header:active {
            cursor: grabbing;
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
        }

        .video-header .drag-icon {
            font-size: 12px;
            opacity: 0.8;
        }

        .video-header .video-title {
            flex: 1;
            text-align: center;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 5px;
        }

        /* Productivity Dashboard */
        .productivity-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #FFB6D9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 182, 217, 0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Creative Tools */
        .drawing-container {
            position: absolute;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: visible;
        }

        .drawing-canvas {
            display: block;
            border: none;
            border-radius: 0 0 12px 12px;
            background: white;
            cursor: crosshair;
        }

        .drawing-toolbar {
            display: flex;
            gap: 4px;
            background: linear-gradient(135deg, #FFB6D9, #D4A5FF);
            padding: 10px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            position: relative;
            border: 3px solid #A8E6CF;
            border-bottom: none;
            z-index: 1001;
            pointer-events: auto;
        }

        .drawing-toolbar-row {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }

        .drawing-canvas {
            border: 3px solid #A8E6CF;
            border-top: none;
        }

        .drawing-tool {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
            position: relative;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
        }

        .drawing-tool:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .drawing-tool.active {
            background: #A8E6CF;
            color: white;
            box-shadow: 0 0 10px rgba(168, 230, 207, 0.5);
            border-color: #A8E6CF;
        }

        .canvas-close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background: rgba(255, 107, 107, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1000;
        }

        .canvas-close-btn:hover {
            background: #ff3333;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(255, 51, 51, 0.4);
        }

        .drawing-size-display {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            min-width: 35px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .drawing-slider {
            width: 80px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            position: relative;
            z-index: 1000;
        }

        .drawing-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(168, 230, 207, 0.8);
            transition: all 0.2s ease;
        }

        .drawing-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.5);
            border-color: #A8E6CF;
        }

        .drawing-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
        }

        .drawing-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(168, 230, 207, 0.8);
            transition: all 0.2s ease;
        }

        .drawing-slider-container {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            user-select: none;
            pointer-events: all;
        }

        .drawing-color-picker {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            background: none;
            outline: none;
        }

        .drawing-tool-tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .drawing-tool:hover .drawing-tool-tooltip {
            opacity: 1;
        }

        .drawing-color-palette {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            max-width: 140px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .drawing-color-option {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drawing-color-option:hover {
            transform: scale(1.15);
            border-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .drawing-color-option.active {
            border-color: white;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }

        .drawing-separator {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 4px;
        }

        /* Collaboration Elements */
        .collaborator-cursor {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            transition: all 0.1s ease;
        }

        .cursor-pointer {
            width: 0;
            height: 0;
            border-left: 10px solid;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        .cursor-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 15px;
            margin-top: -5px;
        }

        .chat-widget {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 300px;
            height: 400px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 3px solid #FFB6D9;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 2000;
        }

        .chat-header {
            background: linear-gradient(45deg, #FFB6D9, #FF8FA3);
            color: white;
            padding: 15px;
            border-radius: 17px 17px 0 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid rgba(255, 182, 217, 0.2);
            display: flex;
            gap: 10px;
        }

        /* Import/Export Panels */
        .import-drop-zone {
            border: 3px dashed #FFB6D9;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: rgba(255, 182, 217, 0.05);
            transition: all 0.3s ease;
            margin: 15px;
        }

        .import-drop-zone:hover,
        .import-drop-zone.dragover {
            border-color: #FF8FA3;
            background: rgba(255, 182, 217, 0.1);
            transform: scale(1.02);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .export-card {
            background: linear-gradient(45deg, #D4A5FF, #B794F6);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-family: 'Comfortaa', cursive;
        }

        .export-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(212, 165, 255, 0.4);
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .color-option {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: rgba(0, 0, 0, 0.2);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.15);
        }

        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }

        /* Transcription Styles */
        .transcription-note {
            animation: transcriptionPulse 2s infinite;
        }

        .transcription-note textarea {
            background: rgba(76, 175, 80, 0.1) !important;
            color: #2E7D32;
            font-weight: 500;
        }

        .transcription-note .note-emoji {
            animation: microphonePulse 1.5s infinite;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        /* Manual Transcription Note Styles */
        .manual-transcription-note {
            border: 2px solid #FFC107 !important;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3) !important;
        }

        .manual-transcription-note textarea {
            background: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #FFC107 !important;
            color: #F57F17;
            font-weight: 500;
        }

        .manual-transcription-note .note-emoji {
            color: #FF9800;
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
            animation: manualTranscriptionPulse 2s infinite;
        }

        @keyframes manualTranscriptionPulse {
            0%, 100% {
                transform: scale(1);
                color: #FF9800;
            }
            50% {
                transform: scale(1.1);
                color: #FFC107;
            }
        }

        @keyframes transcriptionPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
            }
        }

        @keyframes microphonePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        /* Transcription button states */
        .btn.recording {
            animation: recordButtonPulse 1s infinite;
        }

        @keyframes recordButtonPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 107, 107, 0.7);
            }
        }

        /* Speech recognition indicator */
        .speech-indicator {
            position: fixed;
            top: 100px;
            left: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInLeft 0.3s ease;
        }

        .speech-indicator::before {
            content: 'üé§';
            animation: microphonePulse 1.5s infinite;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Video Recording Styles */
        .video-options .btn.active {
            background: linear-gradient(45deg, #FF6B9D, #FF8FA3);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .camera-container {
            border: 2px dashed #FFB6D9 !important;
            background: #f8f9fa !important;
            border-radius: 15px !important;
            padding: 20px !important;
            margin-bottom: 15px !important;
            min-height: 300px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease;
        }

        .camera-container:hover {
            border-color: #FF8FA3;
            background: rgba(255, 182, 217, 0.1);
        }

        .camera-container video {
            border: 3px solid #FFB6D9;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .camera-container video:hover {
            box-shadow: 0 12px 35px rgba(255, 182, 217, 0.3);
            transform: scale(1.02);
        }

        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .recording-controls .btn {
            min-width: 140px;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .recording-controls .btn:hover {
            transform: translateY(-2px);
        }

        #startRecordBtn.recording {
            animation: recordPulse 1s infinite;
            background: linear-gradient(45deg, #ff3333, #ff5555);
        }

        #stopRecordBtn {
            background: linear-gradient(45deg, #ff6b6b, #ff5252) !important;
        }

        #stopRecordBtn:hover {
            background: linear-gradient(45deg, #ff5252, #ff3333) !important;
            box-shadow: 0 6px 20px rgba(255, 82, 82, 0.6) !important;
        }

        #addRecordedBtn {
            background: linear-gradient(45deg, #4CAF50, #45a049) !important;
            color: white !important;
        }

        #addRecordedBtn:hover {
            background: linear-gradient(45deg, #45a049, #3d8b40) !important;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6) !important;
        }

        #recordingStatus {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 500;
            color: #FF6B9D;
            font-size: 14px;
            padding: 8px 15px;
            background: rgba(255, 182, 217, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 182, 217, 0.3);
            transition: all 0.3s ease;
        }

        #recordingTimer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px 25px;
            border-radius: 25px;
            border: 2px solid rgba(255, 107, 107, 0.3);
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            transition: all 0.3s ease;
        }

        @keyframes recordPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 51, 51, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 51, 51, 0.7);
            }
        }

        @keyframes cameraGlow {
            0%, 100% {
                border-color: #FFB6D9;
                box-shadow: 0 0 10px rgba(255, 182, 217, 0.3);
            }
            50% {
                border-color: #FF8FA3;
                box-shadow: 0 0 20px rgba(255, 143, 163, 0.5);
            }
        }

        .camera-container.recording {
            animation: cameraGlow 2s infinite;
        }

        /* Recording notification styles */
        .recording-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            font-weight: 600;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Camera placeholder improvements */
        #cameraPlaceholder {
            text-align: center;
            color: #666;
            transition: all 0.3s ease;
        }

        #cameraPlaceholder:hover {
            color: #FF6B9D;
            transform: scale(1.05);
        }

        #cameraPlaceholder h3 {
            color: #FF6B9D;
            margin-bottom: 10px;
            font-size: 18px;
        }

        /* Video preview enhancements */
        .camera-container video {
            object-fit: cover;
            background: linear-gradient(45deg, #000, #222);
        }

        /* Responsive video recording */
        @media (max-width: 768px) {
            .video-options .btn {
                padding: 10px 15px;
                font-size: 12px;
            }
            
            .camera-container {
                min-height: 250px !important;
                padding: 15px !important;
            }
            
            .camera-container video {
                max-width: 100% !important;
                height: 200px !important;
            }
            
            .recording-controls .btn {
                min-width: 120px;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            #recordingTimer {
                font-size: 20px;
                padding: 12px 20px;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            
            .toolbar {
                gap: 10px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .sticky-note {
                width: 150px;
                min-height: 120px;
                padding: 10px;
            }
            
            /* Loading screen responsive */
            .loading-cat {
                transform: scale(0.8);
            }
            
            .loading-text {
                font-size: 24px;
            }
            
            .loading-bar-container {
                width: 250px;
            }
            
            .loading-tips {
                font-size: 11px;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <!-- Constellation Canvas -->
        <canvas id="loading-constellation-canvas"></canvas>
        
        <!-- Paw prints background -->
        <div class="paw-prints" id="pawPrints"></div>
        
        <!-- Main loading cat with orbiting elements -->
        <div class="loading-cat">
            <div class="cat-decoration orbit1">üåü</div>
            <div class="cat-decoration orbit2">üíï</div>
            <div class="cat-decoration orbit3">üéà</div>
            <div class="cat-decoration orbit4">ü¶Ñ</div>
            
            <div class="cat-body">
                <div class="cat-head">
                    <div class="cat-ear left">
                        <div class="cat-ear-inner"></div>
                    </div>
                    <div class="cat-ear right">
                        <div class="cat-ear-inner"></div>
                    </div>
                    <div class="cat-eye left"></div>
                    <div class="cat-eye right"></div>
                    <div class="cat-nose"></div>
                    <div class="cat-mouth"></div>
                    <div class="cat-whisker left1"></div>
                    <div class="cat-whisker left2"></div>
                    <div class="cat-whisker right1"></div>
                    <div class="cat-whisker right2"></div>
                </div>
                <div class="cat-tail"></div>
                <div class="cat-paw left"></div>
                <div class="cat-paw right"></div>
            </div>
        </div>
        
        <div class="loading-text">üê± Meowboard</div>
        <div class="loading-slogan">"Donde tus palabras cobran vida con magia felina" ‚ú®</div>
        
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        
        <div class="loading-percentage" id="loadingPercentage">0%</div>
        
        <div class="loading-tips" id="loadingTips">
            Preparando tu tablero de palabras adorable...
        </div>
    </div>

    <!-- Workspace Constellation Canvas -->
    <canvas id="workspace-constellation-canvas" style="position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 1; pointer-events: none; opacity: 0.4;"></canvas>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                üóÇÔ∏è Proyectos
            </div>
            <button class="sidebar-close" onclick="toggleSidebar()" title="Cerrar">√ó</button>
        </div>
        
        <div class="sidebar-content">
            <button class="create-project-btn" onclick="createNewProject()">
                <span>‚ú®</span> Nuevo Proyecto
            </button>
            
            <div class="projects-section">
                <div class="section-title">
                    üìÇ Mis Proyectos
                </div>
                <div id="projectsList">
                    <!-- Los proyectos se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
            
            <div class="customization-section">
                <div class="section-title">
                    üé® Personalizaci√≥n
                </div>
                
                <!-- Selector de Tema -->
                <div class="theme-selector" style="margin-bottom: 20px;">
                    <div class="section-subtitle">üåô Tema</div>
                    <div class="theme-options">
                        <button class="theme-btn active" onclick="setTheme('light')" data-theme="light">
                            ‚òÄÔ∏è Claro
                        </button>
                        <button class="theme-btn" onclick="setTheme('dark')" data-theme="dark">
                            üåô Oscuro
                        </button>
                        <button class="theme-btn" onclick="setTheme('midnight')" data-theme="midnight">
                            üåÉ Medianoche
                        </button>
                        <button class="theme-btn" onclick="setTheme('neon')" data-theme="neon">
                            üí´ Ne√≥n
                        </button>
                    </div>
                </div>
                
                <!-- Selector de Colores -->
                <div class="color-section">
                    <div class="section-subtitle">üé® Colores de Acento</div>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option" data-color="#FFB6D9" style="background: #FFB6D9;"></div>
                        <div class="color-option" data-color="#D4A5FF" style="background: #D4A5FF;"></div>
                        <div class="color-option" data-color="#A8E6CF" style="background: #A8E6CF;"></div>
                        <div class="color-option" data-color="#FFE4E6" style="background: #FFE4E6;"></div>
                        <div class="color-option" data-color="#87CEEB" style="background: #87CEEB;"></div>
                        <div class="color-option" data-color="#FFD700" style="background: #FFD700;"></div>
                        <div class="color-option" data-color="#FF8FA3" style="background: #FF8FA3;"></div>
                        <div class="color-option" data-color="#B2F7EF" style="background: #B2F7EF;"></div>
                        <div class="color-option" data-color="#F3FFE3" style="background: #F3FFE3;"></div>
                        <div class="color-option" data-color="#DDA0DD" style="background: #DDA0DD;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Proyectos">
        üóÇÔ∏è
    </button>

    <div class="header">
        <div class="header-main">
            <div style="display: flex; align-items: center;">
                <div class="logo">Meowboard</div>
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchTab('basic')" id="tab-basic">
                        üìù B√°sico
                    </button>
                    <button class="tab-btn" onclick="switchTab('audio')" id="tab-audio">
                        üéµ Audio & Video
                    </button>
                    <button class="tab-btn" onclick="switchTab('creative')" id="tab-creative">
                        üé® Herramientas
                    </button>
                    <button class="tab-btn" onclick="switchTab('collab')" id="tab-collab">
                        üë• Colaboraci√≥n
                    </button>
                    <button class="tab-btn" onclick="switchTab('data')" id="tab-data">
                        üìä Datos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Toolbar Sections -->
        <div class="toolbar-section active" id="toolbar-basic">
            <div class="toolbar">
                <button class="btn" onclick="addStickyNote()">üìù Nota</button>
                <button class="btn btn-secondary" onclick="addTextBlock()">üìÑ Texto</button>
                <button class="btn btn-success" onclick="showImageModal()">üñºÔ∏è Imagen</button>
                <button class="btn" onclick="showLinkModal()">üîó Link</button>
                <button class="btn btn-secondary" onclick="clearCanvas()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-success" onclick="saveBoard()">üíæ Guardar</button>
            </div>
        </div>
        
        <div class="toolbar-section" id="toolbar-audio">
            <div class="toolbar">
                <button class="btn" onclick="addAudioNote()">üé§ Nota de Voz</button>
                <button class="btn btn-secondary" onclick="showVideoModal()">üìπ Video</button>
                <button class="btn btn-success" onclick="showMusicModal()">üéµ M√∫sica</button>
                <button class="btn" onclick="toggleTranscription()">üìù Transcripci√≥n</button>
            </div>
        </div>
        
        <div class="toolbar-section" id="toolbar-creative">
            <div class="toolbar">
                <button class="btn" onclick="addDrawingCanvas()" title="Crear nuevo canvas de dibujo. Puedes crear m√∫ltiples canvas y cada uno tiene su bot√≥n X para eliminarlo.">üé® + Canvas</button>
                <button class="btn btn-secondary" onclick="showDiagramModal()">üìä Diagrama</button>
                <button class="btn btn-success" onclick="showTemplatesModal()">üìã Plantillas</button>
                <button class="btn" onclick="showAssetsModal()">üé® Assets</button>
            </div>
        </div>
        
        <div class="toolbar-section" id="toolbar-collab">
            <div class="toolbar">
                <button class="btn" onclick="shareProject()">üîó Compartir</button>
                <button class="btn btn-secondary" onclick="toggleChat()">üí¨ Chat</button>
                <button class="btn btn-success" onclick="showCollaborators()">üë• Usuarios</button>
                <button class="btn" onclick="showVersionHistory()">üìã Historial</button>
            </div>
        </div>
        
        <div class="toolbar-section" id="toolbar-data">
            <div class="toolbar">
                <button class="btn" onclick="showImportModal()">üì• Importar</button>
                <button class="btn btn-secondary" onclick="showExportModal()">üì§ Exportar</button>
                <button class="btn btn-success" onclick="showStatsModal()">üìä Estad√≠sticas</button>
                <button class="btn" onclick="showBackupModal()">üíæ Backup</button>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div class="canvas" id="canvas"></div>
    </div>

    <button class="fab bounce" onclick="addStickyNote()">+</button>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">-</button>
        <button class="zoom-btn" onclick="resetZoom()">‚åÇ</button>
    </div>

    <!-- Navigation Info -->
    <div class="nav-info" id="navInfo">
        <div class="title">
            üß≠ Navegaci√≥n 
            <button class="nav-close" onclick="toggleNavInfo()" title="Ocultar panel">√ó</button>
        </div>
        <div>Zoom: <span id="zoomInfo">100%</span></div>
        <div>Posici√≥n: <span id="posInfo">(0, 0)</span></div>
        <div style="font-size: 10px; margin-top: 5px; color: #999;">
            üñ±Ô∏è Arrastra para mover<br>
            üéØ Scroll para navegar<br>
            ‚å®Ô∏è Ctrl+Scroll para zoom
        </div>
    </div>

    <!-- Navigation Toggle Button -->
    <button class="nav-toggle" id="navToggle" onclick="toggleNavInfo()" title="Mostrar informaci√≥n de navegaci√≥n">
        üß≠
    </button>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="hideContextMenu(); addStickyNote(contextMenuX, contextMenuY);">
            <span>üìù</span> Agregar Nota
        </div>
        <div class="context-menu-item" onclick="hideContextMenu(); addTextBlock(contextMenuX, contextMenuY);">
            <span>üìÑ</span> Bloque de Texto
        </div>
        <div class="context-menu-item" onclick="hideContextMenu(); showImageModal();">
            <span>üñºÔ∏è</span> Agregar Imagen
        </div>
        <div class="context-menu-item" onclick="hideContextMenu(); showLinkModal();">
            <span>üîó</span> Agregar Link
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üñºÔ∏è Agregar Imagen Adorable</h3>
                <button class="modal-close" onclick="closeModal('imageModal')">√ó</button>
            </div>
            <div class="image-options">
                <div class="form-group">
                    <label>Elige c√≥mo agregar tu imagen:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn" onclick="toggleImageMethod('url')" id="urlBtn">üîó Desde URL</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleImageMethod('file')" id="fileBtn">üìÅ Desde Archivo</button>
                    </div>
                </div>
                
                <!-- URL Method -->
                <div id="urlMethod" style="display: block;">
                    <div class="form-group">
                        <label>URL de la imagen:</label>
                        <input type="url" id="imageUrl" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                </div>
                
                <!-- File Method -->
                <div id="fileMethod" style="display: none;">
                    <div class="form-group">
                        <label>Seleccionar archivo:</label>
                        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(this)">
                        <div id="imagePreview" style="margin-top: 10px; text-align: center;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ancho (px):</label>
                    <input type="number" id="imageWidth" value="200" min="50" max="500">
                </div>
                <div class="form-group">
                    <label>Alto (px):</label>
                    <input type="number" id="imageHeight" value="200" min="50" max="500">
                </div>
                <button type="button" class="btn" onclick="addImageFromModal()">üê± Agregar Imagen</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üîó Agregar Link Cute</h3>
                <button class="modal-close" onclick="closeModal('linkModal')">√ó</button>
            </div>
            <form onsubmit="addLink(event)">
                <div class="form-group">
                    <label>URL:</label>
                    <input type="url" id="linkUrl" placeholder="https://ejemplo.com" required>
                </div>
                <div class="form-group">
                    <label>T√≠tulo:</label>
                    <input type="text" id="linkTitle" placeholder="T√≠tulo del enlace" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <textarea id="linkDescription" placeholder="Descripci√≥n opcional" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">üê± Agregar Link</button>
            </form>
        </div>
    </div>

    <!-- Image Viewer -->
    <div class="image-viewer" id="imageViewer">
        <div class="image-viewer-controls">
            <button class="viewer-btn" onclick="imageViewerZoom(1.2)" title="Acercar">+</button>
            <button class="viewer-btn" onclick="imageViewerZoom(0.8)" title="Alejar">-</button>
            <button class="viewer-btn" onclick="resetImageViewer()" title="Tama√±o original">‚åÇ</button>
            <button class="viewer-btn" onclick="closeImageViewer()" title="Cerrar">√ó</button>
        </div>
        <div class="image-viewer-content" id="imageViewerContent">
            <img id="viewerImage" src="" alt="Vista ampliada">
        </div>
        <div class="image-viewer-info" id="imageViewerInfo">
            üê± Arrastra para mover ‚Ä¢ Scroll para zoom ‚Ä¢ ESC para cerrar
        </div>
    </div>

    <!-- Video Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">üìπ Agregar Video</h3>
                <button class="modal-close" onclick="closeModal('videoModal')">√ó</button>
            </div>
            
            <!-- Video Options -->
            <div class="video-options">
                <div class="form-group">
                    <label>Elige c√≥mo agregar tu video:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn" onclick="toggleVideoMethod('url')" id="videoUrlBtn">üîó Desde URL</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleVideoMethod('record')" id="videoRecordBtn">üé• Grabar Video</button>
                    </div>
                </div>
                
                <!-- URL Method -->
                <div id="urlVideoMethod" style="display: block;">
                    <form onsubmit="addVideoFromModal(event)">
                        <div class="form-group">
                            <label>URL del Video (YouTube, Vimeo, etc.)</label>
                            <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                        <div class="form-group">
                            <label>Ancho</label>
                            <input type="number" id="videoWidth" value="400" min="200" max="800">
                        </div>
                        <div class="form-group">
                            <label>Alto</label>
                            <input type="number" id="videoHeight" value="300" min="150" max="600">
                        </div>
                        <button type="submit" class="btn btn-success">üìπ Agregar Video</button>
                    </form>
                </div>
                
                <!-- Record Method -->
                <div id="recordVideoMethod" style="display: none;">
                    <div class="camera-container" style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 15px; min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed #FFB6D9;">
                        <!-- Camera Preview -->
                        <video id="cameraPreview" autoplay muted playsinline style="width: 100%; max-width: 400px; height: 300px; border-radius: 10px; background: #000; display: none; object-fit: cover;"></video>
                        
                        <!-- Recorded Video Preview -->
                        <video id="recordedPreview" controls style="width: 100%; max-width: 400px; height: 300px; border-radius: 10px; background: #000; display: none; object-fit: cover;"></video>
                        
                        <!-- Default State -->
                        <div id="cameraPlaceholder" style="text-align: center; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üé•</div>
                            <h3 style="margin-bottom: 10px; color: #FF6B9D;">¬°Graba tu video aqu√≠!</h3>
                            <p style="margin-bottom: 20px;">Haz clic en "Activar C√°mara" para comenzar</p>
                        </div>
                    </div>
                    
                    <!-- Recording Controls -->
                    <div class="recording-controls" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="startCamera()" id="startCameraBtn">üìπ Activar C√°mara</button>
                        <button type="button" class="btn btn-secondary" onclick="startRecording()" id="startRecordBtn" style="display: none;">‚è∫Ô∏è Grabar</button>
                        <button type="button" class="btn" onclick="stopRecording()" id="stopRecordBtn" style="display: none; background: #ff6b6b;">‚èπÔ∏è Parar</button>
                        <button type="button" class="btn btn-secondary" onclick="retryRecording()" id="retryBtn" style="display: none;">üîÑ Reintentar</button>
                        <button type="button" class="btn btn-success" onclick="addRecordedVideoToBoard()" id="addRecordedBtn" style="display: none;">‚ú® Agregar al Tablero</button>
                    </div>
                    
                    <!-- Recording Status -->
                    <div id="recordingStatus" style="text-align: center; margin-bottom: 15px; font-weight: 500; color: #FF6B9D;">
                        Listo para grabar
                    </div>
                    
                    <!-- Recording Timer -->
                    <div id="recordingTimer" style="text-align: center; font-size: 18px; font-weight: bold; color: #ff6b6b; display: none;">
                        00:00
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Music Modal -->
    <div class="modal" id="musicModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üéµ M√∫sica de Fondo</h3>
                <button class="modal-close" onclick="closeModal('musicModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>Selecciona ambiente:</label>
                <select id="musicAmbient" onchange="playAmbient(this.value)">
                    <option value="">Sin m√∫sica</option>
                    <option value="rain">üåßÔ∏è Lluvia relajante</option>
                    <option value="forest">üå≤ Bosque</option>
                    <option value="ocean">üåä Oc√©ano</option>
                    <option value="cafe">‚òï Caf√©</option>
                    <option value="lo-fi">üéµ Lo-fi</option>
                </select>
            </div>
            <div class="form-group">
                <label>Volumen:</label>
                <input type="range" id="musicVolume" min="0" max="100" value="30" onchange="setMusicVolume(this.value)">
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div class="modal" id="templatesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">üìã Plantillas Inteligentes</h3>
                <button class="modal-close" onclick="closeModal('templatesModal')">√ó</button>
            </div>
            <div class="export-options">
                <button class="export-card" onclick="loadTemplate('brainstorm')">
                    üß† Brainstorming
                </button>
                <button class="export-card" onclick="loadTemplate('project')">
                    üìã Gesti√≥n de Proyecto
                </button>
                <button class="export-card" onclick="loadTemplate('mindmap')">
                    üó∫Ô∏è Mapa Mental
                </button>
                <button class="export-card" onclick="loadTemplate('timeline')">
                    ‚è∞ L√≠nea de Tiempo
                </button>
                <button class="export-card" onclick="loadTemplate('storyboard')">
                    üé¨ Storyboard
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">üìä Estad√≠sticas de Productividad</h3>
                <button class="modal-close" onclick="closeModal('statsModal')">√ó</button>
            </div>
            <div class="productivity-panel">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalElements">0</div>
                        <div class="stat-label">Elementos Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProjects">0</div>
                        <div class="stat-label">Proyectos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="timeSpent">0h</div>
                        <div class="stat-label">Tiempo de Trabajo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="productivity">85%</div>
                        <div class="stat-label">Productividad</div>
                    </div>
                </div>
                <canvas id="productivityChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì• Importar Datos</h3>
                <button class="modal-close" onclick="closeModal('importModal')">√ó</button>
            </div>
            <div class="import-drop-zone" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                <h3>Arrastra archivos aqu√≠</h3>
                <p>Soportamos: PDF, Word, Excel, JSON, Milanote, Notion, Figma</p>
                <input type="file" id="importFile" style="display: none;" onchange="handleFileSelect(event)" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.json,.fig">
                <button class="btn" onclick="document.getElementById('importFile').click()">Seleccionar Archivos</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Exportar Proyecto</h3>
                <button class="modal-close" onclick="closeModal('exportModal')">√ó</button>
            </div>
            <div class="export-options">
                <button class="export-card" onclick="exportAs('pdf')">
                    üìÑ PDF Interactivo
                </button>
                <button class="export-card" onclick="exportAs('html')">
                    üåê Sitio Web
                </button>
                <button class="export-card" onclick="exportAs('pptx')">
                    üìä PowerPoint
                </button>
                <button class="export-card" onclick="exportAs('json')">
                    üíæ JSON Backup
                </button>
                <button class="export-card" onclick="exportAs('png')">
                    üñºÔ∏è Imagen PNG
                </button>
                <button class="export-card" onclick="exportAs('figma')">
                    üé® Figma
                </button>
            </div>
        </div>
    </div>

    <!-- Diagrams Modal -->
    <div class="modal" id="diagramModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">üìä Editor de Diagramas</h3>
                <button class="modal-close" onclick="closeModal('diagramModal')">√ó</button>
            </div>
            <div class="diagram-types" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button class="export-card" onclick="selectDiagramType('pie')" id="pieBtn">
                    ü•ß Gr√°fico de Pastel
                </button>
                <button class="export-card" onclick="selectDiagramType('bar')" id="barBtn">
                    üìä Gr√°fico de Barras
                </button>
                <button class="export-card" onclick="selectDiagramType('line')" id="lineBtn">
                    üìà Gr√°fico de L√≠neas
                </button>
                <button class="export-card" onclick="selectDiagramType('doughnut')" id="doughnutBtn">
                    üç© Gr√°fico de Dona
                </button>
            </div>
            
            <div id="diagramEditor" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>üìù Datos del Diagrama</h4>
                        <div class="form-group">
                            <label>T√≠tulo:</label>
                            <input type="text" id="diagramTitle" placeholder="Mi Diagrama" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        </div>
                        
                        <div id="dataInputs">
                            <div class="data-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="text" placeholder="Etiqueta" class="data-label" style="flex: 1; padding: 8px;">
                                <input type="number" placeholder="Valor" class="data-value" style="flex: 1; padding: 8px;" min="0">
                                <input type="color" class="data-color" style="width: 40px; height: 40px; border: none; border-radius: 5px;">
                                <button onclick="removeDataRow(this)" style="padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">√ó</button>
                            </div>
                            <div class="data-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="text" placeholder="Etiqueta" class="data-label" style="flex: 1; padding: 8px;">
                                <input type="number" placeholder="Valor" class="data-value" style="flex: 1; padding: 8px;" min="0">
                                <input type="color" class="data-color" style="width: 40px; height: 40px; border: none; border-radius: 5px;">
                                <button onclick="removeDataRow(this)" style="padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">√ó</button>
                            </div>
                            <div class="data-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="text" placeholder="Etiqueta" class="data-label" style="flex: 1; padding: 8px;">
                                <input type="number" placeholder="Valor" class="data-value" style="flex: 1; padding: 8px;" min="0">
                                <input type="color" class="data-color" style="width: 40px; height: 40px; border: none; border-radius: 5px;">
                                <button onclick="removeDataRow(this)" style="padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">√ó</button>
                            </div>
                        </div>
                        
                        <button onclick="addDataRow()" class="btn" style="width: 100%; margin-bottom: 15px;">+ Agregar Dato</button>
                        <button onclick="updateDiagramPreview()" class="btn btn-primary" style="width: 100%;">üîÑ Actualizar Vista Previa</button>
                    </div>
                    
                    <div>
                        <h4>üëÅÔ∏è Vista Previa</h4>
                        <div id="diagramPreview" style="background: white; border: 1px solid #ddd; border-radius: 10px; padding: 20px; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="previewCanvas" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="addDiagramToCanvas()" class="btn btn-success" style="padding: 12px 24px; font-size: 16px;">
                        ‚ú® Agregar al Canvas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collaboration Chat -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-header">
            <span>üí¨ Chat del Proyecto</span>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 18px;">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; color: #999; padding: 20px;">
                ¬°Inicia una conversaci√≥n! üê±
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Escribe un mensaje..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 15px;">
            <button onclick="sendChatMessage()" class="btn" style="padding: 8px 12px;">üì§</button>
        </div>
    </div>

    <script>
        // Variables globales
        let isDragging = false;
        let currentElement = null;
        let startX, startY, initialX, initialY;
        let zoomLevel = 1;
        let panX = 0, panY = 0;
        let isPanning = false;
        let contextMenuX = 0, contextMenuY = 0;

        // Variables del visor de im√°genes
        let imageViewerZoomLevel = 1;
        let imageViewerPanX = 0, imageViewerPanY = 0;
        let isImageViewerDragging = false;
        let imageViewerStartX = 0, imageViewerStartY = 0;

        // Variables de la pantalla de carga
        let loadingProgress = 0;
        let loadingInterval;
        let pawPrintInterval;

        // Variables del sistema de proyectos
        let projects = [];
        let currentProject = null;
        let projectIdCounter = 1;
        
        // Variables de autoguardado
        let autoSaveTimeout = null;
        let isAutoSaveEnabled = true;

        // Variables de audio y video
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let backgroundMusic = null;
        let musicVolume = 0.3;

        // Variables de grabaci√≥n de video
        let videoMediaRecorder = null;
        let videoChunks = [];
        let isVideoRecording = false;
        let videoStream = null;
        let recordedVideoBlob = null;
        let recordingStartTime = null;
        let recordingTimer = null;

        // Variables de transcripci√≥n de voz
        let speechRecognition = null;
        let isTranscribing = false;
        let transcriptionResult = '';
        let currentTranscriptionNote = null;
        let transcriptionTimeout = null;
        
        // Detecci√≥n de capacidades del navegador para transcripci√≥n
        const browserCapabilities = {
            hasWebSpeech: ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window),
            isChrome: /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor),
            isFirefox: navigator.userAgent.indexOf("Firefox") > -1,
            isOpera: !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0,
            isSafari: /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor),
            isEdge: navigator.userAgent.indexOf("Edg") > -1,
            hasMediaDevices: navigator.mediaDevices && navigator.mediaDevices.getUserMedia,
            supportsAudioRecording: typeof MediaRecorder !== 'undefined'
        };

        // Variables de colaboraci√≥n
        let collaborators = [];
        let chatMessages = [];
        let isOnline = navigator.onLine;
        let lastActivity = Date.now();

        // Variables de productividad
        let sessionStartTime = Date.now();
        let totalWorkTime = 0;
        let actionsCount = 0;
        let productivityStats = {
            elementsCreated: 0,
            timeSpent: 0,
            projectsWorked: 0
        };

        // Variables de dibujo avanzadas
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#FF6B9D';
        let currentSize = 3;
        let drawingContext = null;
        let drawingStartX, drawingStartY;
        let tempCanvasData = null;
        let drawingHistory = [];
        let historyIndex = -1;

        // Paleta de colores predefinidos
        const colorPalette = [
            '#FF6B9D', '#FF8FA3', '#FFB6D9', '#D4A5FF', 
            '#A8E6CF', '#87CEEB', '#98FB98', '#F0E68C',
            '#FF6347', '#FFA500', '#FFD700', '#ADFF2F',
            '#00CED1', '#4169E1', '#9932CC', '#DC143C',
            '#000000', '#404040', '#808080', '#C0C0C0', '#FFFFFF'
        ];

        // Elementos del DOM
        const canvas = document.getElementById('canvas');
        const contextMenu = document.getElementById('contextMenu');

        // Configurar drag & drop para assets en el canvas
        canvas.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        canvas.addEventListener('drop', function(e) {
            e.preventDefault();
            const asset = e.dataTransfer.getData('text/plain');
            if (asset) {
                const rect = canvas.getBoundingClientRect();
                const assetElement = document.createElement('div');
                assetElement.className = 'asset-element';
                assetElement.style.cssText = `
                    position: absolute;
                    left: ${e.clientX - rect.left - 24}px;
                    top: ${e.clientY - rect.top - 24}px;
                    font-size: 48px;
                    cursor: move;
                    user-select: none;
                    z-index: 1000;
                    transition: transform 0.2s;
                `;
                assetElement.textContent = asset;
                assetElement.title = `Asset: ${asset} (Doble clic para editar tama√±o)`;
                
                makeDraggable(assetElement);
                
                // Doble clic para cambiar tama√±o
                assetElement.addEventListener('dblclick', function() {
                    const currentSize = parseInt(this.style.fontSize) || 48;
                    const sizes = [24, 32, 48, 64, 96, 128];
                    const currentIndex = sizes.indexOf(currentSize);
                    const nextIndex = (currentIndex + 1) % sizes.length;
                    this.style.fontSize = sizes[nextIndex] + 'px';
                    showNotificationMessage(`üìè Tama√±o cambiado a ${sizes[nextIndex]}px`, 'info');
                });
                
                // Clic derecho para opciones
                assetElement.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showAssetContextMenu(e, assetElement);
                });
                
                canvas.appendChild(assetElement);
                assetElement.classList.add('wiggle');
                showNotificationMessage(`‚ú® Asset "${asset}" agregado por drag & drop`, 'success');
            }
        });

        // Cargar favoritos guardados al inicializar
        document.addEventListener('DOMContentLoaded', function() {
            const savedFavorites = localStorage.getItem('meowboard_favorite_assets');
            if (savedFavorites) {
                try {
                    assetsData.favorites = JSON.parse(savedFavorites);
                } catch (e) {
                    console.log('Error al cargar favoritos:', e);
                }
            }
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar pantalla de carga
            startLoadingScreen();
            
            // Iniciar constelaciones del workspace
            initWorkspaceConstellation();
            
            // Cargar la aplicaci√≥n en segundo plano
            setTimeout(() => {
                // Inicializar sistema de proyectos primero
                initProjectsSystem();
                setupEventListeners();
                setupAutoSave();
                loadNavigationState();
                
                // Cargar tema guardado (debe ir despu√©s de initProjectsSystem)
                loadSavedTheme();
                
                // Inicializar nuevas funcionalidades
                initializeAdvancedFeatures();
                
                // Mostrar notificaci√≥n de autoguardado activado
                setTimeout(() => {
                    showNotificationMessage('üîÑ Sistema de autoguardado activado - Todo se guarda autom√°ticamente', 'success');
                }, 1000);
                
                // Mostrar mensaje de bienvenida despu√©s de que termine la carga
                setTimeout(() => {
                    if (projects.length === 1 && (!currentProject.data || !currentProject.data.elements || currentProject.data.elements.length === 0)) {
                        showWelcomeMessage();
                    }
                }, 1500);
            }, 500);
        });

        function setupAutoSave() {
            // Configurar MutationObserver para detectar cambios en el canvas
            const observer = new MutationObserver(function(mutations) {
                let shouldAutoSave = false;
                
                mutations.forEach(function(mutation) {
                    // Detectar cambios en elementos, atributos o contenido
                    if (mutation.type === 'childList' && mutation.target === canvas) {
                        // Elemento agregado o eliminado del canvas
                        shouldAutoSave = true;
                    } else if (mutation.type === 'attributes' && 
                               mutation.target.closest('#canvas') && 
                               (mutation.attributeName === 'style' || 
                                mutation.attributeName === 'class')) {
                        // Cambios en estilo (posici√≥n, tama√±o) de elementos del canvas
                        shouldAutoSave = true;
                    } else if (mutation.type === 'characterData' && 
                               mutation.target.closest('#canvas')) {
                        // Cambios en el contenido de texto
                        shouldAutoSave = true;
                    }
                });
                
                if (shouldAutoSave) {
                    autoSave();
                }
            });
            
            // Configurar el observer para detectar cambios en el canvas y sus hijos
            observer.observe(canvas, {
                childList: true,        // Detectar elementos agregados/eliminados
                subtree: true,          // Incluir todos los descendientes
                attributes: true,       // Detectar cambios en atributos
                attributeFilter: ['style', 'class', 'data-*'], // Solo atributos relevantes
                characterData: true,    // Detectar cambios en texto
                characterDataOldValue: false
            });
            
            // Tambi√©n observar cambios en canvas de dibujo (para detectar nuevos canvas)
            const canvasObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.classList) {
                                if (node.classList.contains('drawing-container') ||
                                    node.classList.contains('audio-note') ||
                                    node.classList.contains('video-note')) {
                                    // Nuevo elemento multimedia agregado
                                    autoSave();
                                }
                            }
                        });
                    }
                });
            });
            
            canvasObserver.observe(canvas, {
                childList: true,
                subtree: false
            });
            
            console.log('üîÑ Sistema de autoguardado autom√°tico activado - Todos los cambios se guardar√°n autom√°ticamente');
        }

        function setupEventListeners() {
            // Pan del canvas
            const workspace = document.querySelector('.workspace');
            workspace.addEventListener('mousedown', startPan);
            document.addEventListener('mousemove', pan);
            document.addEventListener('mouseup', stopPan);

            // Scroll para zoom en el canvas
            workspace.addEventListener('wheel', handleCanvasWheel);

            // Context menu
            canvas.addEventListener('contextmenu', showContextMenu);
            document.addEventListener('click', hideContextMenu);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);
            
            // Prevenir scroll de p√°gina cuando est√° sobre el workspace
            workspace.addEventListener('wheel', function(e) {
                e.preventDefault();
            });
        }

        function handleCanvasWheel(e) {
            e.preventDefault();
            
            if (e.ctrlKey || e.metaKey) {
                // Zoom con Ctrl + scroll
                const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
                zoomLevel = Math.max(0.2, Math.min(3, zoomLevel * zoomFactor));
                updateCanvasTransform();
            } else {
                // Pan con scroll normal
                const panSpeed = 50;
                if (e.shiftKey) {
                    // Pan horizontal con Shift + scroll
                    panX -= e.deltaY > 0 ? panSpeed : -panSpeed;
                } else {
                    // Pan vertical con scroll
                    panY -= e.deltaY > 0 ? panSpeed : -panSpeed;
                }
                
                // Aplicar l√≠mites
                const maxPanX = 500;
                const maxPanY = 500;
                const minPanX = -(canvas.offsetWidth - window.innerWidth + 500);
                const minPanY = -(canvas.offsetHeight - window.innerHeight + 500);
                
                panX = Math.max(minPanX, Math.min(maxPanX, panX));
                panY = Math.max(minPanY, Math.min(maxPanY, panY));
                
                updateCanvasTransform();
            }
        }

        function showWelcomeMessage() {
            setTimeout(() => {
                const centerX = canvas.offsetWidth / 2 - 100;
                const centerY = canvas.offsetHeight / 2 - 75;
                addStickyNote(centerX, centerY, '¬°Bienvenido a Meowboard! üê±\n\nArrastra el fondo para moverte\nScroll para navegar\nCtrl+Scroll para zoom\n¬°Divi√©rtete escribiendo!');
            }, 500);
        }

        // Funciones de sticky notes
        function addStickyNote(x = null, y = null, text = '') {
            const colors = ['yellow', 'pink', 'blue', 'green', 'purple'];
            const emojis = ['üê±', 'üêæ', 'üíï', 'üå∏', '‚ú®', 'üéÄ', 'ü¶Ñ', 'üçì'];
            
            const note = document.createElement('div');
            note.className = `sticky-note ${colors[Math.floor(Math.random() * colors.length)]}`;
            
            // Posicionamiento mejorado - considerar el viewport actual del canvas
            if (x !== null && y !== null) {
                // Posici√≥n espec√≠fica (desde context menu)
                note.style.left = x + 'px';
                note.style.top = y + 'px';
            } else {
                // Posici√≥n aleatoria en el viewport actual
                const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
                const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
                
                note.style.left = (viewportCenterX - 100 + Math.random() * 200) + 'px';
                note.style.top = (viewportCenterY - 75 + Math.random() * 150) + 'px';
            }
            
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            note.innerHTML = `
                <div class="note-header">
                    <span class="note-emoji" onclick="changeEmoji(this)">${randomEmoji}</span>
                </div>
                <textarea placeholder="Escribe tu idea aqu√≠...">${text}</textarea>
                <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
            `;
            
            canvas.appendChild(note);
            makeDraggable(note);
            note.classList.add('wiggle');
            
            // Auto-save cuando se escribe
            const textarea = note.querySelector('textarea');
            textarea.addEventListener('input', autoSave);
            
            // Asegurar que las teclas de borrado funcionen en textarea
            textarea.addEventListener('keydown', function(e) {
                // Permitir teclas de borrado y navegaci√≥n
                if (e.key === 'Backspace' || e.key === 'Delete' || 
                    e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                    e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
                    e.key === 'Home' || e.key === 'End') {
                    // No hacer preventDefault() - dejar que el navegador maneje estas teclas
                    e.stopPropagation(); // Evitar que llegue a handleKeyboard
                }
            });
            
            return note;
        }

        function changeEmoji(element) {
            const emojis = ['üê±', 'üêæ', 'üíï', 'üå∏', '‚ú®', 'üéÄ', 'ü¶Ñ', 'üçì', 'üåü', 'üç∞', 'üéÇ', 'üßÅ'];
            const currentEmoji = element.textContent;
            let nextIndex = emojis.indexOf(currentEmoji) + 1;
            if (nextIndex >= emojis.length) nextIndex = 0;
            element.textContent = emojis[nextIndex];
            autoSave();
        }

        // Funciones de bloques de texto
        function addTextBlock(x = null, y = null) {
            const titles = ['üí≠ Idea Brillante', 'üåü Inspiraci√≥n', 'üìù Nota Importante', 'üí° Eureka!', 'üéØ Objetivo'];
            const placeholders = [
                'Aqu√≠ va tu texto s√∫per importante...',
                'Escribe algo adorable aqu√≠...',
                'Tu idea genial merece estar aqu√≠...',
                '¬°Comparte tu creatividad!'
            ];
            
            const textBlock = document.createElement('div');
            textBlock.className = 'text-block';
            
            // Posicionamiento mejorado - considerar el viewport actual del canvas
            if (x !== null && y !== null) {
                // Posici√≥n espec√≠fica (desde context menu)
                textBlock.style.left = x + 'px';
                textBlock.style.top = y + 'px';
            } else {
                // Posici√≥n aleatoria en el viewport actual
                const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
                const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
                
                textBlock.style.left = (viewportCenterX - 125 + Math.random() * 250) + 'px';
                textBlock.style.top = (viewportCenterY - 50 + Math.random() * 100) + 'px';
            }
            
            const randomTitle = titles[Math.floor(Math.random() * titles.length)];
            const randomPlaceholder = placeholders[Math.floor(Math.random() * placeholders.length)];
            
            textBlock.innerHTML = `
                <h3 contenteditable="true">${randomTitle}</h3>
                <p contenteditable="true">${randomPlaceholder}</p>
                <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
            `;
            
            canvas.appendChild(textBlock);
            makeDraggable(textBlock);
            textBlock.classList.add('wiggle');
            
            // Auto-save cuando se edita
            textBlock.addEventListener('input', autoSave);
            
            // Asegurar que las teclas de borrado funcionen en elementos editables
            const editableElements = textBlock.querySelectorAll('[contenteditable="true"]');
            editableElements.forEach(element => {
                element.addEventListener('keydown', function(e) {
                    // Permitir teclas de borrado y navegaci√≥n
                    if (e.key === 'Backspace' || e.key === 'Delete' || 
                        e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                        e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
                        e.key === 'Home' || e.key === 'End') {
                        // No hacer preventDefault() - dejar que el navegador maneje estas teclas
                        e.stopPropagation(); // Evitar que llegue a handleKeyboard
                    }
                });
            });
            
            return textBlock;
        }

        // Funciones de im√°genes
        function showImageModal() {
            document.getElementById('imageModal').style.display = 'flex';
            // Reset to URL method by default
            toggleImageMethod('url');
        }

        function toggleImageMethod(method) {
            const urlMethod = document.getElementById('urlMethod');
            const fileMethod = document.getElementById('fileMethod');
            const urlBtn = document.getElementById('urlBtn');
            const fileBtn = document.getElementById('fileBtn');
            
            if (method === 'url') {
                urlMethod.style.display = 'block';
                fileMethod.style.display = 'none';
                urlBtn.classList.remove('btn-secondary');
                urlBtn.classList.add('btn');
                fileBtn.classList.remove('btn');
                fileBtn.classList.add('btn-secondary');
            } else {
                urlMethod.style.display = 'none';
                fileMethod.style.display = 'block';
                fileBtn.classList.remove('btn-secondary');
                fileBtn.classList.add('btn');
                urlBtn.classList.remove('btn');
                urlBtn.classList.add('btn-secondary');
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 2px solid #FFB6D9;">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }

        function addImageFromModal() {
            const width = document.getElementById('imageWidth').value;
            const height = document.getElementById('imageHeight').value;
            const urlMethod = document.getElementById('urlMethod').style.display !== 'none';
            
            let imageSrc = '';
            
            if (urlMethod) {
                const url = document.getElementById('imageUrl').value;
                if (!url) {
                    alert('Por favor ingresa una URL v√°lida üê±');
                    return;
                }
                imageSrc = url;
            } else {
                const fileInput = document.getElementById('imageFile');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Por favor selecciona un archivo üê±');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    createImageCard(e.target.result, width, height);
                };
                reader.readAsDataURL(file);
                return; // Exit here since we're using async file reading
            }
            
            createImageCard(imageSrc, width, height);
        }

        function createImageCard(src, width, height) {
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            
            // Posicionamiento en el viewport actual
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            imageCard.style.left = (viewportCenterX - parseInt(width)/2 + Math.random() * 200 - 100) + 'px';
            imageCard.style.top = (viewportCenterY - parseInt(height)/2 + Math.random() * 200 - 100) + 'px';
            imageCard.style.width = width + 'px';
            imageCard.style.height = height + 'px';
            
            imageCard.innerHTML = `
                <div class="image-header">
                    <span class="drag-icon">‚ãÆ‚ãÆ</span>
                    <span class="image-title">üñºÔ∏è Imagen</span>
                    <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                </div>
                <img src="${src}" alt="Imagen cute" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZiNmQ5Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+üòø Error al cargar</dGV4dD48L3N2Zz4='">
            `;
            
            // Manejar clic directamente en la imagen para abrirla
            const img = imageCard.querySelector('img');
            img.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openImageViewer(this.src);
            });
            
            canvas.appendChild(imageCard);
            makeDraggable(imageCard);
            imageCard.classList.add('wiggle');
            
            closeModal('imageModal');
            autoSave();
            
            // Reset form
            resetImageModal();
        }

        function resetImageModal() {
            document.getElementById('imageUrl').value = '';
            document.getElementById('imageFile').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageWidth').value = '200';
            document.getElementById('imageHeight').value = '200';
        }

        // Funciones del visor de im√°genes
        function openImageViewer(imageSrc) {
            const imageViewer = document.getElementById('imageViewer');
            const viewerImage = document.getElementById('viewerImage');
            const imageViewerContent = document.getElementById('imageViewerContent');
            
            viewerImage.src = imageSrc;
            imageViewer.style.display = 'flex';
            
            // Reset zoom y posici√≥n
            imageViewerZoomLevel = 1;
            imageViewerPanX = 0;
            imageViewerPanY = 0;
            updateImageViewerTransform();
            
            // Agregar event listeners
            imageViewer.addEventListener('mousedown', startImageViewerDrag);
            imageViewer.addEventListener('wheel', handleImageViewerWheel);
            
            // Animaci√≥n de entrada
            setTimeout(() => {
                imageViewerContent.style.transform = 'scale(1)';
            }, 50);
        }

        function closeImageViewer() {
            const imageViewer = document.getElementById('imageViewer');
            const imageViewerContent = document.getElementById('imageViewerContent');
            
            // Animaci√≥n de salida
            imageViewerContent.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                imageViewer.style.display = 'none';
                
                // Remover event listeners
                imageViewer.removeEventListener('mousedown', startImageViewerDrag);
                imageViewer.removeEventListener('wheel', handleImageViewerWheel);
            }, 200);
        }

        function imageViewerZoom(factor) {
            imageViewerZoomLevel = Math.max(0.1, Math.min(5, imageViewerZoomLevel * factor));
            updateImageViewerTransform();
        }

        function resetImageViewer() {
            imageViewerZoomLevel = 1;
            imageViewerPanX = 0;
            imageViewerPanY = 0;
            updateImageViewerTransform();
        }

        function updateImageViewerTransform() {
            const imageViewerContent = document.getElementById('imageViewerContent');
            imageViewerContent.style.transform = `translate(${imageViewerPanX}px, ${imageViewerPanY}px) scale(${imageViewerZoomLevel})`;
        }

        function startImageViewerDrag(e) {
            if (e.target.classList.contains('viewer-btn')) return;
            
            isImageViewerDragging = true;
            imageViewerStartX = e.clientX - imageViewerPanX;
            imageViewerStartY = e.clientY - imageViewerPanY;
            
            document.addEventListener('mousemove', handleImageViewerDrag);
            document.addEventListener('mouseup', stopImageViewerDrag);
            e.preventDefault();
        }

        function handleImageViewerDrag(e) {
            if (!isImageViewerDragging) return;
            
            imageViewerPanX = e.clientX - imageViewerStartX;
            imageViewerPanY = e.clientY - imageViewerStartY;
            updateImageViewerTransform();
        }

        function stopImageViewerDrag() {
            isImageViewerDragging = false;
            document.removeEventListener('mousemove', handleImageViewerDrag);
            document.removeEventListener('mouseup', stopImageViewerDrag);
        }

        function handleImageViewerWheel(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
            imageViewerZoom(zoomFactor);
        }

        // Funciones de links
        function showLinkModal() {
            document.getElementById('linkModal').style.display = 'flex';
        }

        function addLink(event) {
            event.preventDefault();
            
            const url = document.getElementById('linkUrl').value;
            const title = document.getElementById('linkTitle').value;
            const description = document.getElementById('linkDescription').value;
            
            const linkCard = document.createElement('div');
            linkCard.className = 'link-card';
            
            // Posicionamiento en el viewport actual
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            linkCard.style.left = (viewportCenterX - 150 + Math.random() * 300) + 'px';
            linkCard.style.top = (viewportCenterY - 40 + Math.random() * 80) + 'px';
            
            linkCard.innerHTML = `
                <div class="link-preview">
                    <div class="link-icon">üîó</div>
                    <div class="link-info">
                        <h4>${title}</h4>
                        <p>${description || url}</p>
                    </div>
                </div>
                <button class="note-close" onclick="removeElement(this.parentElement)" style="position: absolute; top: 10px; right: 10px;">√ó</button>
            `;
            
            // Hacer clickeable
            linkCard.addEventListener('click', () => {
                window.open(url, '_blank');
            });
            
            canvas.appendChild(linkCard);
            makeDraggable(linkCard);
            linkCard.classList.add('wiggle');
            
            closeModal('linkModal');
            autoSave();
            
            // Reset form
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkTitle').value = '';
            document.getElementById('linkDescription').value = '';
        }

        // Sistema de arrastrar y soltar
        function makeDraggable(element) {
            element.addEventListener('mousedown', startDrag);
        }

        function startDrag(e) {
            if (e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true' || e.target.tagName === 'BUTTON') {
                return;
            }
            
            // Para im√°genes, solo permitir arrastrar desde la barra de t√≠tulo
            if (e.currentTarget.classList.contains('image-card')) {
                if (!e.target.classList.contains('image-header') && 
                    !e.target.classList.contains('drag-icon') && 
                    !e.target.classList.contains('image-title')) {
                    return; // No permitir arrastrar desde la imagen misma
                }
            }
            
            // Para videos, solo permitir arrastrar desde la barra de t√≠tulo
            if (e.currentTarget.classList.contains('video-note')) {
                if (!e.target.classList.contains('video-header') && 
                    !e.target.classList.contains('drag-icon') && 
                    !e.target.classList.contains('video-title')) {
                    return; // No permitir arrastrar desde el video mismo
                }
            }
            
            // Permitir arrastrar desde la barra o para otros elementos
            startDragNormal(e);
        }

        function startDragNormal(e) {
            isDragging = true;
            currentElement = e.currentTarget;
            
            // Obtener posici√≥n del mouse en coordenadas del canvas transformado
            const mousePos = getCanvasMousePosition(e);
            
            // Calcular el offset del mouse respecto al elemento
            const elementX = parseFloat(currentElement.style.left) || 0;
            const elementY = parseFloat(currentElement.style.top) || 0;
            
            // Guardar el offset entre el mouse y la esquina del elemento
            startX = mousePos.x - elementX;
            startY = mousePos.y - elementY;
            
            currentElement.style.zIndex = '1000';
            e.preventDefault();
        }

        function getCanvasMousePosition(e) {
            const canvasRect = canvas.getBoundingClientRect();
            
            // Convertir coordenadas de pantalla a coordenadas del canvas
            const x = (e.clientX - canvasRect.left - panX) / zoomLevel;
            const y = (e.clientY - canvasRect.top - panY) / zoomLevel;
            
            return { x, y };
        }

        function drag(e) {
            if (!isDragging || !currentElement) return;
            
            // Obtener posici√≥n actual del mouse en coordenadas del canvas
            const mousePos = getCanvasMousePosition(e);
            
            // Calcular nueva posici√≥n del elemento
            const newX = mousePos.x - startX;
            const newY = mousePos.y - startY;
            
            // Aplicar la nueva posici√≥n
            currentElement.style.left = newX + 'px';
            currentElement.style.top = newY + 'px';
        }

        function stopDrag() {
            if (isDragging && currentElement) {
                currentElement.style.zIndex = 'auto';
                autoSave();
            }
            isDragging = false;
            currentElement = null;
        }

        // Pan del canvas
        function startPan(e) {
            // Solo iniciar pan si hacemos click en el canvas mismo o el workspace, no en elementos
            if ((e.target === canvas || e.target.classList.contains('workspace')) && 
                !e.target.closest('.sticky-note, .text-block, .image-card, .link-card')) {
                isPanning = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                canvas.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
            }
        }

        function pan(e) {
            if (isDragging) {
                drag(e);
            } else if (isPanning) {
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                
                // Limitar el pan para que no se salga demasiado del canvas
                const maxPanX = 500;
                const maxPanY = 500;
                const minPanX = -(canvas.offsetWidth - window.innerWidth + 500);
                const minPanY = -(canvas.offsetHeight - window.innerHeight + 500);
                
                panX = Math.max(minPanX, Math.min(maxPanX, panX));
                panY = Math.max(minPanY, Math.min(maxPanY, panY));
                
                updateCanvasTransform();
            }
        }

        function stopPan() {
            if (isDragging) {
                stopDrag();
            }
            isPanning = false;
            canvas.style.cursor = 'grab';
            document.body.style.userSelect = 'auto';
        }

        function updateCanvasTransform() {
            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
            updateNavigationInfo();
        }

        function updateNavigationInfo() {
            const zoomInfo = document.getElementById('zoomInfo');
            const posInfo = document.getElementById('posInfo');
            
            if (zoomInfo) {
                zoomInfo.textContent = Math.round(zoomLevel * 100) + '%';
            }
            
            if (posInfo) {
                const x = Math.round(-panX / zoomLevel);
                const y = Math.round(-panY / zoomLevel);
                posInfo.textContent = `(${x}, ${y})`;
            }
        }

        // Funci√≥n para mostrar/ocultar el panel de navegaci√≥n
        function toggleNavInfo() {
            const navInfo = document.getElementById('navInfo');
            const navToggle = document.getElementById('navToggle');
            
            if (navInfo.classList.contains('hidden')) {
                // Mostrar panel
                navInfo.classList.remove('hidden');
                navToggle.classList.remove('show');
            } else {
                // Ocultar panel
                navInfo.classList.add('hidden');
                navToggle.classList.add('show');
            }
            
            // Guardar preferencia en localStorage
            localStorage.setItem('meoword-nav-hidden', navInfo.classList.contains('hidden'));
        }

        // Funci√≥n para cargar el estado del panel
        function loadNavigationState() {
            const isHidden = localStorage.getItem('meoword-nav-hidden') === 'true';
            const navInfo = document.getElementById('navInfo');
            const navToggle = document.getElementById('navToggle');
            
            if (isHidden) {
                navInfo.classList.add('hidden');
                navToggle.classList.add('show');
            }
        }

        // Funciones de la pantalla de carga
        function startLoadingScreen() {
            createPawPrints();
            initConstellationAnimation();
            startLoadingAnimation();
            
            // Simular carga con diferentes etapas
            const loadingStages = [
                { progress: 0, text: "Despertando a los gatitos escritores..." },
                { progress: 15, text: "Espolvoreando purpurina de palabras..." },
                { progress: 30, text: "Organizando las letras pastel..." },
                { progress: 45, text: "Cargando la magia textual..." },
                { progress: 60, text: "Puliendo las plumas del escritorio..." },
                { progress: 75, text: "Activando el modo s√∫per cute..." },
                { progress: 90, text: "¬°A√±adiendo los toques finales!" },
                { progress: 100, text: "¬°Miau! Todo listo para escribir ‚ú®" }
            ];
            
            let currentStage = 0;
            
            loadingInterval = setInterval(() => {
                if (currentStage < loadingStages.length) {
                    const stage = loadingStages[currentStage];
                    updateLoadingProgress(stage.progress, stage.text);
                    currentStage++;
                } else {
                    clearInterval(loadingInterval);
                    setTimeout(hideLoadingScreen, 500);
                }
            }, 400);
        }

        function updateLoadingProgress(percentage, tip) {
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercentage = document.getElementById('loadingPercentage');
            const loadingTips = document.getElementById('loadingTips');
            
            if (loadingBar) {
                loadingBar.style.width = percentage + '%';
            }
            
            if (loadingPercentage) {
                loadingPercentage.textContent = percentage + '%';
            }
            
            if (loadingTips) {
                loadingTips.style.opacity = '0';
                setTimeout(() => {
                    loadingTips.textContent = tip;
                    loadingTips.style.opacity = '1';
                }, 150);
            }
            
            // Agregar efectos especiales en ciertos porcentajes
            if (percentage === 50) {
                createSpecialEffect('üéä');
            } else if (percentage === 75) {
                createSpecialEffect('üåü');
            } else if (percentage === 100) {
                createSpecialEffect('üéâ');
            }
        }

        function createSpecialEffect(emoji) {
            // Create temporary celebration stars in constellation
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    const angle = (Math.PI * 2 / 3) * i;
                    const radius = 100 + Math.random() * 50;
                    
                    constellationStars.push({
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius,
                        dx: Math.cos(angle) * 2,
                        dy: Math.sin(angle) * 2,
                        size: 8,
                        color: '#FFD700',
                        twinkle: 0,
                        temporary: true,
                        life: 60 // frames to live
                    });
                }, i * 200);
            }
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('hidden');
            
            // Limpiar intervalos
            if (pawPrintInterval) {
                clearInterval(pawPrintInterval);
            }
            
            // Stop constellation animation
            if (constellationAnimationId) {
                cancelAnimationFrame(constellationAnimationId);
                constellationAnimationId = null;
            }
            
            // Remover despu√©s de la animaci√≥n
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 1000);
        }

        function startLoadingAnimation() {
            // Animaci√≥n adicional del gato (parpadeo m√°s frecuente durante la carga)
            const catEyes = document.querySelectorAll('.cat-eye');
            let blinkCount = 0;
            
            const blinkInterval = setInterval(() => {
                catEyes.forEach(eye => {
                    eye.style.transform = 'scaleY(0.1)';
                    setTimeout(() => {
                        eye.style.transform = 'scaleY(1)';
                    }, 150);
                });
                
                blinkCount++;
                if (blinkCount > 15) {
                    clearInterval(blinkInterval);
                }
            }, 800);
        }

        function createPawPrints() {
            const pawPrintsContainer = document.getElementById('pawPrints');
            const pawEmojis = ['üêæ', 'üêæ', 'üêæ'];
            
            pawPrintInterval = setInterval(() => {
                const pawPrint = document.createElement('div');
                pawPrint.className = 'paw-print';
                pawPrint.textContent = pawEmojis[Math.floor(Math.random() * pawEmojis.length)];
                pawPrint.style.left = Math.random() * 100 + '%';
                pawPrint.style.animationDuration = (Math.random() * 4 + 4) + 's';
                
                pawPrintsContainer.appendChild(pawPrint);
                
                // Remover despu√©s de la animaci√≥n
                setTimeout(() => {
                    if (pawPrint.parentNode) {
                        pawPrint.parentNode.removeChild(pawPrint);
                    }
                }, 8000);
            }, 800);
        }

        // Constellation animation variables
        let constellationCanvas;
        let constellationCtx;
        let constellationStars = [];
        let constellationLines = [];
        let constellationAnimationId;

        function initConstellationAnimation() {
            constellationCanvas = document.getElementById('loading-constellation-canvas');
            constellationCtx = constellationCanvas.getContext('2d');
            
            // Resize canvas
            resizeConstellationCanvas();
            window.addEventListener('resize', resizeConstellationCanvas);
            
            // Create stars avoiding center area (where cat is)
            createConstellationStars();
            
            // Start animation
            animateConstellation();
        }

        function resizeConstellationCanvas() {
            constellationCanvas.width = window.innerWidth;
            constellationCanvas.height = window.innerHeight;
        }

        function createConstellationStars() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const exclusionRadius = 200; // Area around the cat to keep clear
            
            // Pastel colors similar to The Second Part
            const pastelColors = ['#FFB6D9', '#D4A5FF', '#B2F7EF', '#FFE5EC', '#F3FFE3'];
            
            // Create 15 stars avoiding center area
            for (let i = 0; i < 15; i++) {
                let x, y;
                do {
                    x = Math.random() * window.innerWidth;
                    y = Math.random() * window.innerHeight;
                } while (Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2) < exclusionRadius);
                
                constellationStars.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * 0.5, // Slow movement
                    dy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 3 + 2,
                    color: pastelColors[Math.floor(Math.random() * pastelColors.length)],
                    twinkle: Math.random() * Math.PI * 2
                });
            }
            
            // Create constellation lines connecting nearby stars
            for (let i = 0; i < constellationStars.length; i++) {
                for (let j = i + 1; j < constellationStars.length; j++) {
                    const dist = Math.sqrt(
                        (constellationStars[i].x - constellationStars[j].x) ** 2 + 
                        (constellationStars[i].y - constellationStars[j].y) ** 2
                    );
                    
                    if (dist < 150 && Math.random() < 0.3) { // 30% chance for nearby stars
                        constellationLines.push({
                            star1: i,
                            star2: j,
                            opacity: Math.random() * 0.3 + 0.1
                        });
                    }
                }
            }
            
        }

        function animateConstellation() {
            constellationCtx.clearRect(0, 0, constellationCanvas.width, constellationCanvas.height);
            
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const exclusionRadius = 200;
            
            // Draw constellation lines
            constellationCtx.save();
            constellationLines.forEach(line => {
                const star1 = constellationStars[line.star1];
                const star2 = constellationStars[line.star2];
                
                constellationCtx.beginPath();
                constellationCtx.moveTo(star1.x, star1.y);
                constellationCtx.lineTo(star2.x, star2.y);
                constellationCtx.strokeStyle = `rgba(180, 148, 246, ${line.opacity})`;
                constellationCtx.lineWidth = 1;
                constellationCtx.stroke();
            });
            constellationCtx.restore();
            
            // Update and draw stars
            constellationStars.forEach((star, index) => {
                // Handle temporary stars
                if (star.temporary) {
                    star.life--;
                    if (star.life <= 0) {
                        constellationStars.splice(index, 1);
                        return;
                    }
                }
                
                // Update position
                star.x += star.dx;
                star.y += star.dy;
                
                // Bounce off edges (only for non-temporary stars)
                if (!star.temporary) {
                    if (star.x < 0 || star.x > constellationCanvas.width) star.dx *= -1;
                    if (star.y < 0 || star.y > constellationCanvas.height) star.dy *= -1;
                    
                    // Keep stars away from center
                    const distFromCenter = Math.sqrt((star.x - centerX) ** 2 + (star.y - centerY) ** 2);
                    if (distFromCenter < exclusionRadius) {
                        const angle = Math.atan2(star.y - centerY, star.x - centerX);
                        star.x = centerX + Math.cos(angle) * exclusionRadius;
                        star.y = centerY + Math.sin(angle) * exclusionRadius;
                        star.dx = Math.cos(angle) * Math.abs(star.dx);
                        star.dy = Math.sin(angle) * Math.abs(star.dy);
                    }
                }
                
                // Update twinkle
                star.twinkle += 0.02;
                
                // Draw star
                const twinkleAlpha = (Math.sin(star.twinkle) + 1) * 0.5 * 0.8 + 0.2;
                constellationCtx.save();
                constellationCtx.globalAlpha = twinkleAlpha;
                constellationCtx.beginPath();
                
                // Draw star shape
                const spikes = 5;
                const outerRadius = star.size;
                const innerRadius = star.size * 0.5;
                
                constellationCtx.translate(star.x, star.y);
                constellationCtx.rotate(star.twinkle * 0.1);
                
                for (let i = 0; i < spikes * 2; i++) {
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const angle = (i * Math.PI) / spikes;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    if (i === 0) constellationCtx.moveTo(x, y);
                    else constellationCtx.lineTo(x, y);
                }
                
                constellationCtx.closePath();
                constellationCtx.fillStyle = star.color;
                constellationCtx.fill();
                constellationCtx.restore();
            });
            
            constellationAnimationId = requestAnimationFrame(animateConstellation);
            


            
            // Crear menos elementos cute adicionales (reducido de 10 a 4)
            const cuteElements = ['üåô', '‚òÅÔ∏è', 'ÔøΩ', 'üí´']; // Solo elementos m√°s sutiles
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    const cute = document.createElement('div');
                    cute.className = 'cute-element';
                    cute.textContent = cuteElements[Math.floor(Math.random() * cuteElements.length)];
                    cute.style.left = Math.random() * 100 + '%';
                    cute.style.top = Math.random() * 100 + '%';
                    cute.style.animationDelay = Math.random() * 7 + 's'; // M√°s lento
                    decorativeContainer.appendChild(cute);
                }, i * 700); // Aparecen m√°s despacio
            }
        }

        // Workspace Constellation Animation
        let workspaceConstellationCanvas;
        let workspaceConstellationCtx;
        let workspaceStars = [];
        let workspaceConstellations = [];
        let workspaceAnimationId;

        function initWorkspaceConstellation() {
            workspaceConstellationCanvas = document.getElementById('workspace-constellation-canvas');
            if (!workspaceConstellationCanvas) return;
            
            workspaceConstellationCtx = workspaceConstellationCanvas.getContext('2d');
            
            // Resize canvas
            resizeWorkspaceCanvas();
            window.addEventListener('resize', resizeWorkspaceCanvas);
            
            // Create stars for sides only (avoid center workspace area)
            createWorkspaceStars();
            
            // Create constellation connections
            createWorkspaceConstellations();
            
            // Start animation
            animateWorkspaceConstellation();
        }

        function resizeWorkspaceCanvas() {
            workspaceConstellationCanvas.width = window.innerWidth;
            workspaceConstellationCanvas.height = window.innerHeight;
        }

        function createWorkspaceStars() {
            const centerExclusionWidth = window.innerWidth * 0.6; // 60% of width for workspace
            const centerExclusionHeight = window.innerHeight * 0.8; // 80% of height for workspace
            const sideWidth = (window.innerWidth - centerExclusionWidth) / 2;
            
            // Pastel colors from The Second Part
            const pastelColors = ['#FFB6D9', '#D4A5FF', '#B2F7EF', '#FFE5EC', '#F3FFE3'];
            
            // Create stars on left side
            for (let i = 0; i < 8; i++) {
                workspaceStars.push({
                    x: Math.random() * sideWidth,
                    y: Math.random() * window.innerHeight,
                    dx: (Math.random() - 0.5) * 0.3,
                    dy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2 + 1,
                    color: pastelColors[Math.floor(Math.random() * pastelColors.length)],
                    twinkle: Math.random() * Math.PI * 2,
                    side: 'left'
                });
            }
            
            // Create stars on right side
            for (let i = 0; i < 8; i++) {
                workspaceStars.push({
                    x: window.innerWidth - sideWidth + Math.random() * sideWidth,
                    y: Math.random() * window.innerHeight,
                    dx: (Math.random() - 0.5) * 0.3,
                    dy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2 + 1,
                    color: pastelColors[Math.floor(Math.random() * pastelColors.length)],
                    twinkle: Math.random() * Math.PI * 2,
                    side: 'right'
                });
            }
            
            // Create stars on top
            for (let i = 0; i < 6; i++) {
                workspaceStars.push({
                    x: sideWidth + Math.random() * centerExclusionWidth,
                    y: Math.random() * (window.innerHeight * 0.1), // Top 10%
                    dx: (Math.random() - 0.5) * 0.3,
                    dy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2 + 1,
                    color: pastelColors[Math.floor(Math.random() * pastelColors.length)],
                    twinkle: Math.random() * Math.PI * 2,
                    side: 'top'
                });
            }
        }

        function createWorkspaceConstellations() {
            // Connect nearby stars within same side
            for (let i = 0; i < workspaceStars.length; i++) {
                for (let j = i + 1; j < workspaceStars.length; j++) {
                    const star1 = workspaceStars[i];
                    const star2 = workspaceStars[j];
                    
                    // Only connect stars on same side
                    if (star1.side === star2.side) {
                        const dist = Math.sqrt(
                            (star1.x - star2.x) ** 2 + 
                            (star1.y - star2.y) ** 2
                        );
                        
                        if (dist < 120 && Math.random() < 0.4) { // 40% chance for nearby stars
                            workspaceConstellations.push({
                                star1: i,
                                star2: j,
                                opacity: Math.random() * 0.2 + 0.05,
                                side: star1.side
                            });
                        }
                    }
                }
            }
        }

        function animateWorkspaceConstellation() {
            if (!workspaceConstellationCtx) return;
            
            workspaceConstellationCtx.clearRect(0, 0, workspaceConstellationCanvas.width, workspaceConstellationCanvas.height);
            
            // Draw constellation lines
            workspaceConstellationCtx.save();
            workspaceConstellations.forEach(line => {
                const star1 = workspaceStars[line.star1];
                const star2 = workspaceStars[line.star2];
                
                workspaceConstellationCtx.beginPath();
                workspaceConstellationCtx.moveTo(star1.x, star1.y);
                workspaceConstellationCtx.lineTo(star2.x, star2.y);
                workspaceConstellationCtx.strokeStyle = `rgba(180, 148, 246, ${line.opacity})`;
                workspaceConstellationCtx.lineWidth = 0.8;
                workspaceConstellationCtx.stroke();
            });
            workspaceConstellationCtx.restore();
            
            // Update and draw stars
            workspaceStars.forEach(star => {
                // Update position
                star.x += star.dx;
                star.y += star.dy;
                
                // Boundary checks based on side
                if (star.side === 'left') {
                    const sideWidth = (window.innerWidth - window.innerWidth * 0.6) / 2;
                    if (star.x < 0 || star.x > sideWidth) star.dx *= -1;
                } else if (star.side === 'right') {
                    const sideWidth = (window.innerWidth - window.innerWidth * 0.6) / 2;
                    const leftBoundary = window.innerWidth - sideWidth;
                    if (star.x < leftBoundary || star.x > window.innerWidth) star.dx *= -1;
                } else if (star.side === 'top') {
                    const sideWidth = (window.innerWidth - window.innerWidth * 0.6) / 2;
                    if (star.x < sideWidth || star.x > window.innerWidth - sideWidth) star.dx *= -1;
                    if (star.y < 0 || star.y > window.innerHeight * 0.1) star.dy *= -1;
                }
                
                if (star.y < 0 || star.y > workspaceConstellationCanvas.height) star.dy *= -1;
                
                // Update twinkle
                star.twinkle += 0.015;
                
                // Draw star
                const twinkleAlpha = (Math.sin(star.twinkle) + 1) * 0.5 * 0.6 + 0.2;
                workspaceConstellationCtx.save();
                workspaceConstellationCtx.globalAlpha = twinkleAlpha;
                
                // Draw star shape
                const spikes = 5;
                const outerRadius = star.size;
                const innerRadius = star.size * 0.4;
                
                workspaceConstellationCtx.translate(star.x, star.y);
                workspaceConstellationCtx.rotate(star.twinkle * 0.05);
                workspaceConstellationCtx.beginPath();
                
                for (let i = 0; i < spikes * 2; i++) {
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const angle = (i * Math.PI) / spikes;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    if (i === 0) workspaceConstellationCtx.moveTo(x, y);
                    else workspaceConstellationCtx.lineTo(x, y);
                }
                
                workspaceConstellationCtx.closePath();
                workspaceConstellationCtx.fillStyle = star.color;
                workspaceConstellationCtx.shadowColor = star.color;
                workspaceConstellationCtx.shadowBlur = 3;
                workspaceConstellationCtx.fill();
                workspaceConstellationCtx.restore();
            });
            
            workspaceAnimationId = requestAnimationFrame(animateWorkspaceConstellation);
        }

        // Zoom
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3);
            updateCanvasTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.2);
            updateCanvasTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            panX = 0;
            panY = 0;
            updateCanvasTransform();
        }

        // Context menu
        function showContextMenu(e) {
            e.preventDefault();
            
            // Convertir las coordenadas del mouse a coordenadas del canvas
            const mousePos = getCanvasMousePosition(e);
            contextMenuX = mousePos.x;
            contextMenuY = mousePos.y;
            
            // Posicionar el men√∫ contextual en la pantalla
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.clientX + 'px';
            contextMenu.style.top = e.clientY + 'px';
            
            // Asegurarse de que el men√∫ no se salga de la pantalla
            const menuRect = contextMenu.getBoundingClientRect();
            if (e.clientX + menuRect.width > window.innerWidth) {
                contextMenu.style.left = (e.clientX - menuRect.width) + 'px';
            }
            if (e.clientY + menuRect.height > window.innerHeight) {
                contextMenu.style.top = (e.clientY - menuRect.height) + 'px';
            }
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        // Utilidades
        function removeElement(element) {
            // Usar exactamente el mismo c√≥digo que funciona para drawing canvas
            element.style.transform = 'scale(0.8)';
            element.style.opacity = '0.5';
            
            setTimeout(() => {
                element.remove();
                autoSave();
            }, 200);
        }

        // ====== FUNCIONES AUXILIARES ADICIONALES ======

        function addTask(listElement) {
            const task = prompt('Nueva tarea:');
            if (!task) return;
            
            const content = listElement.querySelector('[contenteditable]');
            const priority = prompt('Prioridad (alta/media/baja):')?.toLowerCase() || 'media';
            
            let emoji = 'üü°';
            if (priority === 'alta') emoji = 'üî¥';
            if (priority === 'baja') emoji = 'üü¢';
            
            content.innerHTML += `\n${emoji} ${task}`;
            showNotificationMessage(`‚úÖ Tarea "${task}" a√±adida`, 'success');
        }

        function markTaskComplete(element) {
            const content = element.querySelector('[contenteditable]');
            const text = content.innerHTML;
            
            // Cambiar primer ‚ùå o üîÑ o ‚è≥ por ‚úÖ
            const updated = text.replace(/(‚ùå|üîÑ|‚è≥)/, '‚úÖ');
            content.innerHTML = updated;
            
            showNotificationMessage('‚úÖ Tarea marcada como completada', 'success');
        }

        function toggleTaskStatus(element, taskIndex) {
            const content = element.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            if (lines[taskIndex]) {
                const currentStatus = lines[taskIndex].match(/(‚úÖ|‚ùå|üîÑ|‚è≥)/);
                if (currentStatus) {
                    const statuses = ['‚è≥', 'üîÑ', '‚úÖ', '‚ùå'];
                    const currentIndex = statuses.indexOf(currentStatus[0]);
                    const nextIndex = (currentIndex + 1) % statuses.length;
                    lines[taskIndex] = lines[taskIndex].replace(currentStatus[0], statuses[nextIndex]);
                    content.innerHTML = lines.join('\n');
                }
            }
        }

        function addWeeklyEvent(day) {
            const event = prompt(`Evento para ${day}:`);
            if (!event) return;
            
            const planners = document.querySelectorAll('.weekly-planner [contenteditable]');
            planners.forEach(planner => {
                const dayMap = {
                    'Lunes': 'Lun:', 'Martes': 'Mar:', 'Mi√©rcoles': 'Mi√©:',
                    'Jueves': 'Jue:', 'Viernes': 'Vie:', 'S√°bado': 'S√°b:', 'Domingo': 'Dom:'
                };
                
                const dayPrefix = dayMap[day] || day + ':';
                const content = planner.innerHTML;
                const lines = content.split('\n');
                const dayLine = lines.findIndex(line => line.includes(dayPrefix));
                
                if (dayLine !== -1) {
                    lines[dayLine] += ` | ${event}`;
                    planner.innerHTML = lines.join('\n');
                }
            });
            
            showNotificationMessage(`üìÖ Evento "${event}" a√±adido a ${day}`, 'success');
        }

        function updateGoalProgress(goalElement, goalIndex, newProgress) {
            const content = goalElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            // Buscar l√≠nea del objetivo y actualizar progreso
            lines.forEach((line, index) => {
                if (line.includes('proyecto') && line.includes('%')) {
                    const updatedLine = line.replace(/\d+%/, `${newProgress}%`);
                    lines[index] = updatedLine;
                }
            });
            
            content.innerHTML = lines.join('\n');
        }

        function addHabit(habitElement) {
            const habit = prompt('Nuevo h√°bito a trackear:');
            if (!habit) return;
            
            const content = habitElement.querySelector('[contenteditable]');
            const emojis = ['üí™', 'üìñ', 'üíß', 'üßò', 'üçé', 'üéØ', 'üíª'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            content.innerHTML += `\n${randomEmoji} ${habit}: ‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå`;
            showNotificationMessage(`üìà H√°bito "${habit}" a√±adido al tracker`, 'success');
        }

        function toggleHabitDay(habitElement, habitIndex, dayIndex) {
            const content = habitElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            if (lines[habitIndex]) {
                const symbols = ['‚ùå', '‚úÖ'];
                const dayPattern = /(‚ùå|‚úÖ)/g;
                const matches = [...lines[habitIndex].matchAll(dayPattern)];
                
                if (matches[dayIndex]) {
                    const currentSymbol = matches[dayIndex][0];
                    const newSymbol = currentSymbol === '‚ùå' ? '‚úÖ' : '‚ùå';
                    
                    let count = 0;
                    lines[habitIndex] = lines[habitIndex].replace(dayPattern, (match) => {
                        return count++ === dayIndex ? newSymbol : match;
                    });
                    
                    content.innerHTML = lines.join('\n');
                }
            }
        }

        function addDecisionOption(matrixElement) {
            const option = prompt('Nueva opci√≥n para evaluar:');
            if (!option) return;
            
            const content = matrixElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            // Actualizar cabecera
            const headerLine = lines.find(line => line.includes('|'));
            if (headerLine) {
                const headerIndex = lines.indexOf(headerLine);
                lines[headerIndex] = headerLine.replace('| C |', `| C | ${option.charAt(0).toUpperCase()} |`);
            }
            
            content.innerHTML = lines.join('\n');
            showNotificationMessage(`ü§î Opci√≥n "${option}" a√±adida a la matriz`, 'success');
        }

        function updateMatrixScore(matrixElement, criteria, option, score) {
            const content = matrixElement.querySelector('[contenteditable]');
            // L√≥gica para actualizar puntuaci√≥n en la matriz
            showNotificationMessage(`üìä Puntuaci√≥n actualizada: ${criteria} - ${option}: ${score}`, 'info');
        }

        function addProsConsItem(element, type) {
            const item = prompt(`Nuevo ${type === 'pro' ? 'PRO' : 'CONTRA'}:`);
            if (!item) return;
            
            const content = element.querySelector('[contenteditable]');
            const symbol = type === 'pro' ? '‚Ä¢' : '‚Ä¢';
            const section = type === 'pro' ? '‚úÖ PROS:' : '‚ùå CONTRAS:';
            
            let lines = content.innerHTML.split('\n');
            const sectionIndex = lines.findIndex(line => line.includes(section));
            
            if (sectionIndex !== -1) {
                // Encontrar donde insertar el nuevo item
                let insertIndex = sectionIndex + 1;
                while (insertIndex < lines.length && lines[insertIndex].startsWith('‚Ä¢')) {
                    insertIndex++;
                }
                
                lines.splice(insertIndex, 0, `${symbol} ${item}`);
                content.innerHTML = lines.join('\n');
            }
            
            showNotificationMessage(`${type === 'pro' ? '‚úÖ' : '‚ùå'} "${item}" a√±adido`, 'success');
        }

        function createFlashcard(generatorElement) {
            const question = prompt('Pregunta:');
            if (!question) return;
            
            const answer = prompt('Respuesta:');
            if (!answer) return;
            
            // Actualizar contador en el generador
            const content = generatorElement.querySelector('[contenteditable]');
            const currentCount = parseInt(content.innerHTML.match(/Tarjetas creadas: (\d+)/)?.[1] || '0');
            const newCount = currentCount + 1;
            
            content.innerHTML = content.innerHTML.replace(
                /Tarjetas creadas: \d+/,
                `Tarjetas creadas: ${newCount}`
            );
            
            // Crear la flashcard visual
            const flashcard = document.createElement('div');
            flashcard.className = 'flashcard';
            flashcard.style.cssText = `
                position: absolute;
                left: ${Math.random() * 300 + 100}px;
                top: ${Math.random() * 200 + 100}px;
                width: 200px;
                height: 120px;
                background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
                border-radius: 12px;
                color: white;
                padding: 15px;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                transition: transform 0.3s;
            `;
            
            flashcard.innerHTML = `
                <div class="flashcard-front" style="display: block;">
                    <strong>Pregunta:</strong><br>
                    ${question}
                    <div style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; opacity: 0.7;">Clic para voltear</div>
                </div>
                <div class="flashcard-back" style="display: none;">
                    <strong>Respuesta:</strong><br>
                    ${answer}
                    <div style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; opacity: 0.7;">Clic para voltear</div>
                </div>
            `;
            
            flashcard.onclick = () => flipFlashcard(flashcard);
            
            canvas.appendChild(flashcard);
            makeDraggable(flashcard);
            flashcard.classList.add('wiggle');
            
            showNotificationMessage(`üÉè Flashcard creada: "${question}"`, 'success');
        }

        function flipFlashcard(flashcard) {
            const front = flashcard.querySelector('.flashcard-front');
            const back = flashcard.querySelector('.flashcard-back');
            
            if (front.style.display === 'none') {
                front.style.display = 'block';
                back.style.display = 'none';
            } else {
                front.style.display = 'none';
                back.style.display = 'block';
            }
        }

        function addConceptConnection(mapElement) {
            const concept1 = prompt('Concepto origen:');
            const concept2 = prompt('Concepto destino:');
            const relation = prompt('Tipo de relaci√≥n:');
            
            if (!concept1 || !concept2) return;
            
            const content = mapElement.querySelector('[contenteditable]');
            content.innerHTML += `\nüìç ${concept1} ‚Üí ${relation || 'relacionado con'} ‚Üí ${concept2}`;
            
            showNotificationMessage(`üó∫Ô∏è Conexi√≥n creada: ${concept1} ‚Üí ${concept2}`, 'success');
        }

        function addCornellCue(notesElement) {
            const cue = prompt('Nueva pista/concepto clave:');
            const note = prompt('Nota correspondiente:');
            
            if (!cue) return;
            
            const content = notesElement.querySelector('[contenteditable]');
            const newLine = `${cue.padEnd(18)} | ${note || 'Nota pendiente'}`;
            
            // Insertar antes del resumen
            let lines = content.innerHTML.split('\n');
            const summaryIndex = lines.findIndex(line => line.includes('Resumen:'));
            
            if (summaryIndex !== -1) {
                lines.splice(summaryIndex - 1, 0, newLine);
                content.innerHTML = lines.join('\n');
            }
            
            showNotificationMessage(`üìù Nueva entrada: "${cue}"`, 'success');
        }

        function updateStudyProgress(progressElement, subject, newProgress) {
            const content = progressElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            lines.forEach((line, index) => {
                if (line.includes(subject)) {
                    const bars = '‚ñà'.repeat(Math.floor(newProgress / 10)) + '‚ñë'.repeat(10 - Math.floor(newProgress / 10));
                    lines[index] = line.replace(/[‚ñà‚ñë]+/, bars).replace(/\d+%/, `${newProgress}%`);
                }
            });
            
            content.innerHTML = lines.join('\n');
        }

        function addResource(bankElement) {
            const type = prompt('Tipo de recurso (libro/video/pdf/enlace/audio):');
            const name = prompt('Nombre del recurso:');
            
            if (!type || !name) return;
            
            const content = bankElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            // Actualizar contador del tipo correspondiente
            lines.forEach((line, index) => {
                if (line.toLowerCase().includes(type.toLowerCase())) {
                    const currentCount = parseInt(line.match(/\d+/)?.[0] || '0');
                    lines[index] = line.replace(/\d+/, currentCount + 1);
                }
            });
            
            // A√±adir a la lista de √∫ltimos a√±adidos
            const lastAddedIndex = lines.findIndex(line => line.includes('√öltimos a√±adidos:'));
            if (lastAddedIndex !== -1) {
                lines.splice(lastAddedIndex + 3, 0, `‚Ä¢ ${name}`);
                if (lines.length > lastAddedIndex + 6) {
                    lines.splice(lastAddedIndex + 6, 1); // Remover el m√°s antiguo
                }
            }
            
            content.innerHTML = lines.join('\n');
            showNotificationMessage(`üìÅ Recurso "${name}" a√±adido`, 'success');
        }

        function addAgendaItem(agendaElement) {
            const item = prompt('Nuevo punto de agenda:');
            const duration = prompt('Duraci√≥n en minutos:') || '10';
            
            if (!item) return;
            
            const content = agendaElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            // Encontrar la l√≠nea antes de "Duraci√≥n total"
            const totalIndex = lines.findIndex(line => line.includes('Duraci√≥n total:'));
            
            if (totalIndex !== -1) {
                const nextNumber = lines.filter(line => /^\d+\./.test(line)).length + 1;
                const newItem = `${nextNumber}. ${item} (${duration} min)`;
                lines.splice(totalIndex - 1, 0, newItem);
                
                // Actualizar duraci√≥n total
                const currentTotal = parseInt(lines[totalIndex].match(/\d+/)?.[0] || '0');
                lines[totalIndex] = `Duraci√≥n total: ${currentTotal + parseInt(duration)} min`;
            }
            
            content.innerHTML = lines.join('\n');
            showNotificationMessage(`üìã "${item}" a√±adido a la agenda`, 'success');
        }

        function addMinuteItem(minutesElement) {
            const point = prompt('Punto a registrar:');
            if (!point) return;
            
            const content = minutesElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            const discussedIndex = lines.findIndex(line => line.includes('Puntos Discutidos:'));
            if (discussedIndex !== -1) {
                const nextNumber = lines.filter(line => /^\d+\./.test(line.trim())).length + 1;
                lines.splice(discussedIndex + nextNumber, 0, `${nextNumber}. ${point}`);
            }
            
            content.innerHTML = lines.join('\n');
            showNotificationMessage(`üìù Punto "${point}" registrado`, 'success');
        }

        function addFollowUpTask(listElement) {
            const person = prompt('¬øQui√©n es responsable?');
            const task = prompt('¬øQu√© tarea debe realizar?');
            const deadline = prompt('¬øPara cu√°ndo? (ej: Viernes, Ma√±ana, etc.)');
            
            if (!person || !task) return;
            
            const emojis = ['üìß', 'üìä', 'üîß', 'üìû', 'üìã', 'üíª', 'üéØ'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            const content = listElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            const tasksIndex = lines.findIndex(line => line.includes('Tareas de Seguimiento:'));
            if (tasksIndex !== -1) {
                lines.splice(tasksIndex + 2, 0, `${randomEmoji} ${person}: ${task} (${deadline || 'Sin fecha'})`);
                
                // Actualizar contador
                const completedLine = lines.find(line => line.includes('Tareas completadas:'));
                if (completedLine) {
                    const completedIndex = lines.indexOf(completedLine);
                    const [completed, total] = completedLine.match(/\d+/g) || ['0', '0'];
                    lines[completedIndex] = `Tareas completadas: ${completed}/${parseInt(total) + 1}`;
                }
            }
            
            content.innerHTML = lines.join('\n');
            showNotificationMessage(`üìã Tarea asignada a ${person}`, 'success');
        }

        function toggleDecisionStatus(trackerElement, decisionIndex) {
            const content = trackerElement.querySelector('[contenteditable]');
            const lines = content.innerHTML.split('\n');
            
            const statuses = ['ü§î', '‚è≥', '‚úÖ'];
            const statusNames = ['Pendiente', 'En discusi√≥n', 'Decidido'];
            
            lines.forEach((line, index) => {
                if (line.includes('Decidido:') || line.includes('Pendiente:') || line.includes('En discusi√≥n:')) {
                    const currentStatus = statuses.find(status => line.includes(status));
                    if (currentStatus) {
                        const currentIndex = statuses.indexOf(currentStatus);
                        const nextIndex = (currentIndex + 1) % statuses.length;
                        const nextStatus = statuses[nextIndex];
                        const nextName = statusNames[nextIndex];
                        
                        lines[index] = line.replace(currentStatus, nextStatus).replace(/\w+:/, nextName + ':');
                    }
                }
            });
            
            content.innerHTML = lines.join('\n');
        }

        // ====== FUNCIONES PARA STORYBOARD ======

        function createStoryboard(x, y) {
            const storyboard = document.createElement('div');
            storyboard.className = 'storyboard-container';
            storyboard.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 900px;
                height: 550px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                padding: 20px;
                color: white;
                box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
                cursor: move;
            `;
            
            storyboard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0 0 5px 0;">üé¨ Storyboard Interactivo</h3>
                        <div style="font-size: 12px; opacity: 0.8;">Arrastra para reordenar ‚Ä¢ Clic derecho para opciones</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addStoryPanel(this)" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 8px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">‚ûï A√±adir Panel</button>
                        <button onclick="exportStoryboard(this)" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 8px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">üì§ Exportar</button>
                    </div>
                </div>
                <div class="story-panels" style="
                    display: flex;
                    gap: 15px;
                    overflow-x: auto;
                    padding: 10px 0;
                    height: 450px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 15px;
                ">
                    <div id="story-panel-1" class="story-panel" style="
                        min-width: 220px;
                        height: 400px;
                        background: rgba(255,255,255,0.15);
                        border-radius: 12px;
                        padding: 15px;
                        border: 2px solid rgba(255,255,255,0.3);
                        position: relative;
                        cursor: grab;
                        transition: all 0.3s;
                    " draggable="true" onmouseenter="this.style.transform='scale(1.02)'" onmouseleave="this.style.transform='scale(1)'">
                        <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel 1</div>
                        <input type="text" placeholder="T√≠tulo de la escena" style="
                            width: 100%;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 12px;
                            margin-bottom: 10px;
                        " value="üé¨ Escena inicial" onchange="updateStoryTitle(this)">
                        
                        <div class="story-image" style="
                            width: 100%;
                            height: 140px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 10px;
                            cursor: pointer;
                            border: 2px dashed rgba(255,255,255,0.4);
                            transition: all 0.3s;
                        " onclick="uploadStoryImage(this)" onmouseenter="this.style.borderColor='rgba(255,255,255,0.8)'" onmouseleave="this.style.borderColor='rgba(255,255,255,0.4)'">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üì∑</div>
                                <div style="font-size: 11px;">Clic para subir imagen</div>
                            </div>
                        </div>
                        
                        <textarea placeholder="Descripci√≥n de la escena, di√°logos, notas de direcci√≥n..." style="
                            width: 100%;
                            height: 120px;
                            background: rgba(255,255,255,0.1);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 11px;
                            resize: none;
                            font-family: inherit;
                        " onchange="updateStoryDescription(this)"></textarea>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <select style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 4px;
                                border-radius: 4px;
                                font-size: 10px;
                            " onchange="changeStoryType(this)">
                                <option value="wide">Plano General</option>
                                <option value="medium">Plano Medio</option>
                                <option value="close">Primer Plano</option>
                                <option value="detail">Detalle</option>
                            </select>
                            <button onclick="deleteStoryPanel(this)" style="
                                background: #F44336;
                                border: none;
                                color: white;
                                padding: 4px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 10px;
                            ">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div id="story-panel-2" class="story-panel" style="
                        min-width: 220px;
                        height: 400px;
                        background: rgba(255,255,255,0.15);
                        border-radius: 12px;
                        padding: 15px;
                        border: 2px solid rgba(255,255,255,0.3);
                        position: relative;
                        cursor: grab;
                        transition: all 0.3s;
                    " draggable="true" onmouseenter="this.style.transform='scale(1.02)'" onmouseleave="this.style.transform='scale(1)'">
                        <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel 2</div>
                        <input type="text" placeholder="T√≠tulo de la escena" style="
                            width: 100%;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 12px;
                            margin-bottom: 10px;
                        " value="üí´ Desarrollo" onchange="updateStoryTitle(this)">
                        
                        <div class="story-image" style="
                            width: 100%;
                            height: 140px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 10px;
                            cursor: pointer;
                            border: 2px dashed rgba(255,255,255,0.4);
                            transition: all 0.3s;
                        " onclick="uploadStoryImage(this)" onmouseenter="this.style.borderColor='rgba(255,255,255,0.8)'" onmouseleave="this.style.borderColor='rgba(255,255,255,0.4)'">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üì∑</div>
                                <div style="font-size: 11px;">Clic para subir imagen</div>
                            </div>
                        </div>
                        
                        <textarea placeholder="Descripci√≥n de la escena, di√°logos, notas de direcci√≥n..." style="
                            width: 100%;
                            height: 120px;
                            background: rgba(255,255,255,0.1);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 11px;
                            resize: none;
                            font-family: inherit;
                        " onchange="updateStoryDescription(this)"></textarea>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <select style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 4px;
                                border-radius: 4px;
                                font-size: 10px;
                            " onchange="changeStoryType(this)">
                                <option value="wide">Plano General</option>
                                <option value="medium" selected>Plano Medio</option>
                                <option value="close">Primer Plano</option>
                                <option value="detail">Detalle</option>
                            </select>
                            <button onclick="deleteStoryPanel(this)" style="
                                background: #F44336;
                                border: none;
                                color: white;
                                padding: 4px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 10px;
                            ">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            canvas.appendChild(storyboard);
            makeDraggable(storyboard);
            storyboard.classList.add('wiggle');
            
            // Habilitar drag and drop para reordenar paneles
            enableStoryboardDragAndDrop(storyboard);
        }

        function createStoryPanel(number, title) {
            return `
                <div class="story-panel" style="
                    min-width: 200px;
                    height: 350px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 15px;
                    border: 2px dashed rgba(255,255,255,0.3);
                ">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <strong>Panel ${number}</strong><br>
                        <input type="text" value="${title}" style="
                            background: transparent;
                            border: none;
                            color: white;
                            text-align: center;
                            font-size: 12px;
                            width: 100%;
                        " onchange="updateStoryTitle(this)">
                    </div>
                    
                    <div class="story-image" style="
                        width: 160px;
                        height: 120px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-bottom: 10px;
                        cursor: pointer;
                    " onclick="uploadStoryImage(this)">
                        üì∑ Imagen
                    </div>
                    
                    <textarea placeholder="Descripci√≥n de la escena..." style="
                        width: 100%;
                        height: 100px;
                        background: rgba(255,255,255,0.1);
                        border: 1px solid rgba(255,255,255,0.3);
                        border-radius: 6px;
                        color: white;
                        padding: 8px;
                        font-size: 11px;
                        resize: none;
                    " onchange="updateStoryDescription(this)"></textarea>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="deleteStoryPanel(this)" style="
                            background: #F44336;
                            border: none;
                            color: white;
                            padding: 5px 10px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 12px;
                        ">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        }

        function addStoryPanel(button) {
            const container = button.closest('.storyboard-container');
            const panelsContainer = container.querySelector('.story-panels');
            const panelCount = panelsContainer.children.length + 1;
            
            const newPanel = document.createElement('div');
            newPanel.id = `story-panel-${panelCount}`;
            newPanel.className = 'story-panel';
            newPanel.draggable = true;
            newPanel.style.cssText = `
                min-width: 220px;
                height: 400px;
                background: rgba(255,255,255,0.15);
                border-radius: 12px;
                padding: 15px;
                border: 2px solid rgba(255,255,255,0.3);
                position: relative;
                cursor: grab;
                transition: all 0.3s;
            `;
            
            newPanel.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel ${panelCount}</div>
                <input type="text" placeholder="T√≠tulo de la escena" style="
                    width: 100%;
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 6px;
                    color: white;
                    padding: 8px;
                    font-size: 12px;
                    margin-bottom: 10px;
                " value="üé¨ Nueva escena ${panelCount}" onchange="updateStoryTitle(this)">
                
                <div class="story-image" style="
                    width: 100%;
                    height: 140px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 10px;
                    cursor: pointer;
                    border: 2px dashed rgba(255,255,255,0.4);
                    transition: all 0.3s;
                " onclick="uploadStoryImage(this)" onmouseenter="this.style.borderColor='rgba(255,255,255,0.8)'" onmouseleave="this.style.borderColor='rgba(255,255,255,0.4)'">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üì∑</div>
                        <div style="font-size: 11px;">Clic para subir imagen</div>
                    </div>
                </div>
                
                <textarea placeholder="Descripci√≥n de la escena, di√°logos, notas de direcci√≥n..." style="
                    width: 100%;
                    height: 120px;
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 6px;
                    color: white;
                    padding: 8px;
                    font-size: 11px;
                    resize: none;
                    font-family: inherit;
                " onchange="updateStoryDescription(this)"></textarea>
                
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <select style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        color: white;
                        padding: 4px;
                        border-radius: 4px;
                        font-size: 10px;
                    " onchange="changeStoryType(this)">
                        <option value="wide">Plano General</option>
                        <option value="medium">Plano Medio</option>
                        <option value="close">Primer Plano</option>
                        <option value="detail">Detalle</option>
                    </select>
                    <button onclick="deleteStoryPanel(this)" style="
                        background: #F44336;
                        border: none;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 10px;
                    ">üóëÔ∏è</button>
                </div>
            `;
            
            newPanel.onmouseenter = () => newPanel.style.transform = 'scale(1.02)';
            newPanel.onmouseleave = () => newPanel.style.transform = 'scale(1)';
            
            panelsContainer.appendChild(newPanel);
            showNotificationMessage(`üé¨ Panel ${panelCount} a√±adido al storyboard`, 'success');
        }

        function updateStoryTitle(input) {
            showNotificationMessage(`‚úèÔ∏è T√≠tulo actualizado: "${input.value}"`, 'info');
        }

        function updateStoryDescription(textarea) {
            showNotificationMessage('üìù Descripci√≥n actualizada', 'info');
        }

        function changeStoryType(select) {
            const panel = select.closest('.story-panel');
            const types = {
                'wide': { border: '2px solid #4CAF50', shadow: '0 0 15px rgba(76, 175, 80, 0.3)' },
                'medium': { border: '2px solid #2196F3', shadow: '0 0 15px rgba(33, 150, 243, 0.3)' },
                'close': { border: '2px solid #FF9800', shadow: '0 0 15px rgba(255, 152, 0, 0.3)' },
                'detail': { border: '2px solid #E91E63', shadow: '0 0 15px rgba(233, 30, 99, 0.3)' }
            };
            
            const style = types[select.value];
            panel.style.border = style.border;
            panel.style.boxShadow = style.shadow;
            
            showNotificationMessage(`üìê Tipo de plano cambiado a: ${select.options[select.selectedIndex].text}`, 'info');
        }

        function uploadStoryImage(imageArea) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5000000) { // 5MB limit
                        showNotificationMessage('‚ö†Ô∏è La imagen es muy grande. M√°ximo 5MB.', 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageArea.style.backgroundImage = `url(${e.target.result})`;
                        imageArea.style.backgroundSize = 'cover';
                        imageArea.style.backgroundPosition = 'center';
                        imageArea.innerHTML = `
                            <div style="
                                position: absolute;
                                bottom: 5px;
                                right: 5px;
                                background: rgba(0,0,0,0.7);
                                color: white;
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 10px;
                            ">${file.name}</div>
                        `;
                        showNotificationMessage(`üñºÔ∏è Imagen "${file.name}" cargada`, 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }

        function deleteStoryPanel(button) {
            const panel = button.closest('.story-panel');
            const panelTitle = panel.querySelector('input').value;
            
            if (confirm(`¬øEliminar el panel "${panelTitle}"?`)) {
                panel.style.transform = 'scale(0)';
                panel.style.opacity = '0';
                setTimeout(() => {
                    panel.remove();
                    // Reordenar n√∫meros de paneles
                    reorderStoryPanels();
                }, 200);
                showNotificationMessage(`üóëÔ∏è Panel "${panelTitle}" eliminado`, 'info');
            }
        }

        function reorderStoryPanels() {
            const storyboards = document.querySelectorAll('.storyboard-container');
            storyboards.forEach(storyboard => {
                const panels = storyboard.querySelectorAll('.story-panel');
                panels.forEach((panel, index) => {
                    const headerDiv = panel.querySelector('div');
                    headerDiv.textContent = `Panel ${index + 1}`;
                    panel.id = `story-panel-${index + 1}`;
                });
            });
        }

        function exportStoryboard(button) {
            const storyboard = button.closest('.storyboard-container');
            const panels = storyboard.querySelectorAll('.story-panel');
            
            let storyData = {
                title: 'Mi Storyboard',
                created: new Date().toISOString(),
                panels: []
            };
            
            panels.forEach((panel, index) => {
                const title = panel.querySelector('input').value;
                const description = panel.querySelector('textarea').value;
                const shotType = panel.querySelector('select').value;
                const imageArea = panel.querySelector('.story-image');
                
                storyData.panels.push({
                    number: index + 1,
                    title: title,
                    description: description,
                    shotType: shotType,
                    hasImage: imageArea.style.backgroundImage ? true : false
                });
            });
            
            // Crear y descargar archivo JSON
            const dataStr = JSON.stringify(storyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `storyboard_${new Date().getTime()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotificationMessage('üì§ Storyboard exportado como JSON', 'success');
        }

        function enableStoryboardDragAndDrop(storyboard) {
            const panelsContainer = storyboard.querySelector('.story-panels');
            let draggedElement = null;
            
            panelsContainer.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('story-panel')) {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                }
            });
            
            panelsContainer.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('story-panel')) {
                    e.target.style.opacity = '1';
                    draggedElement = null;
                }
            });
            
            panelsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            panelsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(panelsContainer, e.clientX);
                
                if (draggedElement && afterElement == null) {
                    panelsContainer.appendChild(draggedElement);
                } else if (draggedElement) {
                    panelsContainer.insertBefore(draggedElement, afterElement);
                }
                
                reorderStoryPanels();
                showNotificationMessage('üé¨ Paneles reordenados', 'info');
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.story-panel:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function clearCanvas() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo el tablero? ü•∫')) {
                clearCanvasInternal();
                autoSave();
            }
        }

        function clearCanvasInternal() {
            // Limpiar canvas sin confirmaci√≥n (uso interno)
            canvas.innerHTML = '';
            // Limpiar clases de plantillas
            canvas.classList.remove('template-brainstorm', 'template-project', 'template-mindmap', 'template-timeline', 'template-story');
            // Limpiar la clase de plantilla del proyecto actual
            if (currentProject) {
                currentProject.templateClass = null;
            }
        }

        function closeModal(modalId) {
            // Limpiar recursos de video cuando se cierre el modal de video
            if (modalId === 'videoModal') {
                cleanupVideoRecording();
                resetRecordingInterface();
                
                // Resetear a m√©todo URL por defecto
                setTimeout(() => {
                    toggleVideoMethod('url');
                }, 100);
            }
            
            document.getElementById(modalId).style.display = 'none';
        }

        // Teclado con atajos completos de InkForAll
        function handleKeyboard(e) {
            // Evitar atajos cuando se est√° escribiendo en inputs o elementos editables
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') return;
            
            // Si el visor de im√°genes est√° abierto
            const imageViewer = document.getElementById('imageViewer');
            if (imageViewer && imageViewer.style.display === 'flex') {
                switch(e.key) {
                    case 'Escape':
                        closeImageViewer();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        imageViewerZoom(1.2);
                        break;
                    case '-':
                        e.preventDefault();
                        imageViewerZoom(0.8);
                        break;
                    case '0':
                        e.preventDefault();
                        resetImageViewer();
                        break;
                }
                return;
            }
            
            // Atajos con Ctrl
            if (e.ctrlKey && !e.altKey && !e.shiftKey) {
                e.preventDefault();
                switch(e.key.toLowerCase()) {
                    case 's':
                        saveBoard();
                        showNotificationMessage('üíæ Proyecto guardado', 'success');
                        break;
                    case 'o':
                        // Abrir archivo de imagen
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        fileInput.onchange = (event) => {
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    addImageFromDataUrl(e.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                        fileInput.click();
                        break;
                    case 'n':
                        addStickyNote();
                        break;
                    case 't':
                        addTextBlock();
                        break;
                    case 'z':
                        // Deshacer en canvas de dibujo activo
                        const drawingCanvases = document.querySelectorAll('.drawing-canvas');
                        if (drawingCanvases.length > 0) {
                            undoInActiveCanvas();
                        } else {
                            // Si no hay canvas de dibujo, usar funcionalidad normal de la app
                            showNotificationMessage('üé® Crea un canvas de dibujo para usar deshacer', 'info');
                        }
                        break;
                    case '=':
                    case '+':
                        increaseDrawingBrush();
                        break;
                    case '-':
                        decreaseDrawingBrush();
                        break;
                    case 'i':
                        toggleNavInfo();
                        break;
                }
                return;
            }

            // Atajos con Ctrl+Shift
            if (e.ctrlKey && e.shiftKey && !e.altKey) {
                e.preventDefault();
                switch(e.key.toLowerCase()) {
                    case 'n':
                        // Limpiar todos los canvas de dibujo
                        clearAllDrawingCanvases();
                        break;
                }
                return;
            }
            
            // Atajos simples (igual que InkForAll)
            if (!e.ctrlKey && !e.altKey && !e.shiftKey) {
                const drawingCanvases = document.querySelectorAll('.drawing-canvas');
                
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        selectDrawingTool('brush');
                        break;
                    case 'p':
                        e.preventDefault();
                        selectDrawingTool('pencil');
                        break;
                    case 'e':
                        e.preventDefault();
                        selectDrawingTool('eraser');
                        break;
                    case 'l':
                        e.preventDefault();
                        selectDrawingTool('line');
                        break;
                    case 'c':
                        e.preventDefault();
                        selectDrawingTool('circle');
                        break;
                    case 'r':
                        e.preventDefault();
                        selectDrawingTool('rectangle');
                        break;
                    case 'f':
                    case 'g':
                        e.preventDefault();
                        selectDrawingTool('bucket');
                        break;
                    case 'i':
                        e.preventDefault();
                        selectDrawingTool('eyedropper');
                        break;
                    case 'x':
                        e.preventDefault();
                        toggleDrawingColors();
                        break;
                    case 'd':
                        e.preventDefault();
                        setDrawingColor('#000000');
                        showNotificationMessage('‚ö´ Color por defecto (negro)', 'info');
                        break;
                    case '[':
                        e.preventDefault();
                        decreaseDrawingBrush();
                        break;
                    case ']':
                        e.preventDefault();
                        increaseDrawingBrush();
                        break;
                    case 'delete':
                    case 'backspace':
                        e.preventDefault();
                        clearActiveCanvas();
                        break;
                    case 'tab':
                        e.preventDefault();
                        toggleSidebarInfo();
                        break;
                    case ' ':
                        e.preventDefault();
                        // Barra espaciadora - temporalmente desactivar para evitar scroll
                        break;
                    case 'h':
                    case '?':
                        e.preventDefault();
                        showDrawingHelp();
                        break;
                    case '1': case '2': case '3': case '4': case '5':
                    case '6': case '7': case '8': case '9':
                        e.preventDefault();
                        switchToCanvasNumber(parseInt(e.key) - 1);
                        break;
                }
            }
        }
        
        // Funci√≥n para seleccionar herramienta de dibujo globalmente
        function selectDrawingTool(toolName) {
            currentTool = toolName;
            
            // Actualizar todos los canvas de dibujo activos
            document.querySelectorAll('.drawing-container').forEach(container => {
                const toolbar = container.querySelector('.drawing-toolbar');
                const canvas = container.querySelector('.drawing-canvas');
                
                if (toolbar) {
                    toolbar.querySelectorAll('.drawing-tool').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${toolName}'`)) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                // Actualizar cursor del canvas asociado
                if (canvas) {
                    updateCanvasCursor(canvas, toolName);
                }
            });
            
            // Mostrar notificaci√≥n de herramienta seleccionada
            const toolNames = {
                'brush': 'üñåÔ∏è Pincel',
                'pencil': '‚úèÔ∏è L√°piz', 
                'eraser': 'üßΩ Borrador',
                'line': 'üìè L√≠nea',
                'circle': '‚≠ï C√≠rculo',
                'rectangle': '‚¨ú Rect√°ngulo',
                'bucket': 'ü™£ Relleno',
                'eyedropper': 'üíâ Cuentagotas'
            };
            
            if (toolNames[toolName]) {
                showNotificationMessage(`Herramienta activa: ${toolNames[toolName]}`, 'info');
            }
        }
        
        // Funci√≥n para mostrar ayuda completa de dibujo
        function showDrawingHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            helpModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #FFB6D9, #D4A5FF);
                    padding: 30px;
                    border-radius: 20px;
                    max-width: 700px;
                    max-height: 85vh;
                    overflow-y: auto;
                    color: white;
                    font-family: 'Comfortaa', cursive;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                ">
                    <h2 style="margin: 0 0 20px 0; text-align: center; color: #fff;">üé® Atajos Completos de Dibujo - Meowboard</h2>
                    
                    <h3 style="color: #fff; margin: 15px 0 10px 0;">üõ†Ô∏è Herramientas:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; margin-bottom: 15px;">
                        <div><strong>B</strong> - Pincel</div>
                        <div><strong>P</strong> - L√°piz</div>
                        <div><strong>E</strong> - Borrador</div>
                        <div><strong>L</strong> - L√≠nea</div>
                        <div><strong>C</strong> - C√≠rculo</div>
                        <div><strong>R</strong> - Rect√°ngulo</div>
                        <div><strong>F / G</strong> - Relleno</div>
                        <div><strong>I</strong> - Cuentagotas</div>
                    </div>
                    
                    <h3 style="color: #fff; margin: 15px 0 10px 0;">üé® Colores y Tama√±o:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; margin-bottom: 15px;">
                        <div><strong>X</strong> - Alternar negro/blanco</div>
                        <div><strong>D</strong> - Color por defecto (negro)</div>
                        <div><strong>[</strong> - Reducir pincel</div>
                        <div><strong>]</strong> - Aumentar pincel</div>
                        <div><strong>Ctrl + +</strong> - Aumentar tama√±o</div>
                        <div><strong>Ctrl + -</strong> - Reducir tama√±o</div>
                    </div>
                    
                    <h3 style="color: #fff; margin: 15px 0 10px 0;">‚ö° Acciones R√°pidas:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; margin-bottom: 15px;">
                        <div><strong>Ctrl + Z</strong> - Deshacer</div>
                        <div><strong>Ctrl + S</strong> - Guardar proyecto</div>
                        <div><strong>Ctrl + O</strong> - Abrir imagen</div>
                        <div><strong>Del / Backspace</strong> - Limpiar canvas</div>
                        <div><strong>Ctrl + Shift + N</strong> - Limpiar todos</div>
                        <div><strong>Tab</strong> - Mostrar/ocultar sidebar</div>
                    </div>
                    
                    <h3 style="color: #fff; margin: 15px 0 10px 0;">üéØ Navegaci√≥n Canvas:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; margin-bottom: 15px;">
                        <div><strong>1-9</strong> - Seleccionar canvas</div>
                        <div><strong>H / ?</strong> - Esta ayuda</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="this.closest('div').parentElement.remove()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 2px solid white;
                            color: white;
                            padding: 12px 25px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-family: 'Comfortaa', cursive;
                            font-weight: 600;
                            font-size: 14px;
                        ">Entendido ‚ú®</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Cerrar con clic fuera o Escape
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
            
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    helpModal.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
        }

        // Sistema de Proyectos
        function initProjectsSystem() {
            loadProjects();
            setupColorPicker();
            
            // Crear proyecto por defecto si no existe ninguno
            if (projects.length === 0) {
                createDefaultProject();
            } else {
                // Cargar el √∫ltimo proyecto activo
                const activeProject = projects.find(p => p.isActive) || projects[0];
                switchToProject(activeProject.id);
            }
            
            // Asegurar que el tema se aplique al cargar
            if (currentProject) {
                updateProjectTheme(currentProject.color);
            }
        }

        function createDefaultProject() {
            const defaultProject = {
                id: 'default',
                name: 'Mi Primer Proyecto',
                emoji: 'üê±',
                color: '#FFB6D9',
                created: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                isActive: true,
                data: null
            };
            
            projects = [defaultProject];
            currentProject = defaultProject;
            saveProjects();
            renderProjectsList();
        }

        function createNewProject() {
            const projectName = prompt('üê± Nombre del nuevo proyecto:', `Proyecto ${projectIdCounter}`);
            if (!projectName) return;
            
            const emojis = ['üê±', 'üêæ', 'üìù', 'üíï', 'üå∏', '‚ú®', 'üéÄ', 'ü¶Ñ', 'üçì', 'üåü', 'üç∞', 'üéÇ'];
            const colors = ['#FFB6D9', '#D4A5FF', '#A8E6CF', '#FFE4E6', '#87CEEB', '#FFD700', '#FF8FA3', '#B2F7EF', '#F3FFE3', '#DDA0DD'];
            
            const newProject = {
                id: 'project_' + Date.now(),
                name: projectName.trim(),
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                color: colors[Math.floor(Math.random() * colors.length)],
                created: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                isActive: false,
                data: null
            };
            
            projects.push(newProject);
            projectIdCounter++;
            saveProjects();
            renderProjectsList();
            
            // Preguntar si quiere cambiar a este proyecto
            if (confirm(`¬øQuieres cambiar al proyecto "${projectName}"? üê±`)) {
                switchToProject(newProject.id);
            }
        }

        function switchToProject(projectId) {
            // Guardar datos del proyecto actual
            if (currentProject) {
                saveCurrentProjectData();
                
                // Desmarcar como activo
                projects.forEach(p => p.isActive = false);
            }
            
            // Cambiar al nuevo proyecto
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            currentProject = project;
            project.isActive = true;
            project.lastModified = new Date().toISOString();
            
            // Limpiar canvas sin confirmaci√≥n (cambio de proyecto)
            clearCanvasInternal();
            
            // Cargar datos del proyecto
            if (project.data) {
                loadProjectData(project.data);
            }
            
            saveProjects();
            renderProjectsList();
            updateProjectTheme(project.color);
            
            // Cargar tema del proyecto si existe
            if (project.theme) {
                setTheme(project.theme);
            } else {
                // Si no tiene tema, usar el tema guardado globalmente
                loadSavedTheme();
            }
            
            showProjectSwitchMessage(project.name);
        }

        function saveCurrentProjectData() {
            if (!currentProject) return;
            
            const elements = [];
            canvas.querySelectorAll('.sticky-note, .text-block, .image-card, .link-card, .audio-note, .video-note, .drawing-container').forEach(element => {
                // Determinar tipo m√°s robustamente
                let elementType = 'unknown';
                if (element.classList.contains('sticky-note')) elementType = 'sticky-note';
                else if (element.classList.contains('text-block')) elementType = 'text-block';
                else if (element.classList.contains('image-card')) elementType = 'image-card';
                else if (element.classList.contains('link-card')) elementType = 'link-card';
                else if (element.classList.contains('audio-note')) elementType = 'audio-note';
                else if (element.classList.contains('video-note')) elementType = 'video-note';
                else if (element.classList.contains('drawing-container')) elementType = 'drawing-container';
                
                const data = {
                    type: elementType,
                    left: element.style.left,
                    top: element.style.top,
                    width: element.style.width,
                    height: element.style.height,
                    content: getElementContent(element)
                };
                elements.push(data);
            });
            
            // Contar elementos por tipo para debug
            const elementCount = {};
            elements.forEach(el => {
                elementCount[el.type] = (elementCount[el.type] || 0) + 1;
            });
            console.log('üíæ Guardando proyecto:', currentProject.name, 'con elementos:', elementCount);
            
            currentProject.data = {
                elements: elements,
                zoom: zoomLevel,
                pan: { x: panX, y: panY }
            };
            // Guardar tema actual del proyecto
            currentProject.theme = getCurrentTheme();
            currentProject.lastModified = new Date().toISOString();
        }
        
        function getCurrentTheme() {
            if (document.body.classList.contains('dark-theme')) return 'dark';
            if (document.body.classList.contains('midnight-theme')) return 'midnight';
            if (document.body.classList.contains('neon-theme')) return 'neon';
            return 'light';
        }

        function getElementContent(element) {
            if (element.classList.contains('sticky-note')) {
                const textarea = element.querySelector('textarea');
                const emoji = element.querySelector('.note-emoji');
                return {
                    text: textarea ? textarea.value : '',
                    emoji: emoji ? emoji.textContent : 'üê±',
                    color: element.className.split(' ')[1] || 'yellow'
                };
            } else if (element.classList.contains('text-block')) {
                const h3 = element.querySelector('h3');
                const p = element.querySelector('p');
                return {
                    title: h3 ? h3.textContent : '',
                    content: p ? p.textContent : ''
                };
            } else if (element.classList.contains('image-card')) {
                const img = element.querySelector('img');
                const title = element.querySelector('.image-title')?.textContent || '';
                
                const content = {
                    src: img ? img.src : '',
                    alt: img ? img.alt : '',
                    title: title
                };
                
                // Si es un diagrama, incluir datos adicionales
                if (element.dataset.diagramType) {
                    content.diagramType = element.dataset.diagramType;
                    content.diagramData = element.dataset.diagramData ? JSON.parse(element.dataset.diagramData) : [];
                }
                
                return content;
            } else if (element.classList.contains('link-card')) {
                const h4 = element.querySelector('h4');
                const p = element.querySelector('p');
                return {
                    title: h4 ? h4.textContent : '',
                    description: p ? p.textContent : '',
                    url: element.dataset.url || ''
                };
            } else if (element.classList.contains('audio-note')) {
                return {
                    audioId: element.dataset.audioId || '',
                    audioUrl: element.dataset.audioUrl || '',
                    status: element.querySelector('[id*="status-"]') ? element.querySelector('[id*="status-"]').textContent : ''
                };
            } else if (element.classList.contains('video-note')) {
                const video = element.querySelector('video');
                const iframe = element.querySelector('iframe');
                const content = {
                    src: video ? video.src : (iframe ? iframe.src : ''),
                    controls: video ? video.hasAttribute('controls') : true,
                    autoplay: video ? video.hasAttribute('autoplay') : false,
                    isIframe: !!iframe
                };
                
                // Verificar si es un video grabado
                if (element.dataset.videoType === 'recorded') {
                    content.isRecorded = true;
                    content.recordedVideoData = video ? video.src : '';
                }
                
                return content;
            } else if (element.classList.contains('drawing-container')) {
                const canvas = element.querySelector('.drawing-canvas');
                const canvasData = canvas ? canvas.toDataURL() : '';
                return {
                    canvasData: canvasData,
                    canvasWidth: canvas ? canvas.width : 800,
                    canvasHeight: canvas ? canvas.height : 500
                };
            }
            return {};
        }

        function loadProjectData(data) {
            if (!data || !data.elements) return;
            
            // Contar elementos por tipo para debug
            const elementCount = {};
            data.elements.forEach(el => {
                elementCount[el.type] = (elementCount[el.type] || 0) + 1;
            });
            console.log('üìÇ Cargando proyecto con elementos:', elementCount);
            
            // Restaurar fondo de plantilla si existe
            const canvas = document.getElementById('canvas');
            canvas.classList.remove('template-brainstorm', 'template-project', 'template-mindmap', 'template-timeline', 'template-story');
            if (currentProject && currentProject.templateClass) {
                canvas.classList.add(currentProject.templateClass);
            }
            
            // Restaurar zoom y posici√≥n
            if (data.zoom) zoomLevel = data.zoom;
            if (data.pan) {
                panX = data.pan.x;
                panY = data.pan.y;
            }
            updateCanvasTransform();
            
            // Recrear elementos
            data.elements.forEach(elementData => {
                const element = createElement(elementData);
                if (element) {
                    canvas.appendChild(element);
                    makeDraggable(element);
                } else {
                    console.warn('‚ö†Ô∏è No se pudo recrear elemento de tipo:', elementData.type);
                }
            });
        }

        function createElement(data) {
            switch (data.type) {
                case 'sticky-note':
                    const note = document.createElement('div');
                    note.className = `sticky-note ${data.content.color}`;
                    note.style.left = data.left;
                    note.style.top = data.top;
                    if (data.width) note.style.width = data.width;
                    if (data.height) note.style.height = data.height;
                    
                    note.innerHTML = `
                        <div class="note-header">
                            <span class="note-emoji" onclick="changeEmoji(this)">${data.content.emoji}</span>
                        </div>
                        <textarea placeholder="Escribe tu idea aqu√≠...">${data.content.text}</textarea>
                        <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
                    `;
                    
                    const textarea = note.querySelector('textarea');
                    textarea.addEventListener('input', () => {
                        if (currentProject) {
                            currentProject.lastModified = new Date().toISOString();
                        }
                        saveBoard();
                    });
                    
                    // Asegurar que las teclas de borrado funcionen en textarea cargado
                    textarea.addEventListener('keydown', function(e) {
                        // Permitir teclas de borrado y navegaci√≥n
                        if (e.key === 'Backspace' || e.key === 'Delete' || 
                            e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                            e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
                            e.key === 'Home' || e.key === 'End') {
                            // No hacer preventDefault() - dejar que el navegador maneje estas teclas
                            e.stopPropagation(); // Evitar que llegue a handleKeyboard
                        }
                    });
                    
                    return note;
                    
                case 'text-block':
                    const textBlock = document.createElement('div');
                    textBlock.className = 'text-block';
                    textBlock.style.left = data.left;
                    textBlock.style.top = data.top;
                    if (data.width) textBlock.style.width = data.width;
                    if (data.height) textBlock.style.height = data.height;
                    
                    textBlock.innerHTML = `
                        <h3 contenteditable="true">${data.content.title}</h3>
                        <p contenteditable="true">${data.content.content}</p>
                        <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
                    `;
                    
                    textBlock.addEventListener('input', () => {
                        if (currentProject) {
                            currentProject.lastModified = new Date().toISOString();
                        }
                        saveBoard();
                    });
                    
                    // Asegurar que las teclas de borrado funcionen en elementos editables cargados
                    const editableElements = textBlock.querySelectorAll('[contenteditable="true"]');
                    editableElements.forEach(element => {
                        element.addEventListener('keydown', function(e) {
                            // Permitir teclas de borrado y navegaci√≥n
                            if (e.key === 'Backspace' || e.key === 'Delete' || 
                                e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                                e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
                                e.key === 'Home' || e.key === 'End') {
                                // No hacer preventDefault() - dejar que el navegador maneje estas teclas
                                e.stopPropagation(); // Evitar que llegue a handleKeyboard
                            }
                        });
                    });
                    
                    return textBlock;
                    
                case 'image-card':
                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-card';
                    imageCard.style.left = data.left;
                    imageCard.style.top = data.top;
                    imageCard.style.width = data.width;
                    imageCard.style.height = data.height;
                    
                    // Si es un diagrama, agregar atributos especiales
                    if (data.diagramType) {
                        imageCard.dataset.diagramType = data.diagramType;
                        imageCard.dataset.diagramData = JSON.stringify(data.diagramData);
                        imageCard.classList.add('diagram-card');
                        imageCard.title = "üìä Diagrama interactivo - Doble clic para editar";
                    }
                    
                    imageCard.innerHTML = `
                        <div class="image-header">
                            <span class="drag-icon">‚ãÆ‚ãÆ</span>
                            <span class="image-title">${data.content.title || data.title || 'Imagen'}</span>
                            <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                        </div>
                        <img src="${data.content.src || data.src}" alt="${data.content.alt || data.title || 'Imagen'}">
                    `;
                    
                    const img = imageCard.querySelector('img');
                    
                    // Evento de clic simple para im√°genes normales
                    img.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Solo abrir visor para im√°genes normales (no diagramas)
                        if (!data.diagramType) {
                            openImageViewer(this.src);
                        }
                    });
                    
                    // Evento de doble clic para editar diagramas
                    img.addEventListener('dblclick', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Si es un diagrama, permitir editar
                        if (data.diagramType) {
                            editDiagram(imageCard);
                        }
                    });
                    
                    return imageCard;
                    
                case 'link-card':
                    const linkCard = document.createElement('div');
                    linkCard.className = 'link-card';
                    linkCard.style.left = data.left;
                    linkCard.style.top = data.top;
                    linkCard.dataset.url = data.content.url;
                    
                    linkCard.innerHTML = `
                        <div class="link-preview">
                            <div class="link-icon">üîó</div>
                            <div class="link-info">
                                <h4>${data.content.title}</h4>
                                <p>${data.content.description}</p>
                            </div>
                        </div>
                        <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
                    `;
                    
                    linkCard.addEventListener('click', () => {
                        if (data.content.url) {
                            window.open(data.content.url, '_blank');
                        }
                    });
                    
                    return linkCard;
                    
                case 'audio-note':
                    const audioNote = document.createElement('div');
                    audioNote.className = 'audio-note';
                    audioNote.style.left = data.left;
                    audioNote.style.top = data.top;
                    audioNote.dataset.audioId = data.content.audioId;
                    if (data.content.audioUrl) {
                        audioNote.dataset.audioUrl = data.content.audioUrl;
                    }
                    
                    audioNote.innerHTML = `
                        <div class="audio-controls">
                            <button class="audio-btn record-btn" onclick="toggleRecording('${data.content.audioId}')" title="Grabar">üé§</button>
                            <button class="audio-btn play-btn" onclick="playAudio('${data.content.audioId}')" title="Reproducir" ${data.content.audioUrl ? '' : 'disabled'}>‚ñ∂Ô∏è</button>
                            <div class="waveform" id="waveform-${data.content.audioId}"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            <span id="status-${data.content.audioId}">${data.content.status || 'Haz clic en üé§ para grabar'}</span>
                        </div>
                        <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
                    `;
                    
                    return audioNote;
                    
                case 'video-note':
                    const videoNote = document.createElement('div');
                    videoNote.className = 'video-note';
                    videoNote.style.left = data.left;
                    videoNote.style.top = data.top;
                    if (data.width) videoNote.style.width = data.width;
                    if (data.height) videoNote.style.height = data.height;
                    
                    // Determinar el t√≠tulo del video desde la URL
                    let videoTitle = 'üé• Video';
                    if (data.content.isRecorded) {
                        videoTitle = 'üé• Video Grabado';
                    } else if (data.content.src) {
                        if (data.content.src.includes('youtube.com') || data.content.src.includes('youtu.be')) {
                            videoTitle = 'üé• YouTube';
                        } else if (data.content.src.includes('vimeo.com')) {
                            videoTitle = 'üé• Vimeo';
                        } else if (data.content.src.includes('.mp4') || data.content.src.includes('.webm') || data.content.src.includes('.mov')) {
                            videoTitle = 'üé• Video Local';
                        }
                    }
                    
                    // Configurar atributos especiales para videos grabados
                    if (data.content.isRecorded) {
                        videoNote.dataset.videoType = 'recorded';
                        if (data.content.recordedVideoData) {
                            videoNote.dataset.videoBlob = data.content.recordedVideoData;
                        }
                    }
                    
                    if (data.content.isIframe) {
                        videoNote.innerHTML = `
                            <div class="video-header">
                                <span class="drag-icon">‚ãÆ‚ãÆ</span>
                                <span class="video-title">${videoTitle}</span>
                                <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                            </div>
                            <iframe src="${data.content.src}" width="100%" height="calc(100% - 25px)" frameborder="0" allowfullscreen style="margin-top: 25px; border-radius: 0 0 10px 10px;"></iframe>
                        `;
                    } else {
                        const videoAttributes = [];
                        if (data.content.controls) videoAttributes.push('controls');
                        if (data.content.autoplay) videoAttributes.push('autoplay');
                        if (data.content.isRecorded) {
                            videoAttributes.push('muted'); // Videos grabados empiezan muteados
                            videoAttributes.push('loop');  // Videos grabados en loop por defecto
                        }
                        
                        videoNote.innerHTML = `
                            <div class="video-header">
                                <span class="drag-icon">‚ãÆ‚ãÆ</span>
                                <span class="video-title">${videoTitle}</span>
                                <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                            </div>
                            <video ${videoAttributes.join(' ')} style="width: 100%; height: calc(100% - 25px); object-fit: cover; border-radius: 0 0 10px 10px; margin-top: 25px;">
                                <source src="${data.content.src}" type="video/webm">
                                <source src="${data.content.src}" type="video/mp4">
                                Tu navegador no soporta video HTML5.
                            </video>
                        `;
                    }
                    
                    return videoNote;
                    
                case 'drawing-container':
                    // Crear contenedor de dibujo
                    const drawingContainer = document.createElement('div');
                    drawingContainer.className = 'drawing-container';
                    drawingContainer.style.left = data.left;
                    drawingContainer.style.top = data.top;
                    
                    // Crear canvas
                    const drawingCanvas = document.createElement('canvas');
                    drawingCanvas.className = 'drawing-canvas';
                    drawingCanvas.width = data.content.canvasWidth || 800;
                    drawingCanvas.height = data.content.canvasHeight || 500;
                    
                    // Generar paleta de colores
                    let colorPaletteHtml = '';
                    colorPalette.forEach((color, index) => {
                        const isActive = color === currentColor ? 'active' : '';
                        colorPaletteHtml += `<div class="drawing-color-option ${isActive}" style="background-color: ${color};" onclick="setDrawingColorFromPalette('${color}', this)"></div>`;
                    });
                    
                    // Crear toolbar
                    const toolbar = document.createElement('div');
                    toolbar.className = 'drawing-toolbar';
                    toolbar.innerHTML = `
                        <div class="canvas-close-btn" onclick="removeDrawingCanvas(this)" title="Eliminar Canvas">√ó</div>
                        
                        <div class="drawing-toolbar-row">
                            <button class="drawing-tool active" onclick="setDrawingTool(this, 'brush')" title="Pincel (B)">
                                üñåÔ∏è
                                <div class="drawing-tool-tooltip">Pincel (B)</div>
                            </button>
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'pencil')" title="L√°piz (P)">
                                ‚úèÔ∏è
                                <div class="drawing-tool-tooltip">L√°piz (P)</div>
                            </button>
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'eraser')" title="Borrador (E)">
                                üßΩ
                                <div class="drawing-tool-tooltip">Borrador (E)</div>
                            </button>
                            
                            <div class="drawing-separator"></div>
                            
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'line')" title="L√≠nea (L)">
                                üìè
                                <div class="drawing-tool-tooltip">L√≠nea (L)</div>
                            </button>
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'circle')" title="C√≠rculo (C)">
                                ‚≠ï
                                <div class="drawing-tool-tooltip">C√≠rculo (C)</div>
                            </button>
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'rectangle')" title="Rect√°ngulo (R)">
                                ‚¨ú
                                <div class="drawing-tool-tooltip">Rect√°ngulo (R)</div>
                            </button>
                            
                            <div class="drawing-separator"></div>
                            
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'bucket')" title="Relleno (F/G)">
                                ü™£
                                <div class="drawing-tool-tooltip">Relleno (F/G)</div>
                            </button>
                            <button class="drawing-tool" onclick="setDrawingTool(this, 'eyedropper')" title="Cuentagotas (I)">
                                üíâ
                                <div class="drawing-tool-tooltip">Cuentagotas (I)</div>
                            </button>
                            
                            <div class="drawing-separator"></div>
                            
                            <input type="color" value="${currentColor}" onchange="setDrawingColor(this.value)" class="drawing-color-picker" title="Selector de color">
                            
                            <div class="drawing-slider-container" onmousedown="event.stopPropagation()" onmouseup="event.stopPropagation()" onmousemove="event.stopPropagation()">
                                <input type="range" min="1" max="50" value="${currentSize}" onchange="setDrawingSize(this.value)" oninput="setDrawingSize(this.value)" class="drawing-slider" title="Tama√±o del pincel">
                            </div>
                            <div class="drawing-size-display">${currentSize}px</div>
                            
                            <div class="drawing-separator"></div>
                            
                            <button class="drawing-tool" onclick="undoDrawing(this)" title="Deshacer (Ctrl+Z)" id="undoBtn">
                                ‚Ü∂
                                <div class="drawing-tool-tooltip">Deshacer (Ctrl+Z)</div>
                            </button>
                            <button class="drawing-tool" onclick="clearDrawing(this)" title="Limpiar Canvas">
                                üóëÔ∏è
                                <div class="drawing-tool-tooltip">Limpiar</div>
                            </button>
                            <button class="drawing-tool" onclick="showDrawingHelp()" title="Ayuda de atajos (H)">
                                ‚ùì
                                <div class="drawing-tool-tooltip">Ayuda (H)</div>
                            </button>
                        </div>
                        
                        <div class="drawing-toolbar-row">
                            <div class="drawing-color-palette">${colorPaletteHtml}</div>
                        </div>
                    `;
                    
                    // Ensamblar el contenedor
                    drawingContainer.appendChild(toolbar);
                    drawingContainer.appendChild(drawingCanvas);
                    
                    // Configurar funcionalidad de dibujo
                    setupAdvancedDrawing(drawingCanvas);
                    setupToolbarEvents(toolbar);
                    
                    // Restaurar el contenido del canvas si existe
                    if (data.content.canvasData) {
                        const ctx = drawingCanvas.getContext('2d');
                        const img = new Image();
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0);
                            // Guardar estado inicial para el historial
                            setTimeout(() => {
                                saveDrawingState(drawingCanvas);
                            }, 100);
                        };
                        img.src = data.content.canvasData;
                    }
                    
                    return drawingContainer;
            }
            return null;
        }

        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el proyecto "${project.name}"? üòø\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            projects = projects.filter(p => p.id !== projectId);
            
            // Si era el proyecto activo, cambiar a otro
            if (currentProject && currentProject.id === projectId) {
                if (projects.length > 0) {
                    switchToProject(projects[0].id);
                } else {
                    createDefaultProject();
                }
            }
            
            saveProjects();
            renderProjectsList();
        }

        function renameProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newName = prompt('üê± Nuevo nombre del proyecto:', project.name);
            if (!newName || newName.trim() === project.name) return;
            
            project.name = newName.trim();
            project.lastModified = new Date().toISOString();
            
            saveProjects();
            renderProjectsList();
        }

        function duplicateProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newProject = {
                ...project,
                id: 'project_' + Date.now(),
                name: project.name + ' (Copia)',
                created: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                isActive: false
            };
            
            projects.push(newProject);
            saveProjects();
            renderProjectsList();
            
            if (confirm(`Proyecto "${newProject.name}" creado. ¬øQuieres cambiar a √©l? üê±`)) {
                switchToProject(newProject.id);
            }
        }

        function renderProjectsList() {
            const projectsList = document.getElementById('projectsList');
            if (!projectsList) return;
            
            projectsList.innerHTML = '';
            
            projects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = `project-item ${project.isActive ? 'active' : ''}`;
                
                const lastModified = new Date(project.lastModified);
                const timeAgo = getTimeAgo(lastModified);
                const elementsCount = project.data ? (project.data.elements ? project.data.elements.length : 0) : 0;
                
                projectItem.innerHTML = `
                    <div class="project-emoji">${project.emoji}</div>
                    <div class="project-info">
                        <div class="project-name">${project.name}</div>
                        <div class="project-meta">
                            <span>${elementsCount} elementos</span>
                            <span>${timeAgo}</span>
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="action-btn" onclick="renameProject('${project.id}')" title="Renombrar">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="duplicateProject('${project.id}')" title="Duplicar">üìã</button>
                        <button class="action-btn" onclick="deleteProject('${project.id}')" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `;
                
                projectItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-btn') || e.target.closest('.action-btn')) return;
                    if (!project.isActive) {
                        switchToProject(project.id);
                    }
                });
                
                projectsList.appendChild(projectItem);
            });
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'ahora';
            if (diff < 3600) return `${Math.floor(diff / 60)}m`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)}d`;
            return date.toLocaleDateString();
        }

        function saveProjects() {
            localStorage.setItem('meoword-projects', JSON.stringify(projects));
        }

        function loadProjects() {
            const saved = localStorage.getItem('meoword-projects');
            if (saved) {
                try {
                    projects = JSON.parse(saved);
                    // Actualizar el contador de IDs
                    const maxId = Math.max(...projects.map(p => {
                        const match = p.id.match(/project_(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    }));
                    projectIdCounter = maxId + 1;
                } catch (e) {
                    console.error('Error loading projects:', e);
                    projects = [];
                }
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                renderProjectsList();
                // Actualizar selecci√≥n de color en el picker
                if (currentProject) {
                    updateColorPickerSelection(currentProject.color);
                }
                sidebarToggle.textContent = '‚úï';
            } else {
                sidebarToggle.textContent = 'üóÇÔ∏è';
            }
        }

        function updateProjectTheme(color) {
            // Obtener el tema actual
            const currentTheme = getCurrentTheme();
            
            // Generar gradiente din√°mico basado en el color seleccionado y tema
            const gradient = generateProjectGradient(color, currentTheme);
            
            // Actualizar variables CSS
            const root = document.documentElement;
            root.style.setProperty('--project-color', color);
            root.style.setProperty('--project-bg-gradient', gradient);
            
            // Actualizar color selector en la sidebar
            updateColorPickerSelection(color);
        }

        function generateProjectGradient(baseColor, theme = 'light') {
            // Definir gradientes por tema y color
            const themeGradients = {
                light: {
                    '#FFB6D9': 'linear-gradient(135deg, #FFC4D6 0%, #FF9DB8 30%, #DEB3F0 70%, #C285D1 100%)', // Rosa
                    '#D4A5FF': 'linear-gradient(135deg, #DEB3F0 0%, #C285D1 30%, #B8E6D3 70%, #9EDDC0 100%)', // P√∫rpura
                    '#A8E6CF': 'linear-gradient(135deg, #B8E6D3 0%, #9EDDC0 30%, #C4F0E8 70%, #F0FFF0 100%)', // Verde
                    '#FFE4E6': 'linear-gradient(135deg, #FFEAF0 0%, #FFC4D6 30%, #FF9DB8 70%, #DEB3F0 100%)', // Rosa claro
                    '#87CEEB': 'linear-gradient(135deg, #A8CEEB 0%, #C4F0E8 30%, #B8E6D3 70%, #9EDDC0 100%)', // Azul cielo
                    '#FFD700': 'linear-gradient(135deg, #FFF5D6 0%, #FFE8A6 30%, #FFC4D6 70%, #FF9DB8 100%)', // Dorado
                    '#FF8FA3': 'linear-gradient(135deg, #FF9DB8 0%, #FFC4D6 30%, #DEB3F0 70%, #C285D1 100%)', // Coral
                    '#B2F7EF': 'linear-gradient(135deg, #C4F0E8 0%, #B8E6D3 30%, #9EDDC0 70%, #A8CEEB 100%)', // Turquesa
                    '#F3FFE3': 'linear-gradient(135deg, #F0FFF0 0%, #B8E6D3 30%, #9EDDC0 70%, #C4F0E8 100%)', // Verde claro
                    '#DDA0DD': 'linear-gradient(135deg, #E8D4F1 0%, #DEB3F0 30%, #C285D1 70%, #FF9DB8 100%)'  // Lavanda
                },
                dark: {
                    '#FFB6D9': 'linear-gradient(135deg, #4a1e3a 0%, #2d1b69 30%, #1a1a2e 70%, #16213e 100%)', // Rosa oscuro
                    '#D4A5FF': 'linear-gradient(135deg, #3d2a5c 0%, #2d1b69 30%, #1a2e3a 70%, #16213e 100%)', // P√∫rpura oscuro
                    '#A8E6CF': 'linear-gradient(135deg, #1a3d2e 0%, #1a2e3a 30%, #16213e 70%, #1a1a2e 100%)', // Verde oscuro
                    '#FFE4E6': 'linear-gradient(135deg, #4a1e2e 0%, #3d1a3a 30%, #2d1b69 70%, #1a1a2e 100%)', // Rosa claro oscuro
                    '#87CEEB': 'linear-gradient(135deg, #1a2e5c 0%, #16213e 30%, #1a3d2e 70%, #1a2e3a 100%)', // Azul oscuro
                    '#FFD700': 'linear-gradient(135deg, #5c4a1a 0%, #4a3d1e 30%, #4a1e3a 70%, #2d1b69 100%)', // Dorado oscuro
                    '#FF8FA3': 'linear-gradient(135deg, #5c1a3a 0%, #4a1e3a 30%, #3d2a5c 70%, #2d1b69 100%)', // Coral oscuro
                    '#B2F7EF': 'linear-gradient(135deg, #1a5c4a 0%, #1a3d2e 30%, #1a2e3a 70%, #16213e 100%)', // Turquesa oscuro
                    '#F3FFE3': 'linear-gradient(135deg, #2e5c1a 0%, #1a3d2e 30%, #1a2e3a 70%, #16213e 100%)', // Verde claro oscuro
                    '#DDA0DD': 'linear-gradient(135deg, #5c3d5c 0%, #4a2e4a 30%, #3d2a5c 70%, #2d1b69 100%)'  // Lavanda oscuro
                },
                midnight: {
                    '#FFB6D9': 'linear-gradient(135deg, #001845 0%, #003d82 30%, #004e92 70%, #0066cc 100%)', // Rosa medianoche
                    '#D4A5FF': 'linear-gradient(135deg, #001a45 0%, #002d82 30%, #004e92 70%, #0066cc 100%)', // P√∫rpura medianoche
                    '#A8E6CF': 'linear-gradient(135deg, #002845 0%, #003d66 30%, #004e92 70%, #0066cc 100%)', // Verde medianoche
                    '#FFE4E6': 'linear-gradient(135deg, #001238 0%, #002d66 30%, #004482 70%, #0066cc 100%)', // Rosa claro medianoche
                    '#87CEEB': 'linear-gradient(135deg, #000f45 0%, #002882 30%, #004e92 70%, #0066cc 100%)', // Azul medianoche
                    '#FFD700': 'linear-gradient(135deg, #003345 0%, #004466 30%, #005582 70%, #0066cc 100%)', // Dorado medianoche
                    '#FF8FA3': 'linear-gradient(135deg, #001f45 0%, #003566 30%, #004882 70%, #0066cc 100%)', // Coral medianoche
                    '#B2F7EF': 'linear-gradient(135deg, #002f45 0%, #004066 30%, #005282 70%, #0066cc 100%)', // Turquesa medianoche
                    '#F3FFE3': 'linear-gradient(135deg, #003845 0%, #004566 30%, #005582 70%, #0066cc 100%)', // Verde claro medianoche
                    '#DDA0DD': 'linear-gradient(135deg, #002245 0%, #003366 30%, #004882 70%, #0066cc 100%)'  // Lavanda medianoche
                },
                neon: {
                    '#FFB6D9': 'linear-gradient(135deg, #2d1b69 0%, #1a0b2e 30%, #0f0f23 70%, #1a1a2e 100%)', // Rosa ne√≥n
                    '#D4A5FF': 'linear-gradient(135deg, #3d1b69 0%, #2a0b3e 30%, #1f0f33 70%, #2a1a3e 100%)', // P√∫rpura ne√≥n
                    '#A8E6CF': 'linear-gradient(135deg, #1b4d39 0%, #0b2e1a 30%, #0f2318 70%, #1a2e26 100%)', // Verde ne√≥n
                    '#FFE4E6': 'linear-gradient(135deg, #4d1b39 0%, #3e0b2a 30%, #330f1f 70%, #3e1a2a 100%)', // Rosa claro ne√≥n
                    '#87CEEB': 'linear-gradient(135deg, #1b394d 0%, #0b1a2e 30%, #0f1823 70, #1a262e 100%)', // Azul ne√≥n
                    '#FFD700': 'linear-gradient(135deg, #4d391b 0%, #3e2a0b 30%, #33230f 70%, #3e2e1a 100%)', // Dorado ne√≥n
                    '#FF8FA3': 'linear-gradient(135deg, #5d1b39 0%, #4e0b2a 30%, #431f33 70%, #4e2a3e 100%)', // Coral ne√≥n
                    '#B2F7EF': 'linear-gradient(135deg, #1b5d4d 0%, #0b3e2a 30%, #0f3323 70%, #1a3e2e 100%)', // Turquesa ne√≥n
                    '#F3FFE3': 'linear-gradient(135deg, #395d1b 0%, #2a3e0b 30%, #23330f 70%, #2e3e1a 100%)', // Verde claro ne√≥n
                    '#DDA0DD': 'linear-gradient(135deg, #5d395d 0%, #4e2a4e 30%, #432343 70%, #4e3a4e 100%)'  // Lavanda ne√≥n
                }
            };
            
            const currentThemeGradients = themeGradients[theme] || themeGradients.light;
            return currentThemeGradients[baseColor] || `linear-gradient(135deg, ${baseColor} 0%, #333 50%, #111 100%)`;
        }

        function updateColorPickerSelection(selectedColor) {
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                if (option.dataset.color === selectedColor) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function setupColorPicker() {
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    if (!currentProject) return;
                    
                    // Remover selecci√≥n anterior
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Seleccionar nuevo color
                    option.classList.add('selected');
                    const newColor = option.dataset.color;
                    
                    // Actualizar proyecto
                    currentProject.color = newColor;
                    currentProject.lastModified = new Date().toISOString();
                    
                    saveProjects();
                    renderProjectsList();
                    updateProjectTheme(newColor);
                });
            });
        }

        // ====== THEME MANAGEMENT ======
        let currentTheme = 'light';

        function setTheme(themeName) {
            // Remover clases de tema anteriores
            document.body.classList.remove('dark-theme', 'midnight-theme', 'neon-theme');
            
            // Aplicar nuevo tema
            if (themeName !== 'light') {
                document.body.classList.add(themeName + '-theme');
            }
            
            // Establecer gradiente por defecto para el tema
            setDefaultThemeGradient(themeName);
            
            // Actualizar botones de tema
            const themeButtons = document.querySelectorAll('.theme-btn');
            themeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });
            
            // Guardar tema en localStorage
            currentTheme = themeName;
            localStorage.setItem('meowboard_theme', themeName);
            
            // Actualizar el proyecto actual si existe
            if (currentProject) {
                currentProject.theme = themeName;
                // Actualizar el fondo del proyecto con el nuevo tema
                if (currentProject.color) {
                    updateProjectTheme(currentProject.color);
                }
                saveProjects();
            }
            
            // Mostrar notificaci√≥n
            const themeNames = {
                'light': '‚òÄÔ∏è Tema Claro',
                'dark': 'üåô Tema Oscuro', 
                'midnight': 'üåÉ Tema Medianoche',
                'neon': 'üí´ Tema Ne√≥n'
            };
            
            showProjectSwitchMessage(`${themeNames[themeName]} activado! üé® Puedes cambiar los colores de fondo en la barra lateral`);
        }

        function setDefaultThemeGradient(themeName) {
            const defaultGradients = {
                'light': 'linear-gradient(135deg, #FFC4D6 0%, #DEB3F0 50%, #B8E6D3 100%)',
                'dark': 'linear-gradient(135deg, #2d1b69 0%, #1a1a2e 50%, #16213e 100%)',
                'midnight': 'linear-gradient(135deg, #000428 0%, #004e92 100%)',
                'neon': 'linear-gradient(135deg, #0f0f23 0%, #1a0b2e 50%, #2d1b69 100%)'
            };
            
            const gradient = defaultGradients[themeName] || defaultGradients.light;
            document.documentElement.style.setProperty('--project-bg-gradient', gradient);
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('meowboard_theme') || 'light';
            setTheme(savedTheme);
        }

        function initializeThemeSelector() {
            // Cargar tema guardado al inicializar
            loadSavedTheme();
            
            // Si hay un proyecto actual con tema, usarlo
            if (currentProject && currentProject.theme) {
                setTheme(currentProject.theme);
            }
        }

        function showProjectSwitchMessage(projectName) {
            const message = document.createElement('div');
            message.textContent = `üìÇ Cambiado a: ${projectName} üê±`;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(45deg, #A8E6CF, #81E6D9);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-family: 'Comfortaa', cursive;
                font-weight: 600;
                z-index: 3000;
                box-shadow: 0 4px 15px rgba(168, 230, 207, 0.4);
                animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            `;
            
            // Agregar animaciones CSS si no existen
            if (!document.querySelector('#projectMessageStyles')) {
                const styles = document.createElement('style');
                styles.id = 'projectMessageStyles';
                styles.textContent = `
                    @keyframes slideDown {
                        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 3000);
        }

        function showNotificationMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.textContent = text;
            
            let bgColor, emoji;
            switch(type) {
                case 'success':
                    bgColor = 'linear-gradient(45deg, #4CAF50, #45a049)';
                    emoji = '‚úÖ';
                    break;
                case 'error':
                    bgColor = 'linear-gradient(45deg, #ff6b6b, #ff5252)';
                    emoji = '‚ùå';
                    break;
                case 'info':
                    bgColor = 'linear-gradient(45deg, #87CEEB, #6BB6E3)';
                    emoji = '‚ÑπÔ∏è';
                    break;
                default:
                    bgColor = 'linear-gradient(45deg, #FFB6D9, #FF8FA3)';
                    emoji = 'üê±';
            }
            
            message.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 15px;
                font-family: 'Comfortaa', cursive;
                font-weight: 500;
                font-size: 14px;
                z-index: 3000;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease, fadeOutRight 0.3s ease 2.7s forwards;
                max-width: 350px;
                word-wrap: break-word;
            `;
            
            message.innerHTML = `${emoji} ${text}`;
            
            // Agregar animaciones CSS para notificaciones si no existen
            if (!document.querySelector('#notificationStyles')) {
                const styles = document.createElement('style');
                styles.id = 'notificationStyles';
                styles.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOutRight {
                        to { opacity: 0; transform: translateX(50px); }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 3000);
        }

        // Autoguardado inteligente con debounce
        function autoSave() {
            if (!isAutoSaveEnabled) return;
            
            // Cancelar timeout anterior si existe
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            // Programar guardado despu√©s de 500ms de inactividad
            autoSaveTimeout = setTimeout(() => {
                saveBoard(true); // true indica que es autoguardado
                showAutoSaveIndicator();
            }, 500);
        }
        
        function showAutoSaveIndicator() {
            // Crear indicador visual de autoguardado
            const indicator = document.createElement('div');
            indicator.innerHTML = 'üíæ Guardado autom√°ticamente';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #45A049);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                pointer-events: none;
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            `;
            
            document.body.appendChild(indicator);
            
            // Animar entrada
            setTimeout(() => {
                indicator.style.opacity = '1';
                indicator.style.transform = 'translateY(0)';
            }, 10);
            
            // Animar salida despu√©s de 2 segundos
            setTimeout(() => {
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 300);
            }, 2000);
        }

        // Guardar y cargar
        function saveBoard(isAutoSave = false) {
            // Si tenemos sistema de proyectos, guardar en el proyecto actual
            if (currentProject) {
                saveCurrentProjectData();
                saveProjects();
                if (!isAutoSave) {
                    showSaveMessage();
                }
                return;
            }
            
            // Fallback para compatibilidad con el sistema anterior
            const elements = [];
            
            canvas.querySelectorAll('.sticky-note, .text-block, .image-card, .link-card, .audio-note, .video-note, .drawing-container').forEach(element => {
                const data = {
                    type: element.className.split(' ')[0],
                    left: element.style.left,
                    top: element.style.top,
                    width: element.style.width,
                    height: element.style.height,
                    html: element.innerHTML
                };
                elements.push(data);
            });
            
            localStorage.setItem('meoword-board', JSON.stringify(elements));
            
            // Mostrar mensaje de guardado solo si no es autoguardado
            if (!isAutoSave) {
                showSaveMessage();
            }
        }

        function loadBoard() {
            // Esta funci√≥n ahora es principalmente para compatibilidad con datos anteriores
            // El sistema de proyectos maneja la carga directamente
            const saved = localStorage.getItem('meoword-board');
            if (saved && !projects.length) {
                // Migrar datos antiguos al nuevo sistema de proyectos
                migrateOldDataToProjects(saved);
            }
        }

        function migrateOldDataToProjects(savedData) {
            try {
                const elements = JSON.parse(savedData);
                if (elements.length > 0) {
                    // Crear un proyecto con los datos antiguos
                    const migratedProject = {
                        id: 'migrated_' + Date.now(),
                        name: 'Proyecto Migrado',
                        emoji: 'üì¶',
                        color: '#FFB6D9',
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        isActive: true,
                        data: {
                            elements: elements.map(data => ({
                                type: data.type,
                                left: data.left,
                                top: data.top,
                                width: data.width,
                                height: data.height,
                                content: extractContentFromHTML(data.html, data.type)
                            })),
                            zoom: 1,
                            pan: { x: 0, y: 0 }
                        }
                    };
                    
                    projects = [migratedProject];
                    currentProject = migratedProject;
                    saveProjects();
                    
                    // Limpiar datos antiguos
                    localStorage.removeItem('meoword-board');
                    
                    console.log('‚úÖ Datos migrados al nuevo sistema de proyectos');
                }
            } catch (e) {
                console.error('‚ùå Error migrando datos:', e);
            }
        }

        function extractContentFromHTML(html, type) {
            // Crear elemento temporal para extraer contenido
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            if (type === 'sticky-note') {
                const textarea = temp.querySelector('textarea');
                const emoji = temp.querySelector('.note-emoji');
                const colorClass = temp.className.split(' ')[1];
                return {
                    text: textarea ? textarea.value : '',
                    emoji: emoji ? emoji.textContent : 'üê±',
                    color: colorClass || 'yellow'
                };
            } else if (type === 'text-block') {
                const h3 = temp.querySelector('h3');
                const p = temp.querySelector('p');
                return {
                    title: h3 ? h3.textContent : '',
                    content: p ? p.textContent : ''
                };
            } else if (type === 'image-card') {
                const img = temp.querySelector('img');
                return {
                    src: img ? img.src : '',
                    alt: img ? img.alt : ''
                };
            } else if (type === 'link-card') {
                const h4 = temp.querySelector('h4');
                const p = temp.querySelector('p');
                return {
                    title: h4 ? h4.textContent : '',
                    description: p ? p.textContent : '',
                    url: '' // Extraer de donde est√© almacenado
                };
            }
            return {};
        }

        function showSaveMessage() {
            const message = document.createElement('div');
            message.textContent = 'üíæ ¬°Guardado! üê±';
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #A8E6CF, #81E6D9);
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                font-family: 'Comfortaa', cursive;
                font-weight: 500;
                box-shadow: 0 4px 15px rgba(168, 230, 207, 0.4);
                z-index: 3000;
                animation: bounce 0.5s ease;
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 2000);
        }

        // ====== NUEVAS FUNCIONALIDADES ======

        // Sistema de Pesta√±as
        function switchTab(tabName) {
            // Manejar colaboraci√≥n de forma especial
            if (tabName === 'collab') {
                if (!currentUser) {
                    showAuthModal();
                } else {
                    shareProject();
                }
                return;
            }
            
            // Remover active de todos los tabs y toolbars
            document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.toolbar-section').forEach(toolbar => toolbar.classList.remove('active'));
            
            // Activar el tab seleccionado
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`toolbar-${tabName}`).classList.add('active');
        }

        // ====== AUDIO & VIDEO ======
        function addAudioNote() {
            const audioNote = document.createElement('div');
            audioNote.className = 'audio-note';
            
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            audioNote.style.left = (viewportCenterX - 100 + Math.random() * 200) + 'px';
            audioNote.style.top = (viewportCenterY - 50 + Math.random() * 100) + 'px';
            
            const audioId = 'audio_' + Date.now();
            
            audioNote.innerHTML = `
                <div class="audio-controls">
                    <button class="audio-btn record-btn" onclick="toggleRecording('${audioId}')" title="Grabar">üé§</button>
                    <button class="audio-btn play-btn" onclick="playAudio('${audioId}')" title="Reproducir" disabled>‚ñ∂Ô∏è</button>
                    <div class="waveform" id="waveform-${audioId}"></div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="status-${audioId}">Haz clic en üé§ para grabar</span>
                </div>
                <button class="note-close" onclick="removeElement(this.parentElement)" style="position: absolute; top: 5px; right: 5px;">√ó</button>
            `;
            
            audioNote.dataset.audioId = audioId;
            canvas.appendChild(audioNote);
            makeDraggable(audioNote);
            audioNote.classList.add('wiggle');
            autoSave();
        }

        function toggleRecording(audioId) {
            const button = document.querySelector(`[onclick="toggleRecording('${audioId}')"]`);
            const status = document.getElementById(`status-${audioId}`);
            
            if (!isRecording) {
                startRecording(audioId, button, status);
            } else {
                stopRecording(audioId, button, status);
            }
        }

        function startRecording(audioId, button, status) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Guardar el audio en el elemento
                        const audioNote = button.closest('.audio-note');
                        audioNote.dataset.audioUrl = audioUrl;
                        
                        // Habilitar bot√≥n de play
                        const playBtn = audioNote.querySelector('.play-btn');
                        playBtn.disabled = false;
                        
                        status.textContent = 'Grabaci√≥n lista para reproducir üéµ';
                        autoSave();
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    button.classList.add('recording');
                    button.textContent = '‚èπÔ∏è';
                    status.textContent = 'Grabando... üî¥';
                    
                    // Generar waveform animado
                    animateWaveform(audioId);
                })
                .catch(err => {
                    console.error('Error accessing microphone:', err);
                    status.textContent = 'Error: No se pudo acceder al micr√≥fono';
                });
        }

        function stopRecording(audioId, button, status) {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                button.classList.remove('recording');
                button.textContent = 'üé§';
                status.textContent = 'Procesando grabaci√≥n...';
            }
        }

        function playAudio(audioId) {
            const audioNote = document.querySelector(`[data-audio-id="${audioId}"]`);
            const audioUrl = audioNote.dataset.audioUrl;
            
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audio.play();
                
                const status = document.getElementById(`status-${audioId}`);
                status.textContent = 'Reproduciendo... üéµ';
                
                audio.onended = () => {
                    status.textContent = 'Grabaci√≥n lista para reproducir üéµ';
                };
            }
        }

        function animateWaveform(audioId) {
            const waveform = document.getElementById(`waveform-${audioId}`);
            if (!waveform || !isRecording) return;
            
            // Crear barras de onda
            if (waveform.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'wave-bar';
                    bar.style.left = (i * 4) + 'px';
                    waveform.appendChild(bar);
                }
            }
            
            // Animar barras
            Array.from(waveform.children).forEach(bar => {
                const height = Math.random() * 25 + 5;
                bar.style.height = height + 'px';
            });
            
            if (isRecording) {
                setTimeout(() => animateWaveform(audioId), 100);
            }
        }

        function showVideoModal() {
            document.getElementById('videoModal').style.display = 'flex';
        }

        function addVideoFromModal(event) {
            event.preventDefault();
            const url = document.getElementById('videoUrl').value;
            const width = document.getElementById('videoWidth').value;
            const height = document.getElementById('videoHeight').value;
            
            createVideoElement(url, width, height);
            closeModal('videoModal');
        }

        function createVideoElement(url, width, height) {
            const videoNote = document.createElement('div');
            videoNote.className = 'video-note';
            
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            videoNote.style.left = (viewportCenterX - parseInt(width)/2) + 'px';
            videoNote.style.top = (viewportCenterY - parseInt(height)/2) + 'px';
            videoNote.style.width = width + 'px';
            videoNote.style.height = height + 'px';
            
            // Convertir URL de YouTube/Vimeo a embed
            const embedUrl = convertToEmbedUrl(url);
            
            // Extraer t√≠tulo del video desde la URL
            let videoTitle = 'üé• Video';
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                videoTitle = 'üé• YouTube';
            } else if (url.includes('vimeo.com')) {
                videoTitle = 'üé• Vimeo';
            } else if (url.includes('.mp4') || url.includes('.webm') || url.includes('.mov')) {
                videoTitle = 'üé• Video Local';
            }
            
            videoNote.innerHTML = `
                <div class="video-header">
                    <span class="drag-icon">‚ãÆ‚ãÆ</span>
                    <span class="video-title">${videoTitle}</span>
                    <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                </div>
                <iframe src="${embedUrl}" width="100%" height="calc(100% - 25px)" frameborder="0" allowfullscreen style="margin-top: 25px;"></iframe>
            `;
            
            canvas.appendChild(videoNote);
            makeDraggable(videoNote);
            videoNote.classList.add('wiggle');
            autoSave();
        }

        function convertToEmbedUrl(url) {
            // YouTube
            if (url.includes('youtube.com/watch')) {
                const videoId = url.split('v=')[1].split('&')[0];
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (url.includes('youtu.be/')) {
                const videoId = url.split('youtu.be/')[1];
                return `https://www.youtube.com/embed/${videoId}`;
            }
            
            // Vimeo
            if (url.includes('vimeo.com/')) {
                const videoId = url.split('vimeo.com/')[1];
                return `https://player.vimeo.com/video/${videoId}`;
            }
            
            return url; // Si no es reconocido, usar tal como est√°
        }

        function showMusicModal() {
            document.getElementById('musicModal').style.display = 'flex';
        }

        function playAmbient(type) {
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic = null;
            }
            
            if (!type) return;
            
            // URLs de m√∫sica ambiente (usar servicios gratuitos o generar tonos)
            const ambientSounds = {
                rain: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBjWR2e/CeSsFLIHO8tiJOQcXhLbm2ZlWDwY0vMj12pU/CRhNtu3nplQTCFCn4/C2YxwHOJHX8sx5LAUkd8fw3ZBAChRetefrpVbQChKOR43al+gAHVIkBmsZChVTOPPJ8m3GLg5QvbvtrGrALiVJscOY0CPEJL3ixyF/HTglT+qzT0lvEYJwgJSryX0ogS2JzLDbhiRJSemxZ2vAKSVEuMOb0iVWL4zdxyJ+GXclQs3HOnjTOyFLsOWpTEhqDn9vf5etxXofeOkZGT8sSs6xb2fCJSVFveCZ0SRTMZDfxSB8GTcpP8vHOXjUOSJKr+WuS0VtEX5vgJatzXsgeat0dIwRaH1atUtPLrSAJQLTzF9qzOtkwXQqOO3pRJQN2KvESXwpIDhJMO7lOiKLEWx5d4CTrMh8OOGrWyq4WI5Ks1UcEU53aZOO2lOoZhQbdDdQYiA3dlE7v3Q',
                forest: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBjWR2e/CeSsFLIHO8tiJOQcXhLbm2ZlWDwY0vMj12pU/CRhNtu3nplQTCFCn4/C2YxwHOJHX8sx5LAUkd8fw3ZBAChRetefrpVYSCUeNy5foAB1SJAZrGQoUUzj0yfJtxi4OUL268axqwC4lSrHDmNAjxCS94schfh04JU/qs09JbxGCcICUq8h9KIEtiMux3YYkSUnosWdrwCklRLnDm9IlVi+P3cciexl3JULP',
                ocean: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBjWR2e/CeSsFLIHO8tiJOQcXhLbm2ZlWDwY0vMj12pU/CRhNtu3nplQTCFCn4/C2YxwHOJHX8sx5LAUkd8fw3ZBAChRetefrpVYSCUeNz5foAB1SJAZrGQoVUzj0yfJtxi4OUL268axqwC4lSrHDmNAjxCS94schfh04JU/qs09JbxGCcICUq8h9KIEtiMuw3YYkSUn',
                cafe: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBjWR2e/CeSsFLIHO8tiJOQcXhLbm2ZlWDwY0vMj12pU/CRhNtu3nplQTCFCn4/C2YxwHOJHX8sx5LAUkd8fw3ZBAChRetern66VWEglHjc+X6AAdUiQGaxkKFVM59Mnybccu',
                'lo-fi': 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBjWR2e/CeSsFLIHO8tiJOQcXhLbm2ZlWDwY0vMj12pU/CRhNtu3nplQTCFCn4/C2YxwHOJHX8sx5LAUkd8fw3ZBAChReten66VWEglHjc+X6A'
            };
            
            if (ambientSounds[type]) {
                backgroundMusic = new Audio(ambientSounds[type]);
                backgroundMusic.loop = true;
                backgroundMusic.volume = musicVolume;
                backgroundMusic.play();
                
                // Mostrar mensaje
                showProjectSwitchMessage(`üéµ Reproduciendo: ${type}`);
            }
        }

        function setMusicVolume(value) {
            musicVolume = value / 100;
            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume;
            }
        }

        function toggleTranscription() {
            // Verificar compatibilidad de navegadores
            const isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
            const isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = navigator.userAgent.indexOf("Edg") > -1;

            // Mostrar mensaje "Trabajando en ello" para Opera GX y Firefox
            if (isOpera || isFirefox) {
                showWorkingOnItMessage();
                return;
            }

            // Verificar Web Speech API para navegadores compatibles
            const hasWebSpeechAPI = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
            
            if (!hasWebSpeechAPI) {
                showNotificationMessage('‚ùå Tu navegador no soporta reconocimiento de voz. Usa Chrome, Edge o Safari.', 'error');
                return;
            }

            if (isTranscribing) {
                stopTranscription();
            } else {
                startTranscription();
            }
        }

        function showTranscriptionAlternative(browserName, instruction) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 500px;
                    color: white;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 20px 0; font-size: 24px;">
                        üé§ Transcripci√≥n en ${browserName}
                    </h3>
                    <p style="margin: 0 0 20px 0; line-height: 1.6;">
                        ${instruction}
                    </p>
                    <div style="margin: 20px 0;">
                        <h4 style="color: #FFE082;">üí° Alternativas disponibles:</h4>
                        <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>üó£Ô∏è Usa el dictado por voz del sistema (Windows Key + H)</li>
                            <li>üì± Transcribe desde tu tel√©fono y copia el texto</li>
                            <li>üéôÔ∏è Graba audio y transcribe externamente</li>
                            <li>‚å®Ô∏è Escribe directamente en la nota</li>
                        </ul>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        ‚úÖ Entendido
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Crear nota manual como alternativa
            setTimeout(() => {
                createManualTranscriptionNote();
            }, 100);
        }

        function createManualTranscriptionNote() {
            const noteId = 'note_' + Date.now();
            const noteElement = document.createElement('div');
            noteElement.className = 'note manual-transcription-note';
            noteElement.id = noteId;
            
            noteElement.innerHTML = `
                <div class="note-header">
                    <span class="note-emoji">üé§</span>
                    <button class="note-delete-btn" onclick="deleteNote('${noteId}')">√ó</button>
                </div>
                <textarea placeholder="‚úçÔ∏è Escribe aqu√≠ tu transcripci√≥n manual o usa el dictado del sistema (Windows Key + H)..." 
                          style="background: rgba(255, 193, 7, 0.1) !important; border-left: 4px solid #FFC107;"></textarea>
            `;
            
            // Posicionar la nota
            const rect = notesContainer.getBoundingClientRect();
            const x = Math.random() * (rect.width - 250);
            const y = Math.random() * (rect.height - 200);
            
            noteElement.style.left = x + 'px';
            noteElement.style.top = y + 'px';
            
            notesContainer.appendChild(noteElement);
            
            // Auto-guardado
            const textarea = noteElement.querySelector('textarea');
            textarea.addEventListener('input', autoSave);
            textarea.focus();
            
            showNotificationMessage('üìù Nota de transcripci√≥n manual creada. Usa Windows Key + H para dictado del sistema.', 'info');
        }

        function showWorkingOnItMessage() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 40px;
                    border-radius: 20px;
                    max-width: 500px;
                    color: white;
                    text-align: center;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.4);
                    border: 2px solid rgba(255,255,255,0.2);
                ">
                    <h3 style="margin: 0 0 25px 0; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        üöß Trabajando en ello
                    </h3>
                    
                    <p style="margin: 0 0 30px 0; font-size: 18px; line-height: 1.6;">
                        Si quieres usar esta funci√≥n, recomendamos usar <strong>Google Chrome</strong>, <strong>Microsoft Edge</strong> o <strong>Safari</strong>.
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4 style="color: #FFE082; margin: 0 0 15px 0;">‚úÖ Navegadores compatibles:</h4>
                        <div style="display: flex; justify-content: space-around; align-items: center; margin: 15px 0;">
                            <div style="text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s ease;" 
                                 onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1.1)'" 
                                 onmouseout="this.style.background=''; this.style.transform='scale(1)'"
                                 onclick="openMeowboardInBrowser('chrome')">
                                <div style="font-size: 32px; margin-bottom: 5px;">üîç</div>
                                <div style="font-size: 14px; font-weight: bold;">Chrome</div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 3px;">Haz clic para abrir</div>
                            </div>
                            <div style="text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s ease;" 
                                 onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1.1)'" 
                                 onmouseout="this.style.background=''; this.style.transform='scale(1)'"
                                 onclick="openMeowboardInBrowser('edge')">
                                <div style="font-size: 32px; margin-bottom: 5px;">üåä</div>
                                <div style="font-size: 14px; font-weight: bold;">Edge</div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 3px;">Haz clic para abrir</div>
                            </div>
                            <div style="text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s ease;" 
                                 onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1.1)'" 
                                 onmouseout="this.style.background=''; this.style.transform='scale(1)'"
                                 onclick="openMeowboardInBrowser('safari')">
                                <div style="font-size: 32px; margin-bottom: 5px;">üß≠</div>
                                <div style="font-size: 14px; font-weight: bold;">Safari</div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 3px;">Haz clic para abrir</div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        ‚úÖ Entendido
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function openMeowboardInBrowser(browserType) {
            // Obtener la URL actual de Meowboard
            const currentUrl = window.location.href;
            
            // Detectar sistema operativo
            const isWindows = navigator.platform.indexOf('Win') !== -1;
            const isMac = navigator.platform.indexOf('Mac') !== -1;
            const isLinux = navigator.platform.indexOf('Linux') !== -1;
            
            // Comandos espec√≠ficos por navegador y sistema operativo
            const browserCommands = {
                chrome: {
                    name: 'Google Chrome',
                    icon: 'üîç',
                    downloadUrl: 'https://www.google.com/chrome/',
                    windows: `start chrome "${currentUrl}"`,
                    mac: `open -a "Google Chrome" "${currentUrl}"`,
                    linux: `google-chrome "${currentUrl}"`,
                    protocol: `googlechrome://${currentUrl.replace(/^https?:\/\//, '')}`
                },
                edge: {
                    name: 'Microsoft Edge',
                    icon: 'üåä',
                    downloadUrl: 'https://www.microsoft.com/edge',
                    windows: `start msedge "${currentUrl}"`,
                    mac: `open -a "Microsoft Edge" "${currentUrl}"`,
                    linux: `microsoft-edge "${currentUrl}"`,
                    protocol: `microsoft-edge:${currentUrl}`
                },
                safari: {
                    name: 'Safari',
                    icon: 'üß≠',
                    downloadUrl: 'https://www.apple.com/safari/',
                    windows: null, // Safari no est√° disponible en Windows
                    mac: `open -a "Safari" "${currentUrl}"`,
                    linux: null, // Safari no est√° disponible en Linux
                    protocol: currentUrl
                }
            };

            const browser = browserCommands[browserType];
            
            if (!browser) {
                showNotificationMessage('‚ùå Navegador no reconocido', 'error');
                return;
            }

            try {
                // Intentar usar protocolos espec√≠ficos primero
                if (browserType === 'chrome') {
                    // Crear un enlace temporal para usar el protocolo de Chrome
                    const link = document.createElement('a');
                    link.href = browser.protocol;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotificationMessage(`${browser.icon} Abriendo ${browser.name}...`, 'success');
                    
                } else if (browserType === 'edge') {
                    // Usar protocolo de Edge
                    const link = document.createElement('a');
                    link.href = browser.protocol;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotificationMessage(`${browser.icon} Abriendo ${browser.name}...`, 'success');
                    
                } else if (browserType === 'safari') {
                    if (isMac) {
                        // Para Safari en Mac, usar window.open como fallback
                        const safariWindow = window.open(currentUrl, '_blank');
                        if (safariWindow) {
                            showNotificationMessage(`${browser.icon} Abriendo ${browser.name}...`, 'success');
                        } else {
                            throw new Error('No se pudo abrir Safari');
                        }
                    } else {
                        // Safari no disponible en Windows/Linux
                        showBrowserInstallModal({
                            ...browser,
                            instruction: 'Safari solo est√° disponible en macOS. Te recomendamos usar Chrome o Edge.'
                        }, currentUrl);
                        return;
                    }
                }
                
                // Mostrar instrucciones adicionales
                setTimeout(() => {
                    showBrowserOpenInstructions(browser, browserType);
                }, 1000);
                
            } catch (error) {
                console.log('Error al abrir navegador:', error);
                // Si falla, mostrar modal con instrucciones alternativas
                showBrowserInstallModal(browser, currentUrl);
            }
        }
        
        function showBrowserOpenInstructions(browser, browserType) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                max-width: 350px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10001;
                animation: slideInRight 0.3s ease;
            `;
            
            modal.innerHTML = `
                <h4 style="margin: 0 0 10px 0; font-size: 16px;">
                    ${browser.icon} ${browser.name} ${browserType === 'safari' && !navigator.platform.includes('Mac') ? 'no disponible' : 'abierto'}
                </h4>
                <p style="margin: 0 0 15px 0; font-size: 13px; line-height: 1.4;">
                    ${browserType === 'safari' && !navigator.platform.includes('Mac') 
                        ? 'Safari no est√° disponible en este sistema. Usa Chrome o Edge para la transcripci√≥n de voz.'
                        : `Si ${browser.name} no se abri√≥ autom√°ticamente, √°brelo manualmente y navega a Meowboard.`
                    }
                </p>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="navigator.clipboard.writeText('${window.location.href}'); showNotificationMessage('üìã URL copiada', 'success')" style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        üìã Copiar URL
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255,255,255,0.3);
                        border: none;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        ‚úÖ OK
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-remover despu√©s de 8 segundos
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 8000);
        }

        function showBrowserInstallModal(browser, url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                    padding: 40px;
                    border-radius: 20px;
                    max-width: 500px;
                    color: white;
                    text-align: center;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.4);
                    border: 2px solid rgba(255,255,255,0.2);
                ">
                    <h3 style="margin: 0 0 25px 0; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        ${browser.icon} ${browser.name}
                    </h3>
                    
                    <p style="margin: 0 0 20px 0; font-size: 16px; line-height: 1.6;">
                        ${browser.instruction}
                    </p>
                    
                    <div style="margin: 30px 0; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="window.open('${browser.downloadUrl}', '_blank')" style="
                            background: #FF6B6B;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üì• Descargar ${browser.name}
                        </button>
                        
                        <button onclick="navigator.clipboard.writeText('${url}'); showNotificationMessage('üîó URL copiada al portapapeles', 'success'); this.parentElement.parentElement.parentElement.remove();" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üìã Copiar URL
                        </button>
                    </div>
                    
                    <p style="font-size: 12px; opacity: 0.8; margin: 20px 0 10px 0;">
                        Una vez instalado ${browser.name}, podr√°s usar la transcripci√≥n de voz completa.
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: 2px solid rgba(255,255,255,0.5);
                        padding: 12px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ‚úÖ Cerrar
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showOperaGXSpeechSetup() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 50%, #ff4757 100%);
                    padding: 40px;
                    border-radius: 20px;
                    max-width: 600px;
                    color: white;
                    text-align: center;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.4);
                    border: 2px solid rgba(255,255,255,0.2);
                ">
                    <h3 style="margin: 0 0 25px 0; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        üéÆ Configuraci√≥n para Opera GX
                    </h3>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4 style="color: #FFE082; margin: 0 0 15px 0;">üîß Pasos para activar transcripci√≥n:</h4>
                        <ol style="text-align: left; line-height: 1.8; margin: 0; padding-left: 20px;">
                            <li><strong>Abre una nueva pesta√±a</strong></li>
                            <li><strong>Escribe:</strong> <code style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;">opera://flags</code></li>
                            <li><strong>Busca:</strong> "Experimental Web Platform"</li>
                            <li><strong>Activa:</strong> "Experimental Web Platform features"</li>
                            <li><strong>Reinicia Opera GX</strong></li>
                        </ol>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #FFE082;">üí° Alternativas mientras tanto:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <button onclick="createManualTranscriptionNote(); this.parentElement.parentElement.parentElement.remove();" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            ">
                                üìù Nota Manual
                            </button>
                            <button onclick="window.open('https://chrome.google.com/webstore/detail/voice-note-ii-speech-to-t/mjfjjijka/details', '_blank');" style="
                                background: #2196F3;
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            ">
                                üîå Extensi√≥n de Voz
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #FF6B6B;
                        color: white;
                        border: 2px solid white;
                        padding: 12px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        margin-top: 20px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='white'; this.style.color='#FF6B6B';" 
                       onmouseout="this.style.background='#FF6B6B'; this.style.color='white';">
                        ‚úÖ Cerrar
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function startTranscription() {
            try {
                // Detecci√≥n mejorada para Opera GX y otros navegadores
                const isOperaGX = navigator.userAgent.includes('OPR') || navigator.userAgent.includes('Opera');
                
                // Inicializar el reconocimiento de voz con soporte espec√≠fico
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    if (isOperaGX) {
                        showOperaGXSpeechSetup();
                        return;
                    }
                    throw new Error('API de reconocimiento de voz no disponible');
                }
                
                speechRecognition = new SpeechRecognition();
                
                // Configuraci√≥n espec√≠fica para Opera GX
                if (isOperaGX) {
                    // Opera GX necesita configuraciones m√°s espec√≠ficas
                    speechRecognition.continuous = false; // Menos continuo para mejor estabilidad
                    speechRecognition.maxAlternatives = 1;
                    showNotificationMessage('üéÆ Optimizado para Opera GX - Habla claramente', 'info');
                } else {
                    speechRecognition.continuous = true;
                }
                
                // Configurar el reconocimiento
                speechRecognition.continuous = true;  // Continuo
                speechRecognition.interimResults = true;  // Resultados parciales
                speechRecognition.lang = 'es-ES';  // Espa√±ol por defecto
                
                // Detectar idioma del navegador como fallback
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('en')) {
                    speechRecognition.lang = 'en-US';
                } else if (browserLang.startsWith('fr')) {
                    speechRecognition.lang = 'fr-FR';
                } else if (browserLang.startsWith('de')) {
                    speechRecognition.lang = 'de-DE';
                } else if (browserLang.startsWith('it')) {
                    speechRecognition.lang = 'it-IT';
                } else if (browserLang.startsWith('pt')) {
                    speechRecognition.lang = 'pt-BR';
                }

                // Crear nota de transcripci√≥n inicial
                createTranscriptionNote();
                
                // Eventos del reconocimiento
                speechRecognition.onstart = () => {
                    isTranscribing = true;
                    updateTranscriptionUI(true);
                    showNotificationMessage('üé§ Transcripci√≥n iniciada - ¬°Habla y tu voz se convertir√° en texto!', 'success');
                };

                speechRecognition.onresult = (event) => {
                    handleTranscriptionResult(event);
                };

                speechRecognition.onerror = (event) => {
                    console.error('Error en transcripci√≥n:', event.error);
                    handleTranscriptionError(event.error);
                };

                speechRecognition.onend = () => {
                    if (isTranscribing) {
                        // Reiniciar autom√°ticamente si a√∫n queremos transcribir
                        setTimeout(() => {
                            if (isTranscribing) {
                                speechRecognition.start();
                            }
                        }, 100);
                    }
                };

                // Iniciar reconocimiento
                speechRecognition.start();
                
            } catch (error) {
                console.error('Error al iniciar transcripci√≥n:', error);
                showNotificationMessage('‚ùå Error al iniciar la transcripci√≥n: ' + error.message, 'error');
            }
        }

        function stopTranscription() {
            if (speechRecognition) {
                isTranscribing = false;
                speechRecognition.stop();
                speechRecognition = null;
            }
            
            updateTranscriptionUI(false);
            
            if (currentTranscriptionNote) {
                // Finalizar la nota actual
                finalizeTranscriptionNote();
            }
            
            showNotificationMessage('‚èπÔ∏è Transcripci√≥n detenida', 'info');
        }

        function createTranscriptionNote() {
            // Crear una nueva nota adhesiva para la transcripci√≥n
            const note = document.createElement('div');
            note.className = 'sticky-note pink transcription-note';
            
            // Posicionar en el viewport actual
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            note.style.left = (viewportCenterX - 100 + Math.random() * 200) + 'px';
            note.style.top = (viewportCenterY - 75 + Math.random() * 150) + 'px';
            note.style.width = '250px';
            note.style.minHeight = '180px';
            
            note.innerHTML = `
                <div class="note-header">
                    <div class="note-emoji" onclick="cycleEmoji(this)">üé§</div>
                </div>
                <textarea placeholder="Hablando... el texto aparecer√° aqu√≠ autom√°ticamente" readonly style="background: rgba(255,255,255,0.3);"></textarea>
                <button class="note-close" onclick="removeElement(this.parentElement)">√ó</button>
            `;
            
            canvas.appendChild(note);
            makeDraggable(note);
            note.classList.add('wiggle');
            
            currentTranscriptionNote = note;
            transcriptionResult = '';
            
            // A√±adir indicador visual de que est√° transcribiendo
            note.style.border = '3px solid #4CAF50';
            note.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.4)';
            
            return note;
        }

        function handleTranscriptionResult(event) {
            if (!currentTranscriptionNote) return;
            
            const textarea = currentTranscriptionNote.querySelector('textarea');
            let finalTranscript = '';
            let interimTranscript = '';
            
            // Procesar resultados
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // Actualizar texto de la transcripci√≥n
            if (finalTranscript) {
                transcriptionResult += finalTranscript;
                textarea.value = transcriptionResult;
                
                // Auto-scroll al final
                textarea.scrollTop = textarea.scrollHeight;
                
                // Expandir nota si es necesario
                if (transcriptionResult.length > 200) {
                    currentTranscriptionNote.style.minHeight = '250px';
                }
                if (transcriptionResult.length > 400) {
                    currentTranscriptionNote.style.minHeight = '300px';
                }
                
                autoSave();
            }
            
            // Mostrar texto temporal
            if (interimTranscript) {
                textarea.value = transcriptionResult + interimTranscript;
                textarea.scrollTop = textarea.scrollHeight;
            }
            
            // Crear nueva nota si la actual se est√° llenando mucho
            if (transcriptionResult.length > 800) {
                finalizeTranscriptionNote();
                setTimeout(() => {
                    if (isTranscribing) {
                        createTranscriptionNote();
                    }
                }, 500);
            }
        }

        function handleTranscriptionError(error) {
            let message = '';
            
            switch (error) {
                case 'not-allowed':
                    message = '‚ùå Acceso al micr√≥fono denegado. Permite el acceso para usar transcripci√≥n.';
                    break;
                case 'no-speech':
                    message = 'ü§´ No se detect√≥ voz. Habla m√°s cerca del micr√≥fono.';
                    break;
                case 'audio-capture':
                    message = '‚ùå Error del micr√≥fono. Verifica tu dispositivo de audio.';
                    break;
                case 'network':
                    message = 'üåê Error de conexi√≥n. Verifica tu internet para usar transcripci√≥n.';
                    break;
                default:
                    message = '‚ö†Ô∏è Error de transcripci√≥n: ' + error;
            }
            
            showNotificationMessage(message, 'error');
            
            // Parar transcripci√≥n en errores cr√≠ticos
            if (['not-allowed', 'audio-capture'].includes(error)) {
                stopTranscription();
            }
        }

        function finalizeTranscriptionNote() {
            if (!currentTranscriptionNote) return;
            
            const textarea = currentTranscriptionNote.querySelector('textarea');
            
            // Hacer la nota editable
            textarea.readOnly = false;
            textarea.style.background = '';
            textarea.placeholder = 'Transcripci√≥n completada - ahora puedes editar';
            
            // Quitar indicadores visuales de transcripci√≥n activa
            currentTranscriptionNote.style.border = '';
            currentTranscriptionNote.style.boxShadow = '';
            currentTranscriptionNote.classList.remove('transcription-note');
            
            // Cambiar emoji a indicar texto
            const emoji = currentTranscriptionNote.querySelector('.note-emoji');
            if (emoji) {
                emoji.textContent = 'üìù';
            }
            
            currentTranscriptionNote = null;
        }

        function updateTranscriptionUI(isActive) {
            // Actualizar el bot√≥n en la interfaz
            const transcriptionBtns = document.querySelectorAll('[onclick*="toggleTranscription"]');
            transcriptionBtns.forEach(btn => {
                if (isActive) {
                    btn.textContent = '‚èπÔ∏è Parar Transcripci√≥n';
                    btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff5252)';
                    btn.classList.add('recording');
                } else {
                    btn.textContent = 'ÔøΩ Transcripci√≥n';
                    btn.style.background = '';
                    btn.classList.remove('recording');
                }
            });
        }

        // ====== FUNCIONES DE GRABACI√ìN DE VIDEO ======

        // Funci√≥n para alternar entre m√©todos de video
        function toggleVideoMethod(method) {
            const urlBtn = document.getElementById('videoUrlBtn');
            const recordBtn = document.getElementById('videoRecordBtn');
            const urlMethod = document.getElementById('urlVideoMethod');
            const recordMethod = document.getElementById('recordVideoMethod');
            
            if (method === 'url') {
                urlBtn.classList.add('active');
                urlBtn.classList.remove('btn-secondary');
                recordBtn.classList.remove('active');
                recordBtn.classList.add('btn-secondary');
                urlMethod.style.display = 'block';
                recordMethod.style.display = 'none';
                
                // Limpiar estado de grabaci√≥n al cambiar a URL
                cleanupVideoRecording();
            } else if (method === 'record') {
                recordBtn.classList.add('active');
                recordBtn.classList.remove('btn-secondary');
                urlBtn.classList.remove('active');
                urlBtn.classList.add('btn-secondary');
                urlMethod.style.display = 'none';
                recordMethod.style.display = 'block';
                
                // Resetear interfaz de grabaci√≥n
                resetRecordingInterface();
            }
        }

        // Funci√≥n para activar la c√°mara
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const cameraPreview = document.getElementById('cameraPreview');
                const placeholder = document.getElementById('cameraPlaceholder');
                const startCameraBtn = document.getElementById('startCameraBtn');
                const startRecordBtn = document.getElementById('startRecordBtn');
                const recordingStatus = document.getElementById('recordingStatus');
                
                // Verificar que tenemos tanto video como audio
                const videoTracks = videoStream.getVideoTracks();
                const audioTracks = videoStream.getAudioTracks();
                
                console.log('üé• Pistas de video:', videoTracks.length);
                console.log('üé§ Pistas de audio:', audioTracks.length);
                
                // Mostrar preview de la c√°mara
                cameraPreview.srcObject = videoStream;
                cameraPreview.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Actualizar controles
                startCameraBtn.style.display = 'none';
                startRecordBtn.style.display = 'inline-block';
                
                // Mensaje espec√≠fico sobre audio/video
                let statusMessage = 'üìπ C√°mara activada';
                if (audioTracks.length > 0) {
                    statusMessage += ' con audio üé§';
                } else {
                    statusMessage += ' (sin audio)';
                }
                statusMessage += ' - Lista para grabar';
                
                recordingStatus.textContent = statusMessage;
                recordingStatus.style.color = '#4CAF50';
                
                // Notificaci√≥n detallada
                if (audioTracks.length > 0) {
                    showNotificationMessage('üìπüé§ ¬°C√°mara y micr√≥fono activados! Audio incluido en la grabaci√≥n.', 'success');
                } else {
                    showNotificationMessage('üìπ C√°mara activada, pero sin audio. Verifica permisos del micr√≥fono.', 'info');
                }
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara/micr√≥fono:', error);
                
                let errorMessage = '';
                let suggestion = '';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Acceso denegado a c√°mara/micr√≥fono';
                    suggestion = 'Haz clic en el √≠cono de c√°mara üìπ en la barra de direcciones y permite el acceso.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ c√°mara o micr√≥fono';
                    suggestion = 'Verifica que tu dispositivo tenga c√°mara y micr√≥fono conectados.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'C√°mara/micr√≥fono ya en uso';
                    suggestion = 'Cierra otras aplicaciones que puedan estar usando la c√°mara o micr√≥fono.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'Configuraci√≥n no soportada';
                    suggestion = 'Tu dispositivo no soporta la calidad de video/audio solicitada.';
                } else {
                    errorMessage = 'Error desconocido al acceder a los dispositivos';
                    suggestion = 'Recarga la p√°gina e intenta de nuevo. Aseg√∫rate de estar usando HTTPS.';
                }
                
                document.getElementById('recordingStatus').textContent = '‚ùå ' + errorMessage;
                document.getElementById('recordingStatus').style.color = '#ff6b6b';
                
                // Mostrar tanto el error como la sugerencia
                showNotificationMessage('‚ùå ' + errorMessage + '\nüí° ' + suggestion, 'error');
                
                // Intentar fallback solo con video si el problema es el audio
                if (error.name === 'NotFoundError' || error.constraint === 'audio') {
                    setTimeout(() => {
                        if (confirm('üé• ¬øQuieres intentar grabar solo video (sin audio)?')) {
                            startCameraVideoOnly();
                        }
                    }, 2000);
                }
            }
        }

        // Funci√≥n de fallback para grabar solo video (sin audio)
        async function startCameraVideoOnly() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false // Sin audio
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const cameraPreview = document.getElementById('cameraPreview');
                const placeholder = document.getElementById('cameraPlaceholder');
                const startCameraBtn = document.getElementById('startCameraBtn');
                const startRecordBtn = document.getElementById('startRecordBtn');
                const recordingStatus = document.getElementById('recordingStatus');
                
                // Mostrar preview de la c√°mara
                cameraPreview.srcObject = videoStream;
                cameraPreview.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Actualizar controles
                startCameraBtn.style.display = 'none';
                startRecordBtn.style.display = 'inline-block';
                recordingStatus.textContent = 'üìπ C√°mara activada (solo video, sin audio) - Lista para grabar';
                recordingStatus.style.color = '#ff8c00';
                
                showNotificationMessage('üìπ C√°mara activada en modo solo video. No se grabar√° audio.', 'info');
                
            } catch (error) {
                console.error('Error en fallback de solo video:', error);
                
                document.getElementById('recordingStatus').textContent = '‚ùå No se pudo activar la c√°mara';
                document.getElementById('recordingStatus').style.color = '#ff6b6b';
                
                showNotificationMessage('‚ùå Error: No se pudo acceder a la c√°mara. Verifica permisos y dispositivos.', 'error');
            }
        }

        // Funci√≥n para iniciar grabaci√≥n
        function startRecording() {
            if (!videoStream) {
                showNotificationMessage('‚ùå Primero activa la c√°mara', 'error');
                return;
            }

            try {
                videoChunks = [];
                
                // Configurar MediaRecorder con mejores opciones de audio
                let options = {};
                
                // Probar diferentes configuraciones en orden de preferencia
                const preferredFormats = [
                    'video/webm;codecs=vp9,opus',  // Mejor calidad
                    'video/webm;codecs=vp8,opus',  // Buena compatibilidad con audio
                    'video/webm;codecs=h264,aac',  // Alternativa con AAC
                    'video/mp4;codecs=h264,aac',   // MP4 con audio
                    'video/webm',                  // Fallback b√°sico WebM
                    'video/mp4'                    // Fallback b√°sico MP4
                ];
                
                for (const format of preferredFormats) {
                    if (MediaRecorder.isTypeSupported(format)) {
                        options.mimeType = format;
                        console.log('üé• Formato de video seleccionado:', format);
                        break;
                    }
                }
                
                // Configuraciones adicionales para mejor calidad de audio
                if (options.mimeType) {
                    options.audioBitsPerSecond = 128000; // 128 kbps para buena calidad de audio
                    options.videoBitsPerSecond = 2500000; // 2.5 Mbps para buena calidad de video
                }
                
                videoMediaRecorder = new MediaRecorder(videoStream, options);
                
                videoMediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        videoChunks.push(event.data);
                    }
                };
                
                videoMediaRecorder.onstop = () => {
                    recordedVideoBlob = new Blob(videoChunks, { type: 'video/webm' });
                    showRecordedVideo();
                };
                
                // Iniciar grabaci√≥n
                videoMediaRecorder.start();
                isVideoRecording = true;
                recordingStartTime = Date.now();
                
                // Actualizar interfaz
                updateRecordingInterface(true);
                
                // Iniciar timer
                startRecordingTimer();
                
                showNotificationMessage('üî¥ ¬°Grabaci√≥n iniciada!', 'success');
                
            } catch (error) {
                console.error('Error al iniciar grabaci√≥n:', error);
                showNotificationMessage('‚ùå Error al iniciar grabaci√≥n: ' + error.message, 'error');
            }
        }

        // Funci√≥n para parar grabaci√≥n
        function stopRecording() {
            if (videoMediaRecorder && isVideoRecording) {
                videoMediaRecorder.stop();
                isVideoRecording = false;
                
                // Parar timer
                stopRecordingTimer();
                
                // Actualizar interfaz
                updateRecordingInterface(false);
                
                showNotificationMessage('‚èπÔ∏è Grabaci√≥n finalizada. Procesando video...', 'info');
            }
        }

        // Funci√≥n para mostrar video grabado
        function showRecordedVideo() {
            const cameraPreview = document.getElementById('cameraPreview');
            const recordedPreview = document.getElementById('recordedPreview');
            const recordingStatus = document.getElementById('recordingStatus');
            const addRecordedBtn = document.getElementById('addRecordedBtn');
            const retryBtn = document.getElementById('retryBtn');
            
            // Ocultar preview de c√°mara y mostrar video grabado
            cameraPreview.style.display = 'none';
            recordedPreview.style.display = 'block';
            
            // Configurar video grabado
            const videoUrl = URL.createObjectURL(recordedVideoBlob);
            recordedPreview.src = videoUrl;
            
            // Actualizar estado
            recordingStatus.textContent = '‚úÖ Video grabado exitosamente';
            recordingStatus.style.color = '#4CAF50';
            
            // Mostrar botones de acci√≥n
            addRecordedBtn.style.display = 'inline-block';
            retryBtn.style.display = 'inline-block';
            
            showNotificationMessage('‚úÖ ¬°Video listo! Puedes agregarlo al tablero o grabar otro.', 'success');
        }

        // Funci√≥n para reintentar grabaci√≥n
        function retryRecording() {
            // Limpiar video anterior
            const recordedPreview = document.getElementById('recordedPreview');
            if (recordedPreview.src) {
                URL.revokeObjectURL(recordedPreview.src);
            }
            
            recordedVideoBlob = null;
            resetRecordingInterface();
            
            // Volver a activar c√°mara
            startCamera();
        }

        // Funci√≥n para agregar video grabado al tablero
        function addRecordedVideoToBoard() {
            if (!recordedVideoBlob) {
                showNotificationMessage('‚ùå No hay video grabado para agregar', 'error');
                return;
            }

            // Crear URL del blob para el video
            const videoUrl = URL.createObjectURL(recordedVideoBlob);
            
            // Crear elemento de video en el tablero
            createRecordedVideoElement(videoUrl, 400, 300);
            
            // Cerrar modal
            closeModal('videoModal');
            
            // Limpiar estado
            cleanupVideoRecording();
            
            showNotificationMessage('üé• ¬°Video agregado al tablero!', 'success');
        }

        // Funci√≥n para crear elemento de video grabado en el tablero
        function createRecordedVideoElement(videoUrl, width, height) {
            const videoNote = document.createElement('div');
            videoNote.className = 'video-note';
            
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            videoNote.style.left = (viewportCenterX - parseInt(width)/2) + 'px';
            videoNote.style.top = (viewportCenterY - parseInt(height)/2) + 'px';
            videoNote.style.width = width + 'px';
            videoNote.style.height = height + 'px';
            
            videoNote.innerHTML = `
                <div class="video-header">
                    <span class="drag-icon">‚ãÆ‚ãÆ</span>
                    <span class="video-title">üé• Video Grabado</span>
                    <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                </div>
                <video src="${videoUrl}" controls style="width: 100%; height: calc(100% - 25px); margin-top: 25px; object-fit: cover;" autoplay muted loop></video>
            `;
            
            // Guardar referencia al blob para el sistema de guardado
            videoNote.dataset.videoType = 'recorded';
            videoNote.dataset.videoBlob = videoUrl;
            
            canvas.appendChild(videoNote);
            makeDraggable(videoNote);
            videoNote.classList.add('wiggle');
            autoSave();
        }

        // Funci√≥n para actualizar interfaz durante grabaci√≥n
        function updateRecordingInterface(recording) {
            const startRecordBtn = document.getElementById('startRecordBtn');
            const stopRecordBtn = document.getElementById('stopRecordBtn');
            const recordingStatus = document.getElementById('recordingStatus');
            const recordingTimer = document.getElementById('recordingTimer');
            
            if (recording) {
                startRecordBtn.style.display = 'none';
                stopRecordBtn.style.display = 'inline-block';
                
                // Verificar si tenemos audio
                let statusText = 'üî¥ Grabando video';
                if (videoStream && videoStream.getAudioTracks().length > 0) {
                    statusText += ' + audio üé§';
                } else {
                    statusText += ' (sin audio)';
                }
                statusText += '...';
                
                recordingStatus.textContent = statusText;
                recordingStatus.style.color = '#ff6b6b';
                recordingTimer.style.display = 'block';
                
                // A√±adir efecto visual cuando se est√° grabando con audio
                if (videoStream && videoStream.getAudioTracks().length > 0) {
                    recordingStatus.style.fontWeight = 'bold';
                    recordingStatus.style.textShadow = '0 0 10px rgba(255, 107, 107, 0.5)';
                }
            } else {
                startRecordBtn.style.display = 'none';
                stopRecordBtn.style.display = 'none';
                recordingStatus.textContent = '‚èπÔ∏è Grabaci√≥n detenida, procesando...';
                recordingStatus.style.color = '#ff8c00';
                recordingStatus.style.fontWeight = 'normal';
                recordingStatus.style.textShadow = 'none';
                recordingTimer.style.display = 'none';
            }
        }

        // Funci√≥n para iniciar timer de grabaci√≥n
        function startRecordingTimer() {
            const timerElement = document.getElementById('recordingTimer');
            
            recordingTimer = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Date.now() - recordingStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // A√±adir efecto pulsante
                    timerElement.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        timerElement.style.transform = 'scale(1)';
                    }, 100);
                }
            }, 1000);
        }

        // Funci√≥n para parar timer de grabaci√≥n
        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        // Funci√≥n para resetear interfaz de grabaci√≥n
        function resetRecordingInterface() {
            const cameraPreview = document.getElementById('cameraPreview');
            const recordedPreview = document.getElementById('recordedPreview');
            const placeholder = document.getElementById('cameraPlaceholder');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const startRecordBtn = document.getElementById('startRecordBtn');
            const stopRecordBtn = document.getElementById('stopRecordBtn');
            const addRecordedBtn = document.getElementById('addRecordedBtn');
            const retryBtn = document.getElementById('retryBtn');
            const recordingStatus = document.getElementById('recordingStatus');
            const timerElement = document.getElementById('recordingTimer');
            
            // Mostrar estado inicial
            cameraPreview.style.display = 'none';
            recordedPreview.style.display = 'none';
            placeholder.style.display = 'block';
            
            // Mostrar solo bot√≥n de activar c√°mara
            startCameraBtn.style.display = 'inline-block';
            startRecordBtn.style.display = 'none';
            stopRecordBtn.style.display = 'none';
            addRecordedBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            
            // Resetear status
            recordingStatus.textContent = 'Listo para grabar';
            recordingStatus.style.color = '#FF6B9D';
            timerElement.style.display = 'none';
            timerElement.textContent = '00:00';
            
            // Limpiar estado
            cleanupVideoRecording();
        }

        // Funci√≥n para limpiar recursos de grabaci√≥n
        function cleanupVideoRecording() {
            // Parar timer si est√° ejecut√°ndose
            stopRecordingTimer();
            
            // Parar grabaci√≥n si est√° activa
            if (videoMediaRecorder && isVideoRecording) {
                videoMediaRecorder.stop();
                isVideoRecording = false;
            }
            
            // Cerrar stream de video
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // Limpiar references
            videoMediaRecorder = null;
            videoChunks = [];
            recordingStartTime = null;
            
            // Limpiar URLs de blob previos
            const recordedPreview = document.getElementById('recordedPreview');
            if (recordedPreview && recordedPreview.src && recordedPreview.src.startsWith('blob:')) {
                URL.revokeObjectURL(recordedPreview.src);
                recordedPreview.src = '';
            }
        }



        // ====== HERRAMIENTAS CREATIVAS ======
        function addDrawingCanvas() {
            // Calcular posici√≥n centrada
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            // Crear contenedor principal m√°s grande
            const drawingContainer = document.createElement('div');
            drawingContainer.className = 'drawing-container';
            drawingContainer.style.left = (viewportCenterX - 400) + 'px';
            drawingContainer.style.top = (viewportCenterY - 270) + 'px';
            
            // Crear canvas de dibujo m√°s grande
            const drawingCanvas = document.createElement('canvas');
            drawingCanvas.className = 'drawing-canvas';
            drawingCanvas.width = 800;
            drawingCanvas.height = 500;
            
            // Generar paleta de colores
            let colorPaletteHtml = '';
            colorPalette.forEach((color, index) => {
                const isActive = color === currentColor ? 'active' : '';
                colorPaletteHtml += `<div class="drawing-color-option ${isActive}" style="background-color: ${color};" onclick="setDrawingColorFromPalette('${color}', this)"></div>`;
            });
            
            // Crear toolbar pegada al canvas
            const toolbar = document.createElement('div');
            toolbar.className = 'drawing-toolbar';
            toolbar.innerHTML = `
                <div class="canvas-close-btn" onclick="removeDrawingCanvas(this)" title="Eliminar Canvas">√ó</div>
                
                <div class="drawing-toolbar-row">
                    <button class="drawing-tool active" onclick="setDrawingTool(this, 'brush')" title="Pincel (B)">
                        üñåÔ∏è
                        <div class="drawing-tool-tooltip">Pincel (B)</div>
                    </button>
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'pencil')" title="L√°piz (P)">
                        ‚úèÔ∏è
                        <div class="drawing-tool-tooltip">L√°piz (P)</div>
                    </button>
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'eraser')" title="Borrador (E)">
                        üßΩ
                        <div class="drawing-tool-tooltip">Borrador (E)</div>
                    </button>
                    
                    <div class="drawing-separator"></div>
                    
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'line')" title="L√≠nea (L)">
                        üìè
                        <div class="drawing-tool-tooltip">L√≠nea (L)</div>
                    </button>
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'circle')" title="C√≠rculo (C)">
                        ‚≠ï
                        <div class="drawing-tool-tooltip">C√≠rculo (C)</div>
                    </button>
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'rectangle')" title="Rect√°ngulo (R)">
                        ‚¨ú
                        <div class="drawing-tool-tooltip">Rect√°ngulo (R)</div>
                    </button>
                    
                    <div class="drawing-separator"></div>
                    
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'bucket')" title="Relleno (F/G)">
                        ü™£
                        <div class="drawing-tool-tooltip">Relleno (F/G)</div>
                    </button>
                    <button class="drawing-tool" onclick="setDrawingTool(this, 'eyedropper')" title="Cuentagotas (I)">
                        üíâ
                        <div class="drawing-tool-tooltip">Cuentagotas (I)</div>
                    </button>
                    
                    <div class="drawing-separator"></div>
                    
                    <input type="color" value="${currentColor}" onchange="setDrawingColor(this.value)" class="drawing-color-picker" title="Selector de color">
                    
                    <div class="drawing-slider-container" onmousedown="event.stopPropagation()" onmouseup="event.stopPropagation()" onmousemove="event.stopPropagation()">
                        <input type="range" min="1" max="50" value="${currentSize}" onchange="setDrawingSize(this.value)" oninput="setDrawingSize(this.value)" class="drawing-slider" title="Tama√±o del pincel">
                    </div>
                    <div class="drawing-size-display">${currentSize}px</div>
                    
                    <div class="drawing-separator"></div>
                    
                    <button class="drawing-tool" onclick="undoDrawing(this)" title="Deshacer (Ctrl+Z)" id="undoBtn">
                        ‚Ü∂
                        <div class="drawing-tool-tooltip">Deshacer (Ctrl+Z)</div>
                    </button>
                    <button class="drawing-tool" onclick="clearDrawing(this)" title="Limpiar Canvas">
                        üóëÔ∏è
                        <div class="drawing-tool-tooltip">Limpiar</div>
                    </button>
                    <button class="drawing-tool" onclick="showDrawingHelp()" title="Ayuda de atajos (H)">
                        ‚ùì
                        <div class="drawing-tool-tooltip">Ayuda (H)</div>
                    </button>
                </div>
                
                <div class="drawing-toolbar-row">
                    <div class="drawing-color-palette">${colorPaletteHtml}</div>
                </div>
            `;
            
            // Ensamblar el contenedor
            drawingContainer.appendChild(toolbar);
            drawingContainer.appendChild(drawingCanvas);
            
            // A√±adir al canvas principal
            canvas.appendChild(drawingContainer);
            makeDraggable(drawingContainer);
            
            // Configurar funcionalidad de dibujo
            setupAdvancedDrawing(drawingCanvas);
            
            // Configurar eventos espec√≠ficos del toolbar
            setupToolbarEvents(toolbar);
            
            drawingContainer.classList.add('wiggle');
            
            // A√±adir n√∫mero identificador si hay m√∫ltiples canvas
            const canvasCount = document.querySelectorAll('.drawing-container').length + 1;
            if (canvasCount > 1) {
                const canvasNumber = document.createElement('div');
                canvasNumber.style.cssText = `
                    position: absolute;
                    top: -8px;
                    left: -8px;
                    width: 25px;
                    height: 25px;
                    background: linear-gradient(135deg, #FF6B9D, #D4A5FF);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    border: 2px solid white;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    z-index: 1001;
                `;
                canvasNumber.textContent = canvasCount;
                drawingContainer.appendChild(canvasNumber);
            }
            
            // Guardar estado y mostrar notificaci√≥n
            saveBoard();
            setTimeout(() => {
                const totalCanvas = document.querySelectorAll('.drawing-container').length;
                
                // Actualizar controles iniciales
                updateAllDrawingSliders();
                
                showNotificationMessage(`üé® ¬°Canvas ${totalCanvas} creado! Slider y botones listos. Presiona H para atajos.`, 'success');
                console.log('Canvas creado con controles funcionales:', {
                    tama√±o: currentSize,
                    color: currentColor,
                    herramienta: currentTool
                });
            }, 300);
        }
        
        // Nueva funci√≥n para eliminar canvas individual
        function removeDrawingCanvas(closeBtn) {
            const container = closeBtn.closest('.drawing-container');
            const canvasCount = document.querySelectorAll('.drawing-container').length;
            
            // Eliminaci√≥n directa sin confirmaci√≥n
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0.5';
            
            setTimeout(() => {
                container.remove();
                autoSave();
                const remaining = document.querySelectorAll('.drawing-container').length;
                if (remaining > 0) {
                    showNotificationMessage(`üóëÔ∏è Canvas eliminado. ${remaining} canvas restante${remaining > 1 ? 's' : ''}.`, 'info');
                } else {
                    showNotificationMessage('üé® Herramienta de dibujo cerrada.', 'info');
                }
            }, 200);
        }

        function setupAdvancedDrawing(canvas) {
            const ctx = canvas.getContext('2d');
            let localDrawing = false;
            let localStartX, localStartY;
            let localTempData = null;
            
            // Funci√≥n para obtener coordenadas precisas del mouse
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
            
            // Configurar evento de mousedown
            canvas.addEventListener('mousedown', (e) => {
                // Marcar este canvas como activo
                document.querySelectorAll('.drawing-canvas').forEach(c => c.classList.remove('active'));
                canvas.classList.add('active');
                
                const pos = getMousePos(e);
                const x = pos.x;
                const y = pos.y;
                
                localDrawing = true;
                localStartX = x;
                localStartY = y;
                
                // Guardar estado para herramientas de forma
                if (currentTool === 'line' || currentTool === 'circle' || currentTool === 'rectangle') {
                    localTempData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                // Configurar estilo de dibujo
                setupDrawingStyle(ctx);
                
                if (currentTool === 'bucket') {
                    floodFill(ctx, Math.floor(x), Math.floor(y), currentColor, canvas);
                    saveDrawingState(canvas);
                } else if (currentTool === 'eyedropper') {
                    pickColor(ctx, x, y);
                } else if (currentTool === 'brush' || currentTool === 'pencil' || currentTool === 'eraser') {
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    
                    // Dibujar un punto inicial para trazos cortos
                    ctx.lineTo(x + 0.1, y + 0.1);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Configurar evento de mousemove
            canvas.addEventListener('mousemove', (e) => {
                if (!localDrawing) return;
                
                const pos = getMousePos(e);
                const x = pos.x;
                const y = pos.y;
                
                if (currentTool === 'brush' || currentTool === 'pencil' || currentTool === 'eraser') {
                    // Dibujo continuo con mejor precisi√≥n
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                } else if (currentTool === 'line' || currentTool === 'circle' || currentTool === 'rectangle') {
                    // Restaurar estado y dibujar preview
                    if (localTempData) {
                        ctx.putImageData(localTempData, 0, 0);
                        setupDrawingStyle(ctx); // Reestablecer el estilo despu√©s de restaurar
                    }
                    
                    if (currentTool === 'line') {
                        drawLine(ctx, localStartX, localStartY, x, y);
                    } else if (currentTool === 'circle') {
                        drawCircle(ctx, localStartX, localStartY, x, y);
                    } else if (currentTool === 'rectangle') {
                        drawRectangle(ctx, localStartX, localStartY, x, y);
                    }
                }
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Configurar evento de mouseup
            canvas.addEventListener('mouseup', (e) => {
                if (localDrawing) {
                    localDrawing = false;
                    ctx.beginPath();
                    
                    // Guardar estado al finalizar cualquier operaci√≥n
                    if (currentTool !== 'eyedropper') {
                        setTimeout(() => {
                            saveDrawingState(canvas);
                            updateUndoButtonState(canvas);
                        }, 50);
                    }
                }
                // Autoguardado inmediato despu√©s de dibujar
                autoSave();
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Manejar eventos de mouse fuera del canvas
            canvas.addEventListener('mouseleave', () => {
                if (localDrawing) {
                    localDrawing = false;
                    ctx.beginPath();
                    if (currentTool !== 'eyedropper') {
                        setTimeout(() => {
                            saveDrawingState(canvas);
                            updateUndoButtonState(canvas);
                        }, 50);
                    }
                    // Autoguardado al salir del canvas mientras se dibuja
                    autoSave();
                }
            });
            
            // Inicializar historial de dibujo con canvas en blanco
            setTimeout(() => {
                // Crear estado inicial en blanco
                if (!canvas.drawingHistory) {
                    canvas.drawingHistory = [];
                    canvas.historyIndex = -1;
                }
                saveDrawingState(canvas);
                console.log('Historial inicial creado para nuevo canvas');
            }, 100);
        }
        
        function setupDrawingStyle(ctx) {
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1.0;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor;
                
                // Configuraciones especiales por herramienta
                if (currentTool === 'pencil') {
                    ctx.globalAlpha = 0.7;
                    ctx.lineWidth = Math.max(1, currentSize * 0.8); // L√°piz m√°s fino
                } else if (currentTool === 'brush') {
                    ctx.globalAlpha = 0.9;
                } else {
                    ctx.globalAlpha = 1.0;
                }
            }
            
            // Mejorar calidad de renderizado
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
        }
        
        function drawLine(ctx, x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }
        
        function drawCircle(ctx, x1, y1, x2, y2) {
            const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            ctx.beginPath();
            ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
            ctx.stroke();
        }
        
        function drawRectangle(ctx, x1, y1, x2, y2) {
            const width = x2 - x1;
            const height = y2 - y1;
            ctx.beginPath();
            ctx.rect(x1, y1, width, height);
            ctx.stroke();
        }
        
        function floodFill(ctx, x, y, fillColor, canvas) {
            // Implementaci√≥n simplificada de relleno por inundaci√≥n
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const targetColor = getPixelColor(imageData, x, y);
            const fillColorRgb = hexToRgb(fillColor);
            
            if (colorsMatch(targetColor, fillColorRgb)) return;
            
            const stack = [[x, y]];
            
            while (stack.length > 0) {
                const [currentX, currentY] = stack.pop();
                
                if (currentX < 0 || currentX >= canvas.width || currentY < 0 || currentY >= canvas.height) continue;
                
                const currentColor = getPixelColor(imageData, currentX, currentY);
                
                if (!colorsMatch(currentColor, targetColor)) continue;
                
                setPixelColor(imageData, currentX, currentY, fillColorRgb);
                
                // Agregar p√≠xeles adyacentes a la pila
                stack.push([currentX + 1, currentY]);
                stack.push([currentX - 1, currentY]);
                stack.push([currentX, currentY + 1]);
                stack.push([currentX, currentY - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function getPixelColor(imageData, x, y) {
            const index = (y * imageData.width + x) * 4;
            return {
                r: imageData.data[index],
                g: imageData.data[index + 1],
                b: imageData.data[index + 2],
                a: imageData.data[index + 3]
            };
        }
        
        function setPixelColor(imageData, x, y, color) {
            const index = (y * imageData.width + x) * 4;
            imageData.data[index] = color.r;
            imageData.data[index + 1] = color.g;
            imageData.data[index + 2] = color.b;
            imageData.data[index + 3] = 255;
        }
        
        function colorsMatch(color1, color2) {
            return color1.r === color2.r && color1.g === color2.g && color1.b === color2.b;
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function pickColor(ctx, x, y) {
            const imageData = ctx.getImageData(x, y, 1, 1);
            const data = imageData.data;
            const hex = rgbToHex(data[0], data[1], data[2]);
            setDrawingColor(hex);
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function setDrawingTool(button, tool) {
            // Remover active de todos los botones de herramientas
            button.parentElement.querySelectorAll('.drawing-tool').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentTool = tool;
            
            // Actualizar cursor del canvas
            const canvas = button.closest('div').querySelector('canvas');
            updateCanvasCursor(canvas, tool);
        }
        
        function updateCanvasCursor(canvas, tool) {
            switch(tool) {
                case 'brush':
                case 'pencil':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'eraser':
                    canvas.style.cursor = 'grab';
                    break;
                case 'bucket':
                    canvas.style.cursor = 'copy';
                    break;
                case 'eyedropper':
                    canvas.style.cursor = 'cell';
                    break;
                case 'line':
                case 'circle':
                case 'rectangle':
                    canvas.style.cursor = 'crosshair';
                    break;
                default:
                    canvas.style.cursor = 'crosshair';
            }
        }

        function setDrawingColor(color) {
            currentColor = color;
            
            // Actualizar todos los color pickers en todos los canvas
            document.querySelectorAll('.drawing-color-picker').forEach(picker => {
                picker.value = color;
            });
            
            // Actualizar colores activos en todas las paletas
            document.querySelectorAll('.drawing-color-palette').forEach(palette => {
                palette.querySelectorAll('.drawing-color-option').forEach(option => {
                    option.classList.remove('active');
                    // Comparar color de fondo con el seleccionado
                    const optionColor = option.style.backgroundColor;
                    if (optionColor) {
                        const rgb = optionColor.match(/\d+/g);
                        if (rgb && rgb.length >= 3) {
                            const hex = rgbToHex(parseInt(rgb[0]), parseInt(rgb[1]), parseInt(rgb[2]));
                            if (hex.toLowerCase() === color.toLowerCase()) {
                                option.classList.add('active');
                            }
                        }
                    }
                });
            });
        }
        
        function setDrawingColorFromPalette(color, element) {
            currentColor = color;
            
            // Actualizar color picker
            const colorPicker = element.closest('.drawing-toolbar').querySelector('input[type="color"]');
            if (colorPicker) {
                colorPicker.value = color;
            }
            
            // Actualizar elementos activos
            element.parentElement.querySelectorAll('.drawing-color-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
        }

        function setDrawingSize(size) {
            currentSize = parseInt(size);
            
            // Actualizar todos los displays de tama√±o en todos los canvas
            document.querySelectorAll('.drawing-size-display').forEach(display => {
                display.textContent = currentSize + 'px';
            });
            
            // Actualizar todos los sliders
            document.querySelectorAll('.drawing-slider').forEach(slider => {
                slider.value = currentSize;
            });
            
            console.log('Tama√±o del pincel actualizado a:', currentSize);
        }
        
        function saveDrawingState(canvas) {
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Obtener o crear historial para este canvas espec√≠fico
            if (!canvas.drawingHistory) {
                canvas.drawingHistory = [];
                canvas.historyIndex = -1;
            }
            
            // Remover estados futuros si estamos en medio del historial
            if (canvas.historyIndex < canvas.drawingHistory.length - 1) {
                canvas.drawingHistory = canvas.drawingHistory.slice(0, canvas.historyIndex + 1);
            }
            
            // A√±adir nuevo estado
            canvas.drawingHistory.push(imageData);
            canvas.historyIndex++;
            
            // Limitar historial a 30 estados para mejor rendimiento
            if (canvas.drawingHistory.length > 30) {
                canvas.drawingHistory.shift();
                canvas.historyIndex--;
            }
            
            // Activar autoguardado cuando cambie el contenido del canvas
            autoSave();
            
            console.log(`Historial guardado: ${canvas.drawingHistory.length} estados, √≠ndice actual: ${canvas.historyIndex}`);
        }
        
        function undoDrawing(button) {
            const canvas = button.closest('div').querySelector('canvas');
            const ctx = canvas.getContext('2d');
            
            if (!canvas.drawingHistory || canvas.drawingHistory.length === 0) {
                showNotificationMessage('üìù No hay nada que deshacer', 'info');
                return;
            }
            
            if (canvas.historyIndex > 0) {
                canvas.historyIndex--;
                const imageData = canvas.drawingHistory[canvas.historyIndex];
                ctx.putImageData(imageData, 0, 0);
                autoSave();
                showNotificationMessage('‚Ü∂ Deshacer aplicado', 'success');
            } else {
                showNotificationMessage('üìù No hay m√°s acciones para deshacer', 'info');
            }
        }
        
        // Funci√≥n espec√≠fica para deshacer con canvas directo
        function undoDrawingDirect(canvas) {
            const ctx = canvas.getContext('2d');
            
            if (!canvas.drawingHistory || canvas.drawingHistory.length === 0) {
                showNotificationMessage('üìù No hay nada que deshacer', 'info');
                return;
            }
            
            if (canvas.historyIndex > 0) {
                canvas.historyIndex--;
                const imageData = canvas.drawingHistory[canvas.historyIndex];
                ctx.putImageData(imageData, 0, 0);
                autoSave();
                showNotificationMessage('‚Ü∂ Deshacer aplicado', 'success');
            } else {
                showNotificationMessage('üìù No hay m√°s acciones para deshacer', 'info');
            }
        }

        function clearDrawing(button) {
            const container = button.closest('.drawing-container');
            const canvas = container.querySelector('.drawing-canvas');
            
            if (!canvas) {
                console.error('No se encontr√≥ el canvas para limpiar');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Confirmar acci√≥n
            const confirmClear = confirm('¬øEst√°s seguro de que quieres limpiar este canvas?\n\nEsta acci√≥n no se puede deshacer.');
            
            if (confirmClear) {
                // Limpiar el canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Reiniciar historial con canvas limpio
                canvas.drawingHistory = [];
                canvas.historyIndex = -1;
                
                // Guardar estado inicial limpio
                setTimeout(() => {
                    saveDrawingState(canvas);
                    updateUndoButtonState(canvas);
                    showNotificationMessage('üóëÔ∏è Canvas limpiado completamente', 'success');
                }, 50);
                
                autoSave();
            }
        }
        
        // Funci√≥n para cambiar r√°pidamente entre colores (atajo X)
        function toggleDrawingColors() {
            if (currentColor === '#000000') {
                setDrawingColor('#FFFFFF');
            } else {
                setDrawingColor('#000000');
            }
        }
        
        // Funci√≥n para incrementar tama√±o del pincel
        function increaseDrawingBrush() {
            if (currentSize < 50) {
                const newSize = Math.min(50, currentSize + 2);
                setDrawingSize(newSize);
                showNotificationMessage(`üîç Tama√±o: ${newSize}px`, 'info');
            } else {
                showNotificationMessage('üîç Tama√±o m√°ximo alcanzado (50px)', 'info');
            }
        }
        
        // Funci√≥n para decrementar tama√±o del pincel
        function decreaseDrawingBrush() {
            if (currentSize > 1) {
                const newSize = Math.max(1, currentSize - 2);
                setDrawingSize(newSize);
                showNotificationMessage(`üîç Tama√±o: ${newSize}px`, 'info');
            } else {
                showNotificationMessage('üîç Tama√±o m√≠nimo alcanzado (1px)', 'info');
            }
        }
        
        function updateAllDrawingSliders() {
            // Actualizar todos los sliders
            document.querySelectorAll('.drawing-slider').forEach(slider => {
                slider.value = currentSize;
            });
            
            // Actualizar todos los displays de tama√±o
            document.querySelectorAll('.drawing-size-display').forEach(display => {
                display.textContent = currentSize + 'px';
            });
            
            // Actualizar todos los color pickers con el color actual
            document.querySelectorAll('.drawing-color-picker').forEach(picker => {
                picker.value = currentColor;
            });
            
            console.log(`Controles actualizados - Tama√±o: ${currentSize}px, Color: ${currentColor}`);
        }

        // Mantener compatibilidad con funciones existentes
        function setupDrawing(canvas) {
            setupAdvancedDrawing(canvas);
        }
        
        // Funciones auxiliares para atajos adicionales
        function undoInActiveCanvas() {
            const drawingCanvases = document.querySelectorAll('.drawing-canvas');
            if (drawingCanvases.length > 0) {
                // Buscar canvas que est√° siendo usado (√∫ltimo clickeado o el primero)
                let targetCanvas = document.querySelector('.drawing-canvas.active');
                if (!targetCanvas) {
                    targetCanvas = drawingCanvases[0]; // Usar el primero si ninguno est√° marcado como activo
                }
                
                // Usar funci√≥n directa para mejor control
                undoDrawingDirect(targetCanvas);
            } else {
                showNotificationMessage('üé® No hay canvas de dibujo abiertos', 'info');
            }
        }
        
        function clearActiveCanvas() {
            const drawingCanvases = document.querySelectorAll('.drawing-canvas');
            if (drawingCanvases.length > 0) {
                let targetCanvas = document.querySelector('.drawing-canvas.active');
                if (!targetCanvas) {
                    targetCanvas = drawingCanvases[0];
                }
                
                const container = targetCanvas.closest('.drawing-container');
                const clearBtn = container.querySelector('.drawing-tool[onclick*="clearDrawing"]');
                if (clearBtn) {
                    clearDrawing(clearBtn);
                } else {
                    // Si no encontramos el bot√≥n, limpiar directamente
                    clearDrawingDirect(targetCanvas);
                }
            }
        }
        
        // Funci√≥n para limpiar canvas directamente
        function clearDrawingDirect(canvas) {
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Confirmar acci√≥n
            const confirmClear = confirm('¬øEst√°s seguro de que quieres limpiar este canvas?\n\nEsta acci√≥n no se puede deshacer.');
            
            if (confirmClear) {
                // Limpiar el canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Reiniciar historial con canvas limpio
                canvas.drawingHistory = [];
                canvas.historyIndex = -1;
                
                // Guardar estado inicial limpio
                setTimeout(() => {
                    saveDrawingState(canvas);
                    updateUndoButtonState(canvas);
                    showNotificationMessage('üóëÔ∏è Canvas limpiado completamente', 'success');
                }, 50);
                
                saveBoard();
            }
        }
        
        function clearAllDrawingCanvases() {
            const drawingCanvases = document.querySelectorAll('.drawing-canvas');
            if (drawingCanvases.length > 0) {
                const confirm = window.confirm(`¬øLimpiar todos los ${drawingCanvases.length} canvas de dibujo?`);
                if (confirm) {
                    drawingCanvases.forEach(canvas => {
                        const container = canvas.closest('.drawing-container');
                        const clearBtn = container.querySelector('.drawing-tool[onclick*="clearDrawing"]');
                        if (clearBtn) {
                            clearDrawing(clearBtn);
                        }
                    });
                    showNotificationMessage(`üóëÔ∏è ${drawingCanvases.length} canvas limpiados`, 'success');
                }
            }
        }
        
        function switchToCanvasNumber(index) {
            const drawingCanvases = document.querySelectorAll('.drawing-canvas');
            if (index < drawingCanvases.length) {
                // Remover active de todos
                drawingCanvases.forEach(canvas => canvas.classList.remove('active'));
                
                // Marcar el seleccionado como active
                const targetCanvas = drawingCanvases[index];
                targetCanvas.classList.add('active');
                
                // Hacer scroll hacia el canvas si est√° fuera de vista
                targetCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                showNotificationMessage(`üé® Canvas ${index + 1} seleccionado`, 'info');
            }
        }
        
        function toggleSidebarInfo() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                if (sidebar.style.display === 'none' || !sidebar.style.display) {
                    sidebar.style.display = 'flex';
                    showNotificationMessage('üìã Sidebar mostrado', 'info');
                } else {
                    sidebar.style.display = 'none';
                    showNotificationMessage('üìã Sidebar ocultado', 'info');
                }
            }
        }
        
        function addImageFromDataUrl(dataUrl) {
            const img = new Image();
            img.onload = function() {
                // Crear imagen con estructura completa de image-card
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';
                
                // Posicionar en el centro
                const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
                const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
                
                imageCard.style.left = (viewportCenterX - 150) + 'px';
                imageCard.style.top = (viewportCenterY - 150) + 'px';
                imageCard.style.width = '300px';
                imageCard.style.height = '300px';
                
                imageCard.innerHTML = `
                    <div class="image-header">
                        <span class="drag-icon">‚ãÆ‚ãÆ</span>
                        <span class="image-title">üì∏ Captura</span>
                        <button class="note-close" onclick="removeElement(this.parentElement.parentElement)">√ó</button>
                    </div>
                    <img src="${dataUrl}" alt="Captura de canvas">
                `;
                
                // Agregar al hacer clic para ver en grande
                const imgElement = imageCard.querySelector('img');
                imgElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openImageViewer(dataUrl);
                });
                
                // Agregar funcionalidad de arrastre y clic
                canvas.appendChild(imageCard);
                makeDraggable(imageCard);
                
                imageCard.classList.add('wiggle');
                saveBoard();
                showNotificationMessage('üñºÔ∏è Imagen a√±adida', 'success');
            };
            img.src = dataUrl;
        }
        
        // Funci√≥n para configurar eventos espec√≠ficos del toolbar
        function setupToolbarEvents(toolbar) {
            // Configurar contenedor del slider para evitar conflictos de arrastre
            const sliderContainer = toolbar.querySelector('.drawing-slider-container');
            if (sliderContainer) {
                // Prevenir todos los eventos de mouse que interfieren con el arrastre del canvas
                ['mousedown', 'mouseup', 'mousemove', 'click', 'dragstart', 'drag', 'dragend'].forEach(eventType => {
                    sliderContainer.addEventListener(eventType, function(e) {
                        e.stopPropagation();
                        if (eventType === 'dragstart') {
                            e.preventDefault();
                        }
                    });
                });
            }
            
            // Configurar slider de tama√±o
            const sizeSlider = toolbar.querySelector('.drawing-slider');
            if (sizeSlider) {
                // Eventos espec√≠ficos del slider
                ['mousedown', 'mouseup', 'mousemove', 'click', 'dragstart'].forEach(eventType => {
                    sizeSlider.addEventListener(eventType, function(e) {
                        e.stopPropagation();
                        if (eventType === 'dragstart') {
                            e.preventDefault();
                        }
                    });
                });
                
                // Evento de cambio inmediato mientras se arrastra
                sizeSlider.addEventListener('input', function(e) {
                    e.stopPropagation();
                    setDrawingSize(this.value);
                });
                
                // Evento al soltar
                sizeSlider.addEventListener('change', function(e) {
                    e.stopPropagation();
                    setDrawingSize(this.value);
                });
            }
            
            // Configurar selector de color
            const colorPicker = toolbar.querySelector('.drawing-color-picker');
            if (colorPicker) {
                // Prevenir interferencia con el arrastre del canvas
                colorPicker.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
                
                colorPicker.addEventListener('mouseup', function(e) {
                    e.stopPropagation();
                });
                
                colorPicker.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                colorPicker.addEventListener('change', function(e) {
                    e.stopPropagation();
                    setDrawingColor(this.value);
                });
                
                colorPicker.addEventListener('input', function(e) {
                    e.stopPropagation();
                    setDrawingColor(this.value);
                });
            }
            
            // Configurar todos los botones del toolbar para evitar arrastre accidental
            const toolButtons = toolbar.querySelectorAll('.drawing-tool');
            toolButtons.forEach(button => {
                button.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
                button.addEventListener('mouseup', function(e) {
                    e.stopPropagation();
                });
            });
            
            // Configurar paleta de colores
            const colorOptions = toolbar.querySelectorAll('.drawing-color-option');
            colorOptions.forEach(option => {
                option.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
                option.addEventListener('mouseup', function(e) {
                    e.stopPropagation();
                });
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            console.log('Eventos del toolbar configurados correctamente');
            
            // Test del slider
            if (sizeSlider) {
                console.log('Slider encontrado y configurado:', sizeSlider);
                sizeSlider.addEventListener('input', function() {
                    console.log('Slider movido a:', this.value);
                });
            }
        }
        
        // Funci√≥n para actualizar el estado visual del bot√≥n de deshacer
        function updateUndoButtonState(canvas) {
            const container = canvas.closest('.drawing-container');
            if (container) {
                const undoBtn = container.querySelector('.drawing-tool[onclick*="undoDrawing"]');
                if (undoBtn && canvas.drawingHistory) {
                    if (canvas.historyIndex > 0) {
                        undoBtn.style.opacity = '1';
                        undoBtn.style.cursor = 'pointer';
                        undoBtn.title = `Deshacer (${canvas.historyIndex} acciones disponibles)`;
                    } else {
                        undoBtn.style.opacity = '0.5';
                        undoBtn.style.cursor = 'not-allowed';
                        undoBtn.title = 'No hay acciones para deshacer';
                    }
                }
            }
        }

        // Variables globales para diagramas
        let selectedDiagramType = 'pie';
        let diagramData = [];
        
        function showDiagramModal() {
            document.getElementById('diagramModal').style.display = 'flex';
            initializeDiagramData();
        }
        
        function initializeDiagramData() {
            // Datos de ejemplo
            diagramData = [
                { label: 'Ventas', value: 35, color: '#FF6B9D' },
                { label: 'Marketing', value: 25, color: '#4ECDC4' },
                { label: 'Desarrollo', value: 40, color: '#45B7D1' }
            ];
            
            // Llenar los inputs con datos de ejemplo
            const dataRows = document.querySelectorAll('#dataInputs .data-row');
            diagramData.forEach((item, index) => {
                if (dataRows[index]) {
                    dataRows[index].querySelector('.data-label').value = item.label;
                    dataRows[index].querySelector('.data-value').value = item.value;
                    dataRows[index].querySelector('.data-color').value = item.color;
                }
            });
            
            selectDiagramType('pie');
            updateDiagramPreview();
        }
        
        function selectDiagramType(type) {
            selectedDiagramType = type;
            
            // Actualizar botones activos
            document.querySelectorAll('.diagram-types .export-card').forEach(btn => {
                btn.style.background = '';
                btn.style.transform = '';
            });
            
            const selectedBtn = document.getElementById(type + 'Btn');
            if (selectedBtn) {
                selectedBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                selectedBtn.style.transform = 'scale(1.05)';
                selectedBtn.style.color = 'white';
            }
            
            document.getElementById('diagramEditor').style.display = 'block';
            updateDiagramPreview();
        }
        
        function addDataRow() {
            const dataInputs = document.getElementById('dataInputs');
            const newRow = document.createElement('div');
            newRow.className = 'data-row';
            newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            
            const pastelColors = ['#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            const randomColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
            
            newRow.innerHTML = `
                <input type="text" placeholder="Nueva etiqueta" class="data-label" style="flex: 1; padding: 8px;">
                <input type="number" placeholder="Valor" class="data-value" style="flex: 1; padding: 8px;" min="0" value="10">
                <input type="color" class="data-color" value="${randomColor}" style="width: 40px; height: 40px; border: none; border-radius: 5px;">
                <button onclick="removeDataRow(this)" style="padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">√ó</button>
            `;
            
            dataInputs.appendChild(newRow);
        }
        
        function removeDataRow(button) {
            const dataInputs = document.getElementById('dataInputs');
            if (dataInputs.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        function updateDiagramPreview() {
            collectDiagramData();
            drawDiagram();
        }
        
        function collectDiagramData() {
            diagramData = [];
            const rows = document.querySelectorAll('#dataInputs .data-row');
            
            rows.forEach(row => {
                const label = row.querySelector('.data-label').value.trim();
                const value = parseFloat(row.querySelector('.data-value').value) || 0;
                const color = row.querySelector('.data-color').value;
                
                if (label && value > 0) {
                    diagramData.push({ label, value, color });
                }
            });
        }
        
        function drawDiagram() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (diagramData.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Agrega datos para ver el diagrama', canvas.width/2, canvas.height/2);
                return;
            }
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            switch (selectedDiagramType) {
                case 'pie':
                    drawPieChart(ctx, centerX, centerY, 120, diagramData);
                    break;
                case 'doughnut':
                    drawDoughnutChart(ctx, centerX, centerY, 120, 50, diagramData);
                    break;
                case 'bar':
                    drawBarChart(ctx, canvas.width, canvas.height, diagramData);
                    break;
                case 'line':
                    drawLineChart(ctx, canvas.width, canvas.height, diagramData);
                    break;
            }
        }
        
        function drawPieChart(ctx, centerX, centerY, radius, data) {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = -Math.PI / 2; // Empezar desde arriba
            
            data.forEach((item, index) => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                // Dibujar slice
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Dibujar etiqueta con porcentaje
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.strokeText(`${Math.round((item.value / total) * 100)}%`, labelX, labelY);
                ctx.fillText(`${Math.round((item.value / total) * 100)}%`, labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }
        
        function drawDoughnutChart(ctx, centerX, centerY, outerRadius, innerRadius, data) {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = -Math.PI / 2;
            
            data.forEach((item) => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
        }
        
        function drawBarChart(ctx, width, height, data) {
            const margin = 40;
            const chartWidth = width - 2 * margin;
            const chartHeight = height - 2 * margin;
            const barWidth = chartWidth / data.length * 0.7;
            const maxValue = Math.max(...data.map(item => item.value));
            
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = margin + (chartWidth / data.length) * index + (chartWidth / data.length - barWidth) / 2;
                const y = height - margin - barHeight;
                
                // Dibujar barra
                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Dibujar borde
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth, barHeight);
                
                // Etiqueta
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.label, x + barWidth/2, height - margin + 15);
                
                // Valor
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.strokeText(item.value.toString(), x + barWidth/2, y - 5);
                ctx.fillText(item.value.toString(), x + barWidth/2, y - 5);
            });
        }
        
        function drawLineChart(ctx, width, height, data) {
            const margin = 40;
            const chartWidth = width - 2 * margin;
            const chartHeight = height - 2 * margin;
            const maxValue = Math.max(...data.map(item => item.value));
            
            // Dibujar l√≠neas de referencia
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = margin + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(width - margin, y);
                ctx.stroke();
            }
            
            // Dibujar l√≠nea principal
            ctx.beginPath();
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            
            data.forEach((item, index) => {
                const x = margin + (chartWidth / (data.length - 1)) * index;
                const y = height - margin - (item.value / maxValue) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Dibujar puntos
            data.forEach((item, index) => {
                const x = margin + (chartWidth / (data.length - 1)) * index;
                const y = height - margin - (item.value / maxValue) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Etiquetas
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.label, x, height - margin + 15);
            });
        }
        
        function addDiagramToCanvas() {
            collectDiagramData();
            
            if (diagramData.length === 0) {
                alert('‚ö†Ô∏è Agrega al menos un dato antes de crear el diagrama');
                return;
            }
            
            const title = document.getElementById('diagramTitle').value || 'Mi Diagrama';
            
            // Crear canvas temporal para generar la imagen
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 400;
            tempCanvas.height = 350;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Fondo blanco
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // T√≠tulo
            tempCtx.fillStyle = '#333';
            tempCtx.font = 'bold 18px Arial';
            tempCtx.textAlign = 'center';
            tempCtx.fillText(title, tempCanvas.width/2, 25);
            
            // Dibujar el diagrama
            const chartY = 50;
            const chartHeight = 250;
            
            switch (selectedDiagramType) {
                case 'pie':
                    drawPieChart(tempCtx, tempCanvas.width/2, chartY + chartHeight/2, 100, diagramData);
                    break;
                case 'doughnut':
                    drawDoughnutChart(tempCtx, tempCanvas.width/2, chartY + chartHeight/2, 100, 40, diagramData);
                    break;
                case 'bar':
                    // Ajustar posici√≥n para barras
                    tempCtx.save();
                    tempCtx.translate(0, chartY);
                    drawBarChart(tempCtx, tempCanvas.width, chartHeight, diagramData);
                    tempCtx.restore();
                    break;
                case 'line':
                    tempCtx.save();
                    tempCtx.translate(0, chartY);
                    drawLineChart(tempCtx, tempCanvas.width, chartHeight, diagramData);
                    tempCtx.restore();
                    break;
            }
            
            // Leyenda
            let legendY = chartY + chartHeight + 20;
            diagramData.forEach((item, index) => {
                const legendX = 50 + (index % 2) * 150;
                if (index % 2 === 0 && index > 0) legendY += 25;
                
                // Color box
                tempCtx.fillStyle = item.color;
                tempCtx.fillRect(legendX, legendY, 15, 15);
                tempCtx.strokeStyle = '#333';
                tempCtx.lineWidth = 1;
                tempCtx.strokeRect(legendX, legendY, 15, 15);
                
                // Texto
                tempCtx.fillStyle = '#333';
                tempCtx.font = '12px Arial';
                tempCtx.textAlign = 'left';
                tempCtx.fillText(`${item.label}: ${item.value}`, legendX + 20, legendY + 12);
            });
            
            // Crear elemento de imagen
            const imageData = tempCanvas.toDataURL();
            // Posici√≥n m√°s centrada en el canvas
            const canvasElement = document.getElementById('canvas');
            const canvasX = Math.random() * 300 + 200;
            const canvasY = Math.random() * 300 + 200;
            
            const diagramElement = createElement({
                type: 'image-card',
                left: canvasX + 'px',
                top: canvasY + 'px',
                width: '400px',
                height: '350px',
                content: {
                    src: imageData,
                    alt: title,
                    title: title
                },
                diagramType: selectedDiagramType,
                diagramData: [...diagramData] // Copiar datos para permitir edici√≥n futura
            });
            
            if (diagramElement) {
                const canvas = document.getElementById('canvas');
                canvas.appendChild(diagramElement);
                makeDraggable(diagramElement);
                diagramElement.classList.add('wiggle');
                
                saveBoard();
                closeModal('diagramModal');
                showProjectSwitchMessage(`üìä Diagrama "${title}" agregado al canvas!`);
            }
        }
        
        function editDiagram(diagramElement) {
            // Cargar datos del diagrama existente
            if (diagramElement.dataset.diagramType && diagramElement.dataset.diagramData) {
                selectedDiagramType = diagramElement.dataset.diagramType;
                diagramData = JSON.parse(diagramElement.dataset.diagramData);
                
                // Abrir modal
                showDiagramModal();
                
                // Seleccionar tipo correcto
                selectDiagramType(selectedDiagramType);
                
                // Llenar t√≠tulo
                const titleElement = diagramElement.querySelector('.image-title');
                if (titleElement) {
                    document.getElementById('diagramTitle').value = titleElement.textContent;
                }
                
                // Limpiar inputs existentes y crear nuevos
                const dataInputs = document.getElementById('dataInputs');
                dataInputs.innerHTML = '';
                
                // Crear inputs para cada dato
                diagramData.forEach((item, index) => {
                    const newRow = document.createElement('div');
                    newRow.className = 'data-row';
                    newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                    
                    newRow.innerHTML = `
                        <input type="text" placeholder="Etiqueta" class="data-label" style="flex: 1; padding: 8px;" value="${item.label}">
                        <input type="number" placeholder="Valor" class="data-value" style="flex: 1; padding: 8px;" min="0" value="${item.value}">
                        <input type="color" class="data-color" value="${item.color}" style="width: 40px; height: 40px; border: none; border-radius: 5px;">
                        <button onclick="removeDataRow(this)" style="padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">√ó</button>
                    `;
                    
                    dataInputs.appendChild(newRow);
                });
                
                // Si no hay datos, agregar una fila por defecto
                if (diagramData.length === 0) {
                    addDataRow();
                }
                
                updateDiagramPreview();
                
                // Reemplazar funci√≥n de agregar para actualizar el diagrama existente
                window.currentEditingDiagram = diagramElement;
            }
        }
        
        // Modificar la funci√≥n addDiagramToCanvas para manejar edici√≥n
        const originalAddDiagramToCanvas = addDiagramToCanvas;
        addDiagramToCanvas = function() {
            collectDiagramData();
            
            if (diagramData.length === 0) {
                alert('‚ö†Ô∏è Agrega al menos un dato antes de crear el diagrama');
                return;
            }
            
            const title = document.getElementById('diagramTitle').value || 'Mi Diagrama';
            
            // Si estamos editando un diagrama existente
            if (window.currentEditingDiagram) {
                const existingElement = window.currentEditingDiagram;
                
                // Crear canvas temporal para generar nueva imagen
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 400;
                tempCanvas.height = 350;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Fondo blanco
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // T√≠tulo
                tempCtx.fillStyle = '#333';
                tempCtx.font = 'bold 18px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.fillText(title, tempCanvas.width/2, 25);
                
                // Dibujar el diagrama
                const chartY = 50;
                const chartHeight = 250;
                
                switch (selectedDiagramType) {
                    case 'pie':
                        drawPieChart(tempCtx, tempCanvas.width/2, chartY + chartHeight/2, 100, diagramData);
                        break;
                    case 'doughnut':
                        drawDoughnutChart(tempCtx, tempCanvas.width/2, chartY + chartHeight/2, 100, 40, diagramData);
                        break;
                    case 'bar':
                        tempCtx.save();
                        tempCtx.translate(0, chartY);
                        drawBarChart(tempCtx, tempCanvas.width, chartHeight, diagramData);
                        tempCtx.restore();
                        break;
                    case 'line':
                        tempCtx.save();
                        tempCtx.translate(0, chartY);
                        drawLineChart(tempCtx, tempCanvas.width, chartHeight, diagramData);
                        tempCtx.restore();
                        break;
                }
                
                // Leyenda
                let legendY = chartY + chartHeight + 20;
                diagramData.forEach((item, index) => {
                    const legendX = 50 + (index % 2) * 150;
                    if (index % 2 === 0 && index > 0) legendY += 25;
                    
                    // Color box
                    tempCtx.fillStyle = item.color;
                    tempCtx.fillRect(legendX, legendY, 15, 15);
                    tempCtx.strokeStyle = '#333';
                    tempCtx.lineWidth = 1;
                    tempCtx.strokeRect(legendX, legendY, 15, 15);
                    
                    // Texto
                    tempCtx.fillStyle = '#333';
                    tempCtx.font = '12px Arial';
                    tempCtx.textAlign = 'left';
                    tempCtx.fillText(`${item.label}: ${item.value}`, legendX + 20, legendY + 12);
                });
                
                // Actualizar imagen y datos del elemento existente
                const img = existingElement.querySelector('img');
                const titleElement = existingElement.querySelector('.image-title');
                
                if (img) img.src = tempCanvas.toDataURL();
                if (titleElement) titleElement.textContent = title;
                
                existingElement.dataset.diagramType = selectedDiagramType;
                existingElement.dataset.diagramData = JSON.stringify(diagramData);
                
                saveBoard();
                closeModal('diagramModal');
                showProjectSwitchMessage(`üìä Diagrama "${title}" actualizado!`);
                
                // Limpiar referencia
                window.currentEditingDiagram = null;
            } else {
                // Crear nuevo diagrama (funci√≥n original)
                originalAddDiagramToCanvas();
            }
        };

        function showTemplatesModal() {
            document.getElementById('templatesModal').style.display = 'flex';
        }

        function loadTemplate(templateType) {
            const templates = {
                brainstorm: {
                    name: 'üß† Brainstorming Interactivo',
                    description: 'Herramienta completa para lluvia de ideas con conexiones y votaci√≥n',
                    setup: function() {
                        createBrainstormingWorkspace();
                    }
                },
                project: {
                    name: 'ÔøΩ Dashboard de Proyecto',
                    description: 'Storyboard interactivo con m√©tricas y seguimiento de tiempo',
                    setup: function() {
                        createProjectDashboard();
                    }
                },
                mindmap: {
                    name: 'üó∫Ô∏è Mapa Mental Din√°mico',
                    description: 'Mapa mental con conexiones visuales y expansi√≥n autom√°tica',
                    setup: function() {
                        createInteractiveMindMap();
                    }
                },
                timeline: {
                    name: '‚è∞ Cronolog√≠a Inteligente',
                    description: 'L√≠nea de tiempo con hitos, dependencias y alertas',
                    setup: function() {
                        createSmartTimeline();
                    }
                },
                planning: {
                    name: 'üìÖ Planificador de Tareas',
                    description: 'Sistema completo de planificaci√≥n con calendario y recordatorios',
                    setup: function() {
                        createTaskPlanner();
                    }
                },
                analysis: {
                    name: 'üìä Centro de An√°lisis',
                    description: 'Herramientas para an√°lisis FODA, matrices y comparativas',
                    setup: function() {
                        createAnalysisCenter();
                    }
                },
                learning: {
                    name: 'üìö Espacio de Aprendizaje',
                    description: 'Notas de estudio, flashcards y mapas conceptuales',
                    setup: function() {
                        createLearningSpace();
                    }
                },
                meeting: {
                    name: 'ü§ù Sala de Reuniones',
                    description: 'Agenda, actas, seguimiento de decisiones y tareas',
                    setup: function() {
                        createMeetingRoom();
                    }
                },
                storyboard: {
                    name: 'üé¨ Storyboard Interactivo',
                    description: 'Creaci√≥n de storyboards con paneles visuales y narrativa',
                    setup: function() {
                        createStoryboardWorkspace();
                    }
                }
            };
            
            const template = templates[templateType];
            if (template) {
                if (confirm(`¬øQuieres crear el workspace "${template.name}"?\n\n${template.description}\n\nEsto reemplazar√° el contenido actual del proyecto.`)) {
                    clearCanvasInternal();
                    
                    // Ejecutar la configuraci√≥n espec√≠fica de la plantilla
                    template.setup();
                    
                    // Guardar informaci√≥n de la plantilla en el proyecto
                    if (currentProject) {
                        currentProject.templateType = templateType;
                        currentProject.templateName = template.name;
                        localStorage.setItem('meowboard_projects', JSON.stringify(projects));
                    }
                    
                    saveBoard();
                    closeModal('templatesModal');
                    showProjectSwitchMessage(`üöÄ ${template.name} configurado y listo!`);
                }
            }
        }

        // ====== PLANTILLAS FUNCIONALES ======
        
        function createBrainstormingWorkspace() {
            // Centro de control del brainstorming
            createFunctionalBlock(50, 50, 'üß† Centro de Ideas', 
                'Tema: [Escribe tu tema aqu√≠]\n\n' +
                'üéØ Objetivo: \n' +
                '‚è±Ô∏è Duraci√≥n: 30 min\n' +
                'üë• Participantes: \n\n' +
                'ÔøΩ Ideas generadas: 0\n' +
                '‚≠ê Ideas destacadas: 0', 
                'control-center'
            );
            
            // Timer integrado
            createBrainstormTimer(320, 50);
            
            // Panel de votaci√≥n
            createVotingPanel(590, 50);
            
            // Generador de ideas
            createIdeaGenerator(50, 280);
            
            // Organizador por categor√≠as
            createCategoryOrganizer(350, 280);
            
            showNotificationMessage('üß† Brainstorming configurado: Generador de ideas, categor√≠as y votaci√≥n activos', 'success');
        }

        function createProjectDashboard() {
            // M√©tricas del proyecto
            createProjectMetrics(50, 50);
            
            // Panel de recursos
            createResourcePanel(320, 50);
            
            // Timeline del proyecto
            createProjectTimeline(50, 280);
            
            // Indicadores de progreso
            createProgressIndicators(50, 450);
            
            // Panel de tareas del proyecto
            createProjectTaskBoard(320, 280);
            
            showNotificationMessage('üìã Dashboard de proyecto creado: Storyboard, m√©tricas y timeline activos', 'success');
        }

        function createInteractiveMindMap() {
            // Herramientas de conexi√≥n
            createConnectionTools(50, 50);
            
            // Nodo central
            createCentralNode(400, 300, 'Tema Central');
            
            // Ramas principales distribuidas mejor
            const branches = [
                {x: 200, y: 200, title: 'üåü Rama 1', color: '#FF6B9D'},
                {x: 600, y: 200, title: 'üöÄ Rama 2', color: '#4ECDC4'},
                {x: 200, y: 400, title: 'üí° Rama 3', color: '#45B7D1'},
                {x: 600, y: 350, title: 'ÔøΩ Rama 4', color: '#96CEB4'}
            ];
            
            branches.forEach(branch => {
                createMindMapBranch(branch.x, branch.y, branch.title, branch.color);
            });
            
            // Herramientas de conexi√≥n
            createConnectionTools(50, 50);
            
            showNotificationMessage('üó∫Ô∏è Mapa Mental creado: Nodos expandibles y conexiones activas', 'success');
        }

        function createSmartTimeline() {
            // Panel de gesti√≥n de fechas
            createDateManager(50, 50);
            
            // Alertas y recordatorios
            createTimelineAlerts(320, 50);
            
            // L√≠nea de tiempo principal
            createTimelineBase(50, 280);
            
            // Hitos importantes distribuidos mejor
            const milestones = [
                {x: 100, date: '2024-01', title: 'Inicio', status: 'completed'},
                {x: 250, date: '2024-02', title: 'Desarrollo', status: 'current'},
                {x: 400, date: '2024-03', title: 'Testing', status: 'pending'},
                {x: 550, date: '2024-04', title: 'Lanzamiento', status: 'pending'}
            ];
            
            milestones.forEach(milestone => {
                createTimelineMilestone(milestone.x, 280, milestone);
            });
            
            showNotificationMessage('‚è∞ Timeline inteligente creado: Hitos, fechas y alertas configuradas', 'success');
        }

        function createTaskPlanner() {
            // Calendario integrado
            createMiniCalendar(50, 50);
            
            // Lista de tareas por prioridad
            createPriorityTaskList(320, 50);
            
            // Planificador semanal
            createWeeklyPlanner(590, 50);
            
            // Panel de objetivos
            createGoalsPanel(50, 350);
            
            // Tracker de h√°bitos
            createHabitTracker(350, 350);
            
            showNotificationMessage('üìÖ Planificador creado: Calendario, tareas y seguimiento de objetivos activos', 'success');
        }

        function createAnalysisCenter() {
            // Matriz FODA
            createSWOTMatrix(50, 50);
            
            // Matriz de decisiones
            createDecisionMatrix(350, 50);
            
            // An√°lisis de pros y contras
            createProsConsAnalysis(50, 350);
            
            // Comparador de opciones
            createOptionsComparator(350, 350);
            
            showNotificationMessage('üìä Centro de an√°lisis creado: FODA, matrices de decisi√≥n y comparativas', 'success');
        }

        function createLearningSpace() {
            // Generador de flashcards
            createFlashcardGenerator(50, 50);
            
            // Mapa conceptual
            createConceptMap(320, 50);
            
            // Notas de Cornell
            createCornellNotes(590, 50);
            
            // Tracker de progreso de estudio
            createStudyProgress(50, 350);
            
            // Banco de recursos
            createResourceBank(350, 350);
            
            showNotificationMessage('üìö Espacio de aprendizaje creado: Flashcards, mapas conceptuales y seguimiento', 'success');
        }

        function createMeetingRoom() {
            // Agenda de la reuni√≥n
            createMeetingAgenda(50, 50);
            
            // Actas en tiempo real
            createLiveMinutes(320, 50);
            
            // Panel de decisiones
            createDecisionTracker(590, 50);
            
            // Lista de seguimiento
            createFollowUpList(50, 350);
            
            // Timer de reuni√≥n
            createMeetingTimer(400, 350);
            
            showNotificationMessage('ü§ù Sala de reuniones configurada: Agenda, actas y seguimiento de decisiones', 'success');
        }

        function createStoryboardWorkspace() {
            // Storyboard principal
            createStoryboard(50, 50);
            
            // Panel de herramientas de narrativa
            createFunctionalBlock(50, 580, 'üìù Herramientas de Narrativa',
                'Estructura Narrativa:\n\n' +
                'üé¨ Acto I: Presentaci√≥n\n' +
                '‚ö° Acto II: Desarrollo/Conflicto\n' +
                'üéØ Acto III: Resoluci√≥n\n\n' +
                'Elementos visuales:\n' +
                'üì∑ Planos: General, Medio, Primer plano\n' +
                'üé® Colores: C√°lidos, Fr√≠os, Neutros\n' +
                'üí´ Transiciones: Corte, Fundido, Wipe',
                'narrative-tools'
            );
            
            // Panel de referencias
            createFunctionalBlock(900, 50, 'üé® Referencias Visuales',
                'Inspiraci√≥n y Referencias:\n\n' +
                'üé≠ Estilo visual:\n' +
                '‚Ä¢ Realismo\n' +
                '‚Ä¢ Cartoon\n' +
                '‚Ä¢ Minimalista\n\n' +
                'üéµ Mood/Atm√≥sfera:\n' +
                '‚Ä¢ Alegre\n' +
                '‚Ä¢ Dram√°tico\n' +
                '‚Ä¢ Misterioso\n\n' +
                '‚è±Ô∏è Timing: 30fps est√°ndar',
                'visual-references'
            );
            
            showNotificationMessage('üé¨ Storyboard configurado: Paneles visuales y herramientas de narrativa activos', 'success');
        }

        // ====== FUNCIONES AUXILIARES PARA PLANTILLAS ======
        
        function createFunctionalBlock(x, y, title, content, className = '') {
            const block = document.createElement('div');
            block.className = `functional-block ${className}`;
            block.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 300px;
                min-height: 200px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: 2px solid rgba(255,255,255,0.2);
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                color: white;
                font-family: 'Arial', sans-serif;
            `;
            
            block.innerHTML = `
                <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: bold;">${title}</h3>
                <div contenteditable="true" style="
                    background: rgba(255,255,255,0.1);
                    padding: 15px;
                    border-radius: 8px;
                    min-height: 120px;
                    line-height: 1.4;
                    white-space: pre-wrap;
                ">${content}</div>
                <button onclick="removeElement(this.parentElement)" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    width: 25px;
                    height: 25px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 14px;
                ">√ó</button>
            `;
            
            canvas.appendChild(block);
            makeDraggable(block);
            block.classList.add('wiggle');
            return block;
        }

        function createIdeaGenerator(x, y) {
            const generator = document.createElement('div');
            generator.className = 'idea-generator';
            generator.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 250px;
                background: linear-gradient(135deg, #FF6B9D 0%, #FF8A65 100%);
                border-radius: 15px;
                padding: 20px;
                color: white;
                box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            `;
            
            generator.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">üí° Generador de Ideas</h4>
                <input type="text" placeholder="Nueva idea..." style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    font-size: 14px;
                " onkeypress="if(event.key==='Enter') generateIdea(this)">
                <button onclick="generateIdea(this.previousElementSibling)" style="
                    background: rgba(255,255,255,0.3);
                    border: none;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    width: 100%;
                    font-weight: bold;
                ">‚ûï A√±adir Idea</button>
                <div class="idea-counter" style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                    Ideas generadas: 0
                </div>
            `;
            
            canvas.appendChild(generator);
            makeDraggable(generator);
            generator.classList.add('wiggle');
        }

        function generateIdea(input) {
            if (!input.value.trim()) return;
            
            const ideaText = input.value.trim();
            const colors = ['#FFE082', '#FFAB91', '#CE93D8', '#90CAF9', '#A5D6A7'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Crear sticky note con la idea
            const x = Math.random() * 400 + 200;
            const y = Math.random() * 200 + 300;
            
            const idea = document.createElement('div');
            idea.className = 'sticky-note generated-idea';
            idea.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 180px;
                height: 120px;
                background: ${randomColor};
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-size: 14px;
                line-height: 1.4;
            `;
            
            idea.innerHTML = `
                <div contenteditable="true" style="height: 70px; overflow: hidden;">${ideaText}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <span style="font-size: 12px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                    <button onclick="voteForIdea(this)" style="
                        background: none;
                        border: 1px solid #333;
                        border-radius: 15px;
                        padding: 2px 8px;
                        font-size: 12px;
                        cursor: pointer;
                    ">üëç 0</button>
                </div>
                <button onclick="removeElement(this.parentElement)" style="
                    position: absolute;
                    top: 5px;
                    right: 8px;
                    background: none;
                    border: none;
                    font-size: 14px;
                    cursor: pointer;
                ">√ó</button>
            `;
            
            canvas.appendChild(idea);
            makeDraggable(idea);
            idea.classList.add('wiggle');
            
            // Actualizar contador
            const counter = input.parentElement.querySelector('.idea-counter');
            const currentCount = parseInt(counter.textContent.match(/\d+/)[0]) + 1;
            counter.textContent = `Ideas generadas: ${currentCount}`;
            
            input.value = '';
            showNotificationMessage(`üí° Nueva idea agregada: "${ideaText}"`, 'success');
        }

        function voteForIdea(button) {
            const currentVotes = parseInt(button.textContent.match(/\d+/)[0]);
            const newVotes = currentVotes + 1;
            button.textContent = `üëç ${newVotes}`;
            
            // Cambiar color seg√∫n votos
            if (newVotes >= 3) {
                button.parentElement.parentElement.parentElement.style.border = '3px solid #4CAF50';
                button.parentElement.parentElement.parentElement.style.boxShadow = '0 4px 20px rgba(76, 175, 80, 0.4)';
            }
        }

        function createProjectTaskBoard(x, y) {
            createFunctionalBlock(x, y, 'üìã Tablero de Tareas',
                'Estado de Tareas del Proyecto:\n\n' +
                'üÜï Nuevas Tareas:\n' +
                '‚Ä¢ Definir arquitectura\n' +
                '‚Ä¢ Crear mockups\n' +
                '‚Ä¢ Configurar ambiente\n\n' +
                '‚ö° En Progreso:\n' +
                '‚Ä¢ Desarrollo backend\n' +
                '‚Ä¢ Dise√±o UI/UX\n\n' +
                '‚úÖ Completadas:\n' +
                '‚Ä¢ An√°lisis de requisitos\n' +
                '‚Ä¢ Setup del proyecto',
                'project-task-board'
            );
        }

        function createProjectMetrics(x, y) {
            const metrics = createFunctionalBlock(x, y, 'üìä M√©tricas del Proyecto',
                'üéØ Progreso General: 75%\n' +
                'üìã Tareas Totales: 12\n' +
                '‚úÖ Completadas: 9\n' +
                'üîÑ En Progreso: 2\n' +
                '‚è±Ô∏è Tiempo Invertido: 45h\n' +
                'üìÖ D√≠as Restantes: 7\n\n' +
                'üìà Rendimiento: Excelente\n' +
                '‚ö° Velocidad: 2.1 tareas/d√≠a',
                'project-metrics'
            );
            
            return metrics;
        }

        // Ahora voy a crear el Storyboard funcional
        function createStoryboard(x, y) {
            const storyboard = document.createElement('div');
            storyboard.className = 'storyboard-container';
            storyboard.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 900px;
                height: 600px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                padding: 20px;
                color: white;
                box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
                cursor: move;
            `;
            
            storyboard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0 0 5px 0;">üé¨ Storyboard Interactivo</h3>
                        <div style="font-size: 12px; opacity: 0.8;">Arrastra paneles para reordenar ‚Ä¢ Clic derecho para opciones</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addStoryPanel(this)" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 8px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">‚ûï A√±adir Panel</button>
                        <button onclick="exportStoryboard(this)" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 8px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">üì§ Exportar</button>
                    </div>
                </div>
                <div class="story-panels" style="
                    display: flex;
                    gap: 15px;
                    overflow-x: auto;
                    padding: 15px;
                    height: 500px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 10px;
                ">
                    <div class="story-panel" draggable="true" style="
                        min-width: 250px;
                        height: 450px;
                        background: rgba(255,255,255,0.15);
                        border-radius: 12px;
                        padding: 15px;
                        border: 2px solid rgba(255,255,255,0.3);
                        cursor: grab;
                        transition: all 0.3s;
                    ">
                        <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel 1</div>
                        <input type="text" placeholder="T√≠tulo de la escena" value="üé¨ Escena inicial" style="
                            width: 100%;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 12px;
                            margin-bottom: 10px;
                        ">
                        
                        <div class="story-image" onclick="uploadStoryImage(this)" style="
                            width: 100%;
                            height: 150px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 10px;
                            cursor: pointer;
                            border: 2px dashed rgba(255,255,255,0.4);
                            transition: all 0.3s;
                        ">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üì∑</div>
                                <div style="font-size: 11px;">Clic para subir imagen</div>
                            </div>
                        </div>
                        
                        <textarea placeholder="Descripci√≥n, di√°logos, notas..." style="
                            width: 100%;
                            height: 120px;
                            background: rgba(255,255,255,0.1);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 11px;
                            resize: none;
                            font-family: inherit;
                        "></textarea>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 5px;">
                            <select style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 4px;
                                border-radius: 4px;
                                font-size: 10px;
                                flex: 1;
                            ">
                                <option value="wide">Plano General</option>
                                <option value="medium">Plano Medio</option>
                                <option value="close">Primer Plano</option>
                                <option value="detail">Detalle</option>
                            </select>
                            <button onclick="deleteStoryPanel(this)" style="
                                background: #F44336;
                                border: none;
                                color: white;
                                padding: 4px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 10px;
                            ">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="story-panel" draggable="true" style="
                        min-width: 250px;
                        height: 450px;
                        background: rgba(255,255,255,0.15);
                        border-radius: 12px;
                        padding: 15px;
                        border: 2px solid rgba(255,255,255,0.3);
                        cursor: grab;
                        transition: all 0.3s;
                    ">
                        <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel 2</div>
                        <input type="text" placeholder="T√≠tulo de la escena" value="üí´ Desarrollo" style="
                            width: 100%;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 12px;
                            margin-bottom: 10px;
                        ">
                        
                        <div class="story-image" onclick="uploadStoryImage(this)" style="
                            width: 100%;
                            height: 150px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 10px;
                            cursor: pointer;
                            border: 2px dashed rgba(255,255,255,0.4);
                            transition: all 0.3s;
                        ">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">ÔøΩ</div>
                                <div style="font-size: 11px;">Clic para subir imagen</div>
                            </div>
                        </div>
                        
                        <textarea placeholder="Descripci√≥n, di√°logos, notas..." style="
                            width: 100%;
                            height: 120px;
                            background: rgba(255,255,255,0.1);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 6px;
                            color: white;
                            padding: 8px;
                            font-size: 11px;
                            resize: none;
                            font-family: inherit;
                        "></textarea>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 5px;">
                            <select style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 4px;
                                border-radius: 4px;
                                font-size: 10px;
                                flex: 1;
                            ">
                                <option value="wide">Plano General</option>
                                <option value="medium" selected>Plano Medio</option>
                                <option value="close">Primer Plano</option>
                                <option value="detail">Detalle</option>
                            </select>
                            <button onclick="deleteStoryPanel(this)" style="
                                background: #F44336;
                                border: none;
                                color: white;
                                padding: 4px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 10px;
                            ">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            canvas.appendChild(storyboard);
            makeDraggable(storyboard);
            storyboard.classList.add('wiggle');
            
            // Hacer los paneles arrastrables para reordenar
            enableStoryboardDragAndDrop(storyboard);
        }

        // Funciones auxiliares del Storyboard
        function addStoryPanel(button) {
            const container = button.closest('.storyboard-container');
            const panelsContainer = container.querySelector('.story-panels');
            const panelCount = panelsContainer.children.length + 1;
            
            const newPanel = document.createElement('div');
            newPanel.className = 'story-panel';
            newPanel.draggable = true;
            newPanel.style.cssText = `
                min-width: 250px;
                height: 450px;
                background: rgba(255,255,255,0.15);
                border-radius: 12px;
                padding: 15px;
                border: 2px solid rgba(255,255,255,0.3);
                cursor: grab;
                transition: all 0.3s;
            `;
            
            newPanel.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">Panel ${panelCount}</div>
                <input type="text" placeholder="T√≠tulo de la escena" value="üé¨ Nueva escena ${panelCount}" style="
                    width: 100%;
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 6px;
                    color: white;
                    padding: 8px;
                    font-size: 12px;
                    margin-bottom: 10px;
                ">
                
                <div class="story-image" onclick="uploadStoryImage(this)" style="
                    width: 100%;
                    height: 150px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 10px;
                    cursor: pointer;
                    border: 2px dashed rgba(255,255,255,0.4);
                    transition: all 0.3s;
                ">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üì∑</div>
                        <div style="font-size: 11px;">Clic para subir imagen</div>
                    </div>
                </div>
                
                <textarea placeholder="Descripci√≥n, di√°logos, notas..." style="
                    width: 100%;
                    height: 120px;
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 6px;
                    color: white;
                    padding: 8px;
                    font-size: 11px;
                    resize: none;
                    font-family: inherit;
                "></textarea>
                
                <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 5px;">
                    <select style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        color: white;
                        padding: 4px;
                        border-radius: 4px;
                        font-size: 10px;
                        flex: 1;
                    ">
                        <option value="wide">Plano General</option>
                        <option value="medium">Plano Medio</option>
                        <option value="close">Primer Plano</option>
                        <option value="detail">Detalle</option>
                    </select>
                    <button onclick="deleteStoryPanel(this)" style="
                        background: #F44336;
                        border: none;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 10px;
                    ">üóëÔ∏è</button>
                </div>
            `;
            
            panelsContainer.appendChild(newPanel);
            showNotificationMessage(`üé¨ Panel ${panelCount} a√±adido al storyboard`, 'success');
        }

        function uploadStoryImage(imageArea) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5000000) { // 5MB limit
                        showNotificationMessage('‚ö†Ô∏è La imagen es muy grande. M√°ximo 5MB.', 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageArea.style.backgroundImage = `url(${e.target.result})`;
                        imageArea.style.backgroundSize = 'cover';
                        imageArea.style.backgroundPosition = 'center';
                        imageArea.innerHTML = `
                            <div style="
                                position: absolute;
                                bottom: 5px;
                                right: 5px;
                                background: rgba(0,0,0,0.7);
                                color: white;
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 10px;
                            ">${file.name}</div>
                        `;
                        showNotificationMessage(`üñºÔ∏è Imagen "${file.name}" cargada`, 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }

        function deleteStoryPanel(button) {
            const panel = button.closest('.story-panel');
            const panelTitle = panel.querySelector('input').value;
            
            if (confirm(`¬øEliminar el panel "${panelTitle}"?`)) {
                panel.style.transform = 'scale(0)';
                panel.style.opacity = '0';
                setTimeout(() => {
                    panel.remove();
                    reorderStoryPanels();
                }, 200);
                showNotificationMessage(`üóëÔ∏è Panel "${panelTitle}" eliminado`, 'info');
            }
        }

        function reorderStoryPanels() {
            const storyboards = document.querySelectorAll('.storyboard-container');
            storyboards.forEach(storyboard => {
                const panels = storyboard.querySelectorAll('.story-panel');
                panels.forEach((panel, index) => {
                    const headerDiv = panel.querySelector('div');
                    headerDiv.textContent = `Panel ${index + 1}`;
                });
            });
        }

        function exportStoryboard(button) {
            const storyboard = button.closest('.storyboard-container');
            const panels = storyboard.querySelectorAll('.story-panel');
            
            let storyData = {
                title: 'Mi Storyboard',
                created: new Date().toISOString(),
                panels: []
            };
            
            panels.forEach((panel, index) => {
                const title = panel.querySelector('input').value;
                const description = panel.querySelector('textarea').value;
                const shotType = panel.querySelector('select').value;
                
                storyData.panels.push({
                    number: index + 1,
                    title: title,
                    description: description,
                    shotType: shotType
                });
            });
            
            // Crear y descargar archivo JSON
            const dataStr = JSON.stringify(storyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `storyboard_${new Date().getTime()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotificationMessage('üì§ Storyboard exportado como JSON', 'success');
        }

        function enableStoryboardDragAndDrop(storyboard) {
            const panelsContainer = storyboard.querySelector('.story-panels');
            let draggedElement = null;
            
            panelsContainer.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('story-panel')) {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                }
            });
            
            panelsContainer.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('story-panel')) {
                    e.target.style.opacity = '1';
                }
            });
            
            panelsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            panelsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(panelsContainer, e.clientX);
                
                if (draggedElement && afterElement == null) {
                    panelsContainer.appendChild(draggedElement);
                } else if (draggedElement) {
                    panelsContainer.insertBefore(draggedElement, afterElement);
                }
                
                reorderStoryPanels();
                showNotificationMessage('üé¨ Paneles reordenados', 'info');
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.story-panel:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function createMiniCalendar(x, y) {
            const calendar = document.createElement('div');
            calendar.className = 'mini-calendar';
            calendar.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 200px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                padding: 15px;
                color: white;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            `;
            
            const today = new Date();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            calendar.innerHTML = `
                <h4 style="margin: 0 0 10px 0; text-align: center;">üìÖ ${monthNames[today.getMonth()]} ${today.getFullYear()}</h4>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 12px;">
                    <div style="text-align: center; font-weight: bold;">D</div>
                    <div style="text-align: center; font-weight: bold;">L</div>
                    <div style="text-align: center; font-weight: bold;">M</div>
                    <div style="text-align: center; font-weight: bold;">M</div>
                    <div style="text-align: center; font-weight: bold;">J</div>
                    <div style="text-align: center; font-weight: bold;">V</div>
                    <div style="text-align: center; font-weight: bold;">S</div>
                    ${generateCalendarDays(today)}
                </div>
                <button onclick="addCalendarEvent(this)" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 8px;
                    border-radius: 6px;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 10px;
                    font-size: 12px;
                ">‚ûï Agregar Evento</button>
            `;
            
            canvas.appendChild(calendar);
            makeDraggable(calendar);
            calendar.classList.add('wiggle');
        }

        function generateCalendarDays(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            const today = date.getDate();
            
            let html = '';
            
            // Espacios en blanco para el inicio del mes
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += '<div></div>';
            }
            
            // D√≠as del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today;
                html += `<div style="
                    text-align: center; 
                    padding: 4px; 
                    cursor: pointer;
                    border-radius: 3px;
                    ${isToday ? 'background: rgba(255,255,255,0.3); font-weight: bold;' : ''}
                " onclick="selectCalendarDay(this)">${day}</div>`;
            }
            
            return html;
        }

        function createSWOTMatrix(x, y) {
            const swot = document.createElement('div');
            swot.className = 'swot-matrix';
            swot.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 300px;
                height: 200px;
                background: white;
                border: 2px solid #333;
                border-radius: 10px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            `;
            
            swot.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 30px 1fr 1fr; height: 100%;">
                    <div style="grid-column: 1/3; background: #333; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 8px 8px 0 0;">
                        üìä An√°lisis FODA
                    </div>
                    <div style="background: #4CAF50; color: white; padding: 8px; font-size: 12px; font-weight: bold;">
                        üí™ FORTALEZAS
                        <div contenteditable="true" style="font-weight: normal; margin-top: 5px; font-size: 11px;">‚Ä¢ Ventaja 1
‚Ä¢ Ventaja 2</div>
                    </div>
                    <div style="background: #FF9800; color: white; padding: 8px; font-size: 12px; font-weight: bold;">
                        ‚ö†Ô∏è DEBILIDADES
                        <div contenteditable="true" style="font-weight: normal; margin-top: 5px; font-size: 11px;">‚Ä¢ √Årea de mejora 1
‚Ä¢ √Årea de mejora 2</div>
                    </div>
                    <div style="background: #2196F3; color: white; padding: 8px; font-size: 12px; font-weight: bold;">
                        üöÄ OPORTUNIDADES
                        <div contenteditable="true" style="font-weight: normal; margin-top: 5px; font-size: 11px;">‚Ä¢ Oportunidad 1
‚Ä¢ Oportunidad 2</div>
                    </div>
                    <div style="background: #F44336; color: white; padding: 8px; font-size: 12px; font-weight: bold; border-radius: 0 0 8px 0;">
                        ‚ö° AMENAZAS
                        <div contenteditable="true" style="font-weight: normal; margin-top: 5px; font-size: 11px;">‚Ä¢ Riesgo 1
‚Ä¢ Riesgo 2</div>
                    </div>
                </div>
                <button onclick="removeElement(this.parentElement)" style="
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: rgba(255,255,255,0.8);
                    border: none;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    cursor: pointer;
                    font-size: 12px;
                ">√ó</button>
            `;
            
            canvas.appendChild(swot);
            makeDraggable(swot);
            swot.classList.add('wiggle');
        }

        // ====== FUNCIONES FALTANTES PARA PLANTILLAS ======

        function createCategoryOrganizer(x, y) {
            const organizer = createFunctionalBlock(x, y, 'üìÇ Organizador de Categor√≠as',
                'Arrastra ideas aqu√≠ para organizarlas:\n\n' +
                'üè∑Ô∏è Categor√≠a 1:\n' +
                'üè∑Ô∏è Categor√≠a 2:\n' +
                'üè∑Ô∏è Categor√≠a 3:\n\n' +
                'Haz clic en "Nueva Categor√≠a" para a√±adir m√°s',
                'category-organizer'
            );
            
            const newCatBtn = document.createElement('button');
            newCatBtn.textContent = '‚ûï Nueva Categor√≠a';
            newCatBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                cursor: pointer;
                margin-top: 10px;
            `;
            newCatBtn.onclick = () => addNewCategory(organizer);
            organizer.appendChild(newCatBtn);
        }

        function addNewCategory(organizer) {
            const categoryName = prompt('Nombre de la nueva categor√≠a:');
            if (!categoryName) return;
            
            const content = organizer.querySelector('[contenteditable]');
            content.innerHTML += `\nüè∑Ô∏è ${categoryName}:`;
            showNotificationMessage(`üìÇ Categor√≠a "${categoryName}" a√±adida`, 'success');
        }

        function createVotingPanel(x, y) {
            const panel = createFunctionalBlock(x, y, 'üó≥Ô∏è Panel de Votaci√≥n',
                'Top 3 Ideas M√°s Votadas:\n\n' +
                'ü•á [Esperando votos...]\n' +
                'ü•à [Esperando votos...]\n' +
                'ü•â [Esperando votos...]\n\n' +
                'Las ideas se actualizan autom√°ticamente',
                'voting-panel'
            );
            
            // Actualizar rankings cada 3 segundos
            setInterval(() => updateVotingRankings(panel), 3000);
        }

        function updateVotingRankings(panel) {
            const ideas = Array.from(document.querySelectorAll('.generated-idea'));
            const rankings = ideas
                .map(idea => {
                    const voteBtn = idea.querySelector('button[onclick*="voteForIdea"]');
                    const votes = voteBtn ? parseInt(voteBtn.textContent.match(/\d+/)[0]) : 0;
                    const text = idea.querySelector('[contenteditable]').textContent;
                    return { text, votes };
                })
                .sort((a, b) => b.votes - a.votes)
                .slice(0, 3);
            
            const content = panel.querySelector('[contenteditable]');
            content.innerHTML = 'Top 3 Ideas M√°s Votadas:\n\n' +
                `ü•á ${rankings[0]?.text || '[Esperando votos...]'} (${rankings[0]?.votes || 0} votos)\n` +
                `ü•à ${rankings[1]?.text || '[Esperando votos...]'} (${rankings[1]?.votes || 0} votos)\n` +
                `ü•â ${rankings[2]?.text || '[Esperando votos...]'} (${rankings[2]?.votes || 0} votos)\n\n` +
                'Actualizado: ' + new Date().toLocaleTimeString();
        }

        function createBrainstormTimer(x, y) {
            const timer = document.createElement('div');
            timer.className = 'brainstorm-timer';
            timer.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 180px;
                background: linear-gradient(135deg, #FF6B9D 0%, #FF8A65 100%);
                border-radius: 15px;
                padding: 15px;
                color: white;
                text-align: center;
                box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            `;
            
            let timeLeft = 1800; // 30 minutos
            let timerInterval = null;
            
            timer.innerHTML = `
                <h4 style="margin: 0 0 10px 0;">‚è±Ô∏è Timer</h4>
                <div class="time-display" style="font-size: 24px; font-weight: bold; margin: 10px 0;">30:00</div>
                <div style="display: flex; gap: 5px; justify-content: center;">
                    <button onclick="startBrainstormTimer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚ñ∂Ô∏è</button>
                    <button onclick="pauseBrainstormTimer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚è∏Ô∏è</button>
                    <button onclick="resetBrainstormTimer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üîÑ</button>
                </div>
            `;
            
            canvas.appendChild(timer);
            makeDraggable(timer);
            timer.classList.add('wiggle');
            
            window.brainstormTimer = { element: timer, timeLeft, timerInterval };
        }

        function startBrainstormTimer() {
            if (window.brainstormTimer.timerInterval) return;
            
            window.brainstormTimer.timerInterval = setInterval(() => {
                window.brainstormTimer.timeLeft--;
                updateTimerDisplay();
                
                if (window.brainstormTimer.timeLeft <= 0) {
                    clearInterval(window.brainstormTimer.timerInterval);
                    window.brainstormTimer.timerInterval = null;
                    showNotificationMessage('‚è∞ ¬°Tiempo de brainstorming terminado!', 'warning');
                }
            }, 1000);
        }

        function pauseBrainstormTimer() {
            if (window.brainstormTimer.timerInterval) {
                clearInterval(window.brainstormTimer.timerInterval);
                window.brainstormTimer.timerInterval = null;
            }
        }

        function resetBrainstormTimer() {
            pauseBrainstormTimer();
            window.brainstormTimer.timeLeft = 1800;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(window.brainstormTimer.timeLeft / 60);
            const seconds = window.brainstormTimer.timeLeft % 60;
            const display = window.brainstormTimer.element.querySelector('.time-display');
            display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function createProjectTimeline(x, y) {
            createFunctionalBlock(x, y, 'üìÖ Timeline del Proyecto',
                'Fase 1: Planificaci√≥n (Semana 1-2)\n' +
                '‚îú‚îÄ‚îÄ Definir objetivos ‚úÖ\n' +
                '‚îú‚îÄ‚îÄ Asignar recursos üîÑ\n' +
                '‚îî‚îÄ‚îÄ Crear cronograma ‚è≥\n\n' +
                'Fase 2: Desarrollo (Semana 3-6)\n' +
                '‚îú‚îÄ‚îÄ Desarrollo core ‚è≥\n' +
                '‚îú‚îÄ‚îÄ Testing ‚è≥\n' +
                '‚îî‚îÄ‚îÄ Documentaci√≥n ‚è≥\n\n' +
                'Fase 3: Lanzamiento (Semana 7-8)',
                'project-timeline'
            );
        }

        function createResourcePanel(x, y) {
            createFunctionalBlock(x, y, 'üë• Panel de Recursos',
                'Equipo del Proyecto:\n\n' +
                'üë®‚Äçüíª Desarrolladores: 3\n' +
                'üé® Dise√±adores: 1\n' +
                'üìä Project Manager: 1\n' +
                'üß™ Testers: 2\n\n' +
                'Presupuesto:\n' +
                'üí∞ Asignado: $50,000\n' +
                'üí∏ Utilizado: $15,000\n' +
                'üìà Restante: $35,000',
                'resource-panel'
            );
        }

        function createProgressIndicators(x, y) {
            const indicators = createFunctionalBlock(x, y, 'üìä Indicadores de Progreso',
                'Progreso por √Årea:\n\n' +
                'üéØ Desarrollo: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 80%\n' +
                'üé® Dise√±o: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 60%\n' +
                'üìã Documentaci√≥n: ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 40%\n' +
                'üß™ Testing: ‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 20%\n\n' +
                'Estado General: üü° En Progreso',
                'progress-indicators'
            );
            
            // Actualizar indicadores cada 10 segundos
            setInterval(() => updateProgressIndicators(indicators), 10000);
        }

        function updateProgressIndicators(indicators) {
            const areas = ['Desarrollo', 'Dise√±o', 'Documentaci√≥n', 'Testing'];
            const emojis = ['üéØ', 'üé®', 'üìã', 'üß™'];
            let content = 'Progreso por √Årea:\n\n';
            
            areas.forEach((area, index) => {
                const progress = Math.min(100, Math.floor(Math.random() * 20) + (index * 20));
                const bars = '‚ñà'.repeat(Math.floor(progress / 10)) + '‚ñë'.repeat(10 - Math.floor(progress / 10));
                content += `${emojis[index]} ${area}: ${bars} ${progress}%\n`;
            });
            
            content += '\nEstado General: üü° En Progreso\n';
            content += `Actualizado: ${new Date().toLocaleTimeString()}`;
            
            indicators.querySelector('[contenteditable]').innerHTML = content;
        }

        function createCentralNode(x, y, title) {
            const node = document.createElement('div');
            node.className = 'central-node';
            node.style.cssText = `
                position: absolute;
                left: ${x - 75}px;
                top: ${y - 40}px;
                width: 150px;
                height: 80px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
                cursor: move;
            `;
            
            node.innerHTML = `
                <div contenteditable="true" style="text-align: center; font-size: 14px;">${title}</div>
                <button onclick="addMindMapBranch(${x}, ${y})" style="
                    position: absolute;
                    bottom: -15px;
                    right: -15px;
                    background: #4CAF50;
                    border: none;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                ">+</button>
            `;
            
            canvas.appendChild(node);
            makeDraggable(node);
            node.classList.add('wiggle');
        }

        function createMindMapBranch(x, y, title, color) {
            const branch = document.createElement('div');
            branch.className = 'mind-map-branch';
            branch.style.cssText = `
                position: absolute;
                left: ${x - 60}px;
                top: ${y - 30}px;
                width: 120px;
                height: 60px;
                background: ${color};
                border-radius: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                cursor: move;
            `;
            
            branch.innerHTML = `
                <div contenteditable="true" style="text-align: center; font-size: 12px;">${title}</div>
                <button onclick="removeElement(this.parentElement)" style="
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: #F44336;
                    border: none;
                    color: white;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 12px;
                ">√ó</button>
            `;
            
            canvas.appendChild(branch);
            makeDraggable(branch);
            branch.classList.add('wiggle');
        }

        function addMindMapBranch(centerX, centerY) {
            const title = prompt('T√≠tulo de la nueva rama:');
            if (!title) return;
            
            const colors = ['#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Posici√≥n aleatoria alrededor del centro
            const angle = Math.random() * 2 * Math.PI;
            const distance = 150;
            const x = centerX + Math.cos(angle) * distance;
            const y = centerY + Math.sin(angle) * distance;
            
            createMindMapBranch(x, y, title, color);
            showNotificationMessage(`üåø Nueva rama "${title}" creada`, 'success');
        }

        function createConnectionTools(x, y) {
            createFunctionalBlock(x, y, 'üîó Herramientas de Conexi√≥n',
                'Instrucciones:\n\n' +
                '1. Arrastra las ramas para conectar ideas\n' +
                '2. Usa el bot√≥n + del nodo central\n' +
                '3. Edita el texto directamente\n' +
                '4. Usa diferentes colores por tema\n\n' +
                'Consejos:\n' +
                '‚Ä¢ Mant√©n las ideas concisas\n' +
                '‚Ä¢ Agrupa temas similares\n' +
                '‚Ä¢ Usa jerarqu√≠as visuales',
                'connection-tools'
            );
        }

        function createTimelineBase(x, y) {
            const timeline = document.createElement('div');
            timeline.className = 'timeline-base';
            timeline.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 500px;
                height: 4px;
                background: linear-gradient(90deg, #4CAF50 0%, #2196F3 50%, #FF9800 100%);
                border-radius: 2px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            
            canvas.appendChild(timeline);
        }

        function createTimelineMilestone(x, y, milestone) {
            const colors = {
                completed: '#4CAF50',
                current: '#2196F3',
                pending: '#FFC107'
            };
            
            const milestoneEl = document.createElement('div');
            milestoneEl.className = 'timeline-milestone';
            milestoneEl.style.cssText = `
                position: absolute;
                left: ${x - 20}px;
                top: ${y - 60}px;
                width: 40px;
                height: 40px;
                background: ${colors[milestone.status]};
                border: 4px solid white;
                border-radius: 50%;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                cursor: pointer;
            `;
            
            milestoneEl.innerHTML = `
                <div style="
                    position: absolute;
                    top: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    padding: 8px 12px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    font-size: 12px;
                    font-weight: bold;
                    text-align: center;
                    min-width: 80px;
                    color: #333;
                ">
                    ${milestone.title}<br>
                    <span style="font-size: 10px; opacity: 0.7;">${milestone.date}</span>
                </div>
            `;
            
            canvas.appendChild(milestoneEl);
            milestoneEl.classList.add('wiggle');
        }

        function createDateManager(x, y) {
            createFunctionalBlock(x, y, 'üìÖ Gestor de Fechas',
                'Fechas Importantes:\n\n' +
                'üéØ Inicio: 01/01/2024\n' +
                'üìã Milestone 1: 15/01/2024\n' +
                'üöÄ Beta Release: 01/02/2024\n' +
                'üèÜ Lanzamiento: 15/02/2024\n\n' +
                'D√≠as hasta pr√≥ximo hito: 7\n' +
                'Estado: ‚ö° En tiempo',
                'date-manager'
            );
        }

        function createTimelineAlerts(x, y) {
            createFunctionalBlock(x, y, 'üîî Alertas y Recordatorios',
                'Pr√≥ximas Alertas:\n\n' +
                '‚ö†Ô∏è Reuni√≥n de seguimiento\n' +
                '   Ma√±ana 10:00 AM\n\n' +
                'üìã Entrega de prototipo\n' +
                '   En 3 d√≠as\n\n' +
                'üß™ Inicio de testing\n' +
                '   En 1 semana\n\n' +
                'Configurar nueva alerta ‚ûï',
                'timeline-alerts'
            );
        }

        function addCalendarEvent(button) {
            const eventTitle = prompt('T√≠tulo del evento:');
            if (!eventTitle) return;
            
            const eventDate = prompt('Fecha (DD/MM/YYYY):');
            if (!eventDate) return;
            
            showNotificationMessage(`üìÖ Evento "${eventTitle}" agregado para ${eventDate}`, 'success');
        }

        function selectCalendarDay(dayElement) {
            const day = dayElement.textContent;
            const event = prompt(`Agregar evento para el d√≠a ${day}:`);
            if (event) {
                dayElement.style.background = 'rgba(255, 193, 7, 0.5)';
                dayElement.title = event;
                showNotificationMessage(`üìÖ Evento "${event}" agregado al d√≠a ${day}`, 'success');
            }
        }

        // Funciones faltantes para otras plantillas...

        function createPriorityTaskList(x, y) {
            createFunctionalBlock(x, y, 'üìã Tareas por Prioridad',
                'üî¥ Alta Prioridad:\n' +
                '‚Ä¢ Tarea cr√≠tica 1\n' +
                '‚Ä¢ Tarea cr√≠tica 2\n\n' +
                'üü° Media Prioridad:\n' +
                '‚Ä¢ Tarea importante 1\n' +
                '‚Ä¢ Tarea importante 2\n\n' +
                'üü¢ Baja Prioridad:\n' +
                '‚Ä¢ Tarea opcional 1\n' +
                '‚Ä¢ Tarea opcional 2',
                'priority-task-list'
            );
        }

        function createWeeklyPlanner(x, y) {
            createFunctionalBlock(x, y, 'üìÖ Planificador Semanal',
                'Lun: Reuni√≥n equipo (9:00)\n' +
                'Mar: Desarrollo feature A\n' +
                'Mi√©: Testing y revisi√≥n\n' +
                'Jue: Documentaci√≥n\n' +
                'Vie: Deploy y cierre\n' +
                'S√°b: Descanso\n' +
                'Dom: Planificaci√≥n siguiente semana',
                'weekly-planner'
            );
        }

        function createGoalsPanel(x, y) {
            createFunctionalBlock(x, y, 'üéØ Panel de Objetivos',
                'Objetivos del Mes:\n\n' +
                '‚úÖ Completar proyecto A\n' +
                'üîÑ Avanzar proyecto B (70%)\n' +
                '‚è≥ Iniciar proyecto C\n\n' +
                'M√©tricas:\n' +
                'üìä Productividad: 85%\n' +
                '‚è±Ô∏è Tiempo invertido: 120h\n' +
                'üéØ Objetivos logrados: 3/5',
                'goals-panel'
            );
        }

        function createHabitTracker(x, y) {
            createFunctionalBlock(x, y, 'üìà Tracker de H√°bitos',
                'H√°bitos de la Semana:\n\n' +
                'üí™ Ejercicio: ‚úÖ‚úÖ‚úÖ‚ùå‚úÖ‚ùå‚ùå\n' +
                'üìñ Lectura: ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚ùå\n' +
                'üíß Agua (8 vasos): ‚úÖ‚úÖ‚ùå‚úÖ‚úÖ‚úÖ‚úÖ\n' +
                'üßò Meditaci√≥n: ‚ùå‚úÖ‚úÖ‚ùå‚úÖ‚ùå‚ùå\n\n' +
                'Racha actual: üî• 5 d√≠as\n' +
                'Mejor racha: üèÜ 12 d√≠as',
                'habit-tracker'
            );
        }

        // Funciones para el resto de plantillas
        function createDecisionMatrix(x, y) {
            createFunctionalBlock(x, y, 'ü§î Matriz de Decisiones',
                'Criterios vs Opciones:\n\n' +
                '       | A | B | C |\n' +
                'Costo  | 3 | 5 | 2 |\n' +
                'Tiempo | 4 | 2 | 5 |\n' +
                'Calidad| 5 | 4 | 3 |\n' +
                'Riesgo | 2 | 4 | 3 |\n\n' +
                'Total  |14|15|13|\n' +
                'Ganador: Opci√≥n B ‚≠ê',
                'decision-matrix'
            );
        }

        function createProsConsAnalysis(x, y) {
            createFunctionalBlock(x, y, '‚öñÔ∏è Pros y Contras',
                '‚úÖ PROS:\n' +
                '‚Ä¢ Beneficio 1\n' +
                '‚Ä¢ Beneficio 2\n' +
                '‚Ä¢ Beneficio 3\n\n' +
                '‚ùå CONTRAS:\n' +
                '‚Ä¢ Desventaja 1\n' +
                '‚Ä¢ Desventaja 2\n\n' +
                'Veredicto: ‚úÖ Favorable\n' +
                'Confianza: 75%',
                'pros-cons-analysis'
            );
        }

        function createOptionsComparator(x, y) {
            createFunctionalBlock(x, y, 'üîç Comparador de Opciones',
                'Opci√≥n A vs Opci√≥n B vs Opci√≥n C\n\n' +
                'üí∞ Precio: $100 | $150 | $80\n' +
                '‚≠ê Calidad: 8/10 | 9/10 | 7/10\n' +
                '‚è±Ô∏è Tiempo: 2 sem | 3 sem | 1 sem\n' +
                'üéØ Efectividad: Alta | Muy Alta | Media\n\n' +
                'Recomendaci√≥n: Opci√≥n B\n' +
                'Raz√≥n: Mejor calidad/precio',
                'options-comparator'
            );
        }

        function createFlashcardGenerator(x, y) {
            createFunctionalBlock(x, y, 'üÉè Generador de Flashcards',
                'Crear Nueva Tarjeta:\n\n' +
                'Pregunta: [Haz clic para editar]\n' +
                'Respuesta: [Haz clic para editar]\n\n' +
                'Tarjetas creadas: 0\n' +
                '√öltima revisi√≥n: Nunca\n\n' +
                'Estado: üìù Listo para crear',
                'flashcard-generator'
            );
        }

        function createConceptMap(x, y) {
            createFunctionalBlock(x, y, 'üó∫Ô∏è Mapa Conceptual',
                'Conceptos Principales:\n\n' +
                'üéØ Concepto Central\n' +
                '‚îú‚îÄ‚îÄ Subtema 1\n' +
                '‚îÇ   ‚îú‚îÄ‚îÄ Detalle A\n' +
                '‚îÇ   ‚îî‚îÄ‚îÄ Detalle B\n' +
                '‚îú‚îÄ‚îÄ Subtema 2\n' +
                '‚îÇ   ‚îú‚îÄ‚îÄ Detalle C\n' +
                '‚îÇ   ‚îî‚îÄ‚îÄ Detalle D\n' +
                '‚îî‚îÄ‚îÄ Subtema 3',
                'concept-map'
            );
        }

        function createCornellNotes(x, y) {
            createFunctionalBlock(x, y, 'üìù Notas de Cornell',
                'Cues (Pistas)     | Notas\n' +
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
                'Concepto clave 1   | Explicaci√≥n detallada\n' +
                '                   | del concepto y sus\n' +
                '                   | aplicaciones pr√°cticas\n' +
                '                   |\n' +
                'Concepto clave 2   | Otra explicaci√≥n\n' +
                '                   | importante\n' +
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
                'Resumen: Puntos clave de la sesi√≥n',
                'cornell-notes'
            );
        }

        function createStudyProgress(x, y) {
            createFunctionalBlock(x, y, 'üìä Progreso de Estudio',
                'Materias en Progreso:\n\n' +
                'üìö Matem√°ticas: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 80%\n' +
                'üß™ Ciencias: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 60%\n' +
                'üìñ Literatura: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë 50%\n' +
                'üó£Ô∏è Ingl√©s: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë 70%\n\n' +
                'Tiempo de estudio hoy: 4h\n' +
                'Meta semanal: 25h (16h completadas)',
                'study-progress'
            );
        }

        function createResourceBank(x, y) {
            createFunctionalBlock(x, y, 'üìÅ Banco de Recursos',
                'Recursos Disponibles:\n\n' +
                'üìñ Libros: 15\n' +
                'üé• Videos: 28\n' +
                'üìÑ PDFs: 42\n' +
                'üîó Enlaces: 67\n' +
                'üéß Audios: 12\n\n' +
                '√öltimos a√±adidos:\n' +
                '‚Ä¢ Gu√≠a de JavaScript\n' +
                '‚Ä¢ Tutorial de React\n' +
                '‚Ä¢ Curso de Python',
                'resource-bank'
            );
        }

        function createMeetingAgenda(x, y) {
            createFunctionalBlock(x, y, 'üìã Agenda de Reuni√≥n',
                'Reuni√≥n: [T√≠tulo]\n' +
                'Fecha: ' + new Date().toLocaleDateString() + '\n' +
                'Hora: [HH:MM]\n\n' +
                'Agenda:\n' +
                '1. Revisi√≥n de objetivos (10 min)\n' +
                '2. Progreso de proyecto (20 min)\n' +
                '3. Bloqueadores y soluciones (15 min)\n' +
                '4. Pr√≥ximos pasos (10 min)\n' +
                '5. Q&A (5 min)\n\n' +
                'Duraci√≥n total: 60 min',
                'meeting-agenda'
            );
        }

        function createLiveMinutes(x, y) {
            createFunctionalBlock(x, y, 'üìù Actas en Tiempo Real',
                'Acta de Reuni√≥n - ' + new Date().toLocaleDateString() + '\n\n' +
                'Participantes:\n' +
                '‚Ä¢ [Nombre 1]\n' +
                '‚Ä¢ [Nombre 2]\n' +
                '‚Ä¢ [Nombre 3]\n\n' +
                'Puntos Discutidos:\n' +
                '1. [Punto importante]\n' +
                '2. [Decisi√≥n tomada]\n' +
                '3. [Acci√≥n acordada]\n\n' +
                'Pr√≥xima reuni√≥n: [Fecha]',
                'live-minutes'
            );
        }

        function createDecisionTracker(x, y) {
            createFunctionalBlock(x, y, '‚úÖ Tracker de Decisiones',
                'Decisiones de la Reuni√≥n:\n\n' +
                '‚úÖ Decidido: Usar React para frontend\n' +
                '‚úÖ Decidido: Sprint de 2 semanas\n' +
                'ü§î Pendiente: Elecci√≥n de base de datos\n' +
                '‚è≥ En discusi√≥n: Presupuesto adicional\n\n' +
                'Responsables asignados: 3\n' +
                'Decisiones implementadas: 2/4',
                'decision-tracker'
            );
        }

        function createFollowUpList(x, y) {
            createFunctionalBlock(x, y, 'üìã Lista de Seguimiento',
                'Tareas de Seguimiento:\n\n' +
                'üìß Juan: Enviar propuesta (Viernes)\n' +
                'üìä Mar√≠a: Preparar m√©tricas (Lunes)\n' +
                'üîß Pedro: Configurar servidor (Mi√©rcoles)\n' +
                'üìû Ana: Llamar al cliente (Hoy)\n\n' +
                'Tareas completadas: 2/8\n' +
                'Pr√≥xima revisi√≥n: Viernes 2:00 PM',
                'follow-up-list'
            );
        }

        function createMeetingTimer(x, y) {
            const timer = document.createElement('div');
            timer.className = 'meeting-timer';
            timer.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 200px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                padding: 20px;
                color: white;
                text-align: center;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            `;
            
            timer.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">‚è∞ Timer de Reuni√≥n</h4>
                <div style="font-size: 28px; font-weight: bold; margin: 15px 0;">60:00</div>
                <div style="display: flex; gap: 8px; justify-content: center; margin: 15px 0;">
                    <button style="background: #4CAF50; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚ñ∂Ô∏è</button>
                    <button style="background: #FF9800; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚è∏Ô∏è</button>
                    <button style="background: #F44336; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üîÑ</button>
                </div>
                <div style="font-size: 12px; opacity: 0.8;">Tiempo promedio: 45 min</div>
            `;
            
            canvas.appendChild(timer);
            makeDraggable(timer);
            timer.classList.add('wiggle');
        }

        // ====== SISTEMA DE ASSETS COMPLETO ======
        
        let assetsData = {
            icons: {
                work: ['üíº', 'üìä', 'üìà', 'üìâ', 'üìã', 'üìù', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üíª', 'üì±', 'üìû', 'üìß', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üóÉÔ∏è', 'üìÑ', 'üìÉ', 'üìë', 'üìú', 'üóûÔ∏è', 'üì∞', 'üìì', 'üìî', 'üìí', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üè∑Ô∏è', 'üí≥', 'üé´', 'üéüÔ∏è', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', '‚≠ê', 'üåü', '‚ú®', 'üí´', 'üî•', 'üí°', 'üîç', 'üîé', 'üîß', 'üî®', '‚öôÔ∏è', 'üõ†Ô∏è'],
                education: ['üéì', 'üìö', 'üìñ', 'üìù', '‚úèÔ∏è', 'üñäÔ∏è', 'üñãÔ∏è', '‚úíÔ∏è', 'üñçÔ∏è', 'üìè', 'üìê', 'üìå', 'üìç', 'üßÆ', 'üî¨', 'üß™', 'üß¨', '‚öóÔ∏è', 'üå°Ô∏è', 'üíä', 'ü©∫', 'üè´', 'üéí', 'üìê', 'üñáÔ∏è', 'üìé', '‚úÇÔ∏è', 'üìã', 'üìä', 'üìà', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÖ', 'üìÜ', 'üîî', 'üîï', 'üì¢', 'üì£', 'üìØ', 'üé∫', 'üìª', 'üéµ', 'üé∂', 'üéº', 'üéπ', 'üé∏', 'ü•Å', 'üé§', 'üéß', 'üé®', 'üñåÔ∏è', 'üñçÔ∏è', 'üé≠', 'üé™'],
                design: ['üé®', 'üñåÔ∏è', 'üñçÔ∏è', '‚úèÔ∏è', 'üñäÔ∏è', 'üñãÔ∏è', '‚úíÔ∏è', 'üñáÔ∏è', 'üìé', 'üìè', 'üìê', 'üìå', 'üìç', 'üé≠', 'üé™', 'üé®', 'üñºÔ∏è', 'üåà', 'üéÜ', 'üéá', '‚ú®', 'üí´', '‚≠ê', 'üåü', 'üî•', 'üí•', 'üí¢', 'üí®', 'üí§', 'üí¶', 'üíß', 'üåä', 'üåÄ', 'üå™Ô∏è', '‚ö°', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚òÅÔ∏è', 'üå´Ô∏è', 'üå¨Ô∏è', 'üí®', '‚ùÑÔ∏è', '‚õÑ', '‚òÉÔ∏è'],
                shapes: ['‚ö™', '‚ö´', 'üî¥', 'üîµ', 'üü†', 'üü°', 'üü¢', 'üü£', 'üü§', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è'],
                arrows: ['‚¨ÜÔ∏è', '‚ÜóÔ∏è', '‚û°Ô∏è', '‚ÜòÔ∏è', '‚¨áÔ∏è', '‚ÜôÔ∏è', '‚¨ÖÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü©Ô∏è', '‚Ü™Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÉ', 'üîÑ', 'üîô', 'üîö', 'üîõ', 'üîú', 'üîù', 'üõê', '‚öõÔ∏è', 'üïâÔ∏è', '‚ú°Ô∏è', '‚ò∏Ô∏è', '‚òØÔ∏è', '‚úùÔ∏è', '‚ò¶Ô∏è', '‚ò™Ô∏è', '‚òÆÔ∏è', 'üïé', 'üîØ', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', '‚õé', 'üîÄ', 'üîÅ', 'üîÇ', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™'],
                nature: ['üå±', 'üåø', 'üçÄ', 'üåæ', 'üåµ', 'üå≤', 'üå≥', 'üå¥', 'üéã', 'üéç', 'üå∏', 'üå∫', 'üåª', 'üåπ', 'ü•Ä', 'üå∑', 'üåº', 'üåª', 'üèµÔ∏è', 'üåæ', 'üåø', 'üçÄ', 'üå±', 'üåä', 'üåÄ', 'üåà', 'üåÇ', '‚òÇÔ∏è', '‚õ±Ô∏è', '‚ö°', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚òÅÔ∏è', 'üå´Ô∏è', 'üå¨Ô∏è', 'üçÉ', 'üí®', 'üå™Ô∏è', 'üåä', 'üíß', 'üí¶', '‚òî', 'üåà'],
                food: ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï'],
                emoji: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', '‚ò∫Ô∏è', 'üòö', 'üòô', 'ü•≤', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üò∂‚Äçüå´Ô∏è', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'üòÆ‚Äçüí®', 'ü§•', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'üòµ‚Äçüí´', 'ü§Ø', 'ü§†', 'ü•≥', 'ü•∏', 'üòé']
            },
            patterns: {
                geometric: ['‚ñ≤', '‚ñº', '‚óÄ', '‚ñ∂', '‚óÜ', '‚óá', '‚óã', '‚óè', '‚óê', '‚óë', '‚óí', '‚óì', '‚ñ°', '‚ñ†', '‚óä', '‚óà', '‚¨ü', '‚¨¢', '‚¨°', '‚¨†', '‚¨ú', '‚¨õ', '‚ñ´', '‚ñ™', '‚óΩ', '‚óæ', '‚óª', '‚óº', 'üî≤', 'üî≥'],
                decorative: ['‚ú®', 'üí´', '‚≠ê', 'üåü', 'üí•', 'üí¢', 'üí®', 'üí§', 'üí¶', 'üíß', 'üåä', 'üåÄ', 'üå™Ô∏è', '‚ö°', 'üî•', 'üí°', 'üéÜ', 'üéá', '‚ú¥Ô∏è', '‚ùáÔ∏è', 'üå†', 'üéä', 'üéâ', 'ü™©', 'üîÆ'],
                symbols: ['‚ô†', '‚ô£', '‚ô•', '‚ô¶', '‚ô™', '‚ô´', '‚ô¨', '‚ô≠', '‚ôÆ', '‚ôØ', '‚àû', '‚ô±', '‚ô≤', '‚ô≥', '‚ô¥', '‚ôµ', '‚ô∂', '‚ô∑', '‚ô∏', '‚ôπ', '‚ô∫', '‚ôª', '‚ôº', '‚ôΩ', '‚ôæ', '‚ôø', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ']
            },
            favorites: []
        };

        let currentAssetCategory = 'work';
        let currentAssetType = 'icons';
        let assetSearchTerm = '';

        function showAssetsModal() {
            // Crear el modal si no existe
            let modal = document.getElementById('assetsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'assetsModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">üé® Biblioteca de Assets</h3>
                            <button class="modal-close" onclick="closeModal('assetsModal')">√ó</button>
                        </div>
                        <div class="assets-content" style="padding: 20px;">
                            <!-- Barra de b√∫squeda -->
                            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="assetSearch" placeholder="ÔøΩ Buscar assets..." 
                                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                                           oninput="searchAssets(this.value)">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <select id="assetTypeSelect" onchange="changeAssetType(this.value)" style="
                                        padding: 8px 15px; 
                                        border: 2px solid #ddd; 
                                        border-radius: 6px; 
                                        background: white;
                                        font-size: 14px;
                                        cursor: pointer;
                                    ">
                                        <option value="icons">üéØ Iconos</option>
                                        <option value="patterns">üé® Patrones</option>
                                    </select>
                                    <button onclick="toggleFavorites()" style="
                                        padding: 8px 15px; 
                                        background: #FF6B9D; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 6px; 
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">üíù Favoritos</button>
                                </div>
                            </div>
                            
                            <!-- Pesta√±as de categor√≠as -->
                            <div id="assetCategories" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px;">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                            
                            <!-- Grid de assets -->
                            <div id="assetsGrid" style="
                                display: grid; 
                                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
                                gap: 10px; 
                                max-height: 400px; 
                                overflow-y: auto; 
                                padding: 15px;
                                background: #f8f9fa;
                                border-radius: 10px;
                                border: 2px dashed #ddd;
                            ">
                                <!-- Assets se cargan aqu√≠ -->
                            </div>
                            
                            <!-- √Årea de subida de assets personalizados -->
                            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                                <h4 style="margin: 0 0 10px 0; color: #1565c0;">ÔøΩ Assets Personalizados</h4>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="file" id="customAssetUpload" accept="image/*" multiple 
                                           style="display: none;" onchange="uploadCustomAssets(this.files)">
                                    <button onclick="document.getElementById('customAssetUpload').click()" style="
                                        padding: 8px 15px; 
                                        background: #1976d2; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 6px; 
                                        cursor: pointer;
                                    ">üì§ Subir Im√°genes</button>
                                    <span style="font-size: 12px; color: #666;">Sube tus propios iconos e im√°genes (PNG, JPG, SVG)</span>
                                </div>
                            </div>
                            
                            <!-- Instrucciones -->
                            <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 8px; font-size: 13px; color: #e65100;">
                                üí° <strong>C√≥mo usar:</strong> Haz clic en cualquier asset para agregarlo al canvas, o arr√°stralo directamente. 
                                Usa ‚ù§Ô∏è para marcar favoritos y acceder r√°pidamente.
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Inicializar el modal
            loadAssetCategories();
            loadAssetsGrid();
            modal.style.display = 'block';
        }

        function loadAssetCategories() {
            const categoriesContainer = document.getElementById('assetCategories');
            const categories = Object.keys(assetsData[currentAssetType]);
            
            categoriesContainer.innerHTML = categories.map(category => {
                const isActive = category === currentAssetCategory;
                return `
                    <button onclick="changeAssetCategory('${category}')" style="
                        padding: 8px 16px; 
                        background: ${isActive ? '#4CAF50' : '#f5f5f5'}; 
                        color: ${isActive ? 'white' : '#333'}; 
                        border: 2px solid ${isActive ? '#4CAF50' : '#ddd'}; 
                        border-radius: 20px; 
                        cursor: pointer;
                        font-size: 12px;
                        transition: all 0.3s;
                    " onmouseover="if('${category}' !== '${currentAssetCategory}') { this.style.background='#e8f5e8'; }" 
                       onmouseout="if('${category}' !== '${currentAssetCategory}') { this.style.background='#f5f5f5'; }">
                        ${getCategoryDisplayName(category)}
                    </button>
                `;
            }).join('');
        }

        function getCategoryDisplayName(category) {
            const names = {
                work: 'üíº Trabajo',
                education: 'üéì Educaci√≥n', 
                design: 'üé® Dise√±o',
                shapes: '‚ö™ Formas',
                arrows: '‚û°Ô∏è Flechas',
                nature: 'üå± Naturaleza',
                food: 'üçé Comida',
                emoji: 'üòä Emojis',
                geometric: '‚óÜ Geom√©trico',
                decorative: '‚ú® Decorativo',
                symbols: '‚ô† S√≠mbolos'
            };
            return names[category] || category;
        }

        function changeAssetType(type) {
            currentAssetType = type;
            currentAssetCategory = Object.keys(assetsData[type])[0];
            loadAssetCategories();
            loadAssetsGrid();
        }

        function changeAssetCategory(category) {
            currentAssetCategory = category;
            loadAssetCategories();
            loadAssetsGrid();
        }

        function loadAssetsGrid() {
            const grid = document.getElementById('assetsGrid');
            let assets = [];
            
            if (assetSearchTerm) {
                // Buscar en todas las categor√≠as si hay t√©rmino de b√∫squeda
                Object.values(assetsData[currentAssetType]).forEach(categoryAssets => {
                    assets = assets.concat(categoryAssets.filter(asset => 
                        asset.toLowerCase().includes(assetSearchTerm.toLowerCase())
                    ));
                });
            } else {
                // Mostrar categor√≠a actual
                assets = assetsData[currentAssetType][currentAssetCategory] || [];
            }
            
            grid.innerHTML = assets.map(asset => {
                const isFavorite = assetsData.favorites.includes(asset);
                return `
                    <div class="asset-item" style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 10px;
                        background: white;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s;
                        border: 2px solid transparent;
                        position: relative;
                    " 
                    onclick="addAssetToCanvas('${asset}')"
                    onmouseover="this.style.borderColor='#4CAF50'; this.style.transform='scale(1.1)';"
                    onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';"
                    draggable="true" 
                    ondragstart="startAssetDrag(event, '${asset}')">
                        <div style="font-size: 24px; margin-bottom: 5px;">${asset}</div>
                        <button onclick="event.stopPropagation(); toggleFavorite('${asset}')" style="
                            position: absolute;
                            top: 2px;
                            right: 2px;
                            background: none;
                            border: none;
                            font-size: 12px;
                            cursor: pointer;
                            opacity: 0.7;
                        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                            ${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                    </div>
                `;
            }).join('');
            
            if (assets.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        ${assetSearchTerm ? 'üîç No se encontraron assets que coincidan con tu b√∫squeda.' : 'üì≠ No hay assets en esta categor√≠a.'}
                    </div>
                `;
            }
        }

        function searchAssets(term) {
            assetSearchTerm = term;
            loadAssetsGrid();
        }

        function toggleFavorite(asset) {
            const index = assetsData.favorites.indexOf(asset);
            if (index > -1) {
                assetsData.favorites.splice(index, 1);
            } else {
                assetsData.favorites.push(asset);
            }
            loadAssetsGrid();
            // Guardar en localStorage
            localStorage.setItem('meowboard_favorite_assets', JSON.stringify(assetsData.favorites));
        }

        function toggleFavorites() {
            if (currentAssetCategory === 'favorites') {
                // Volver a la categor√≠a anterior
                currentAssetCategory = Object.keys(assetsData[currentAssetType])[0];
            } else {
                // Mostrar favoritos
                currentAssetCategory = 'favorites';
            }
            loadAssetCategories();
            loadFavoritesGrid();
        }

        function loadFavoritesGrid() {
            if (currentAssetCategory !== 'favorites') {
                loadAssetsGrid();
                return;
            }
            
            const grid = document.getElementById('assetsGrid');
            const favorites = assetsData.favorites;
            
            grid.innerHTML = favorites.map(asset => `
                <div class="asset-item" style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 10px;
                    background: white;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: 2px solid #FF6B9D;
                " 
                onclick="addAssetToCanvas('${asset}')"
                onmouseover="this.style.transform='scale(1.1)';"
                onmouseout="this.style.transform='scale(1)';"
                draggable="true" 
                ondragstart="startAssetDrag(event, '${asset}')">
                    <div style="font-size: 24px; margin-bottom: 5px;">${asset}</div>
                    <button onclick="event.stopPropagation(); toggleFavorite('${asset}')" style="
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        background: none;
                        border: none;
                        font-size: 12px;
                        cursor: pointer;
                    ">‚ù§Ô∏è</button>
                </div>
            `).join('');
            
            if (favorites.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        üíù No tienes assets favoritos a√∫n.<br>
                        <small>Haz clic en ü§ç en cualquier asset para agregarlo a favoritos.</small>
                    </div>
                `;
            }
        }

        function addAssetToCanvas(asset) {
            // Agregar el asset como un elemento draggable en el canvas
            const assetElement = document.createElement('div');
            assetElement.className = 'asset-element';
            assetElement.style.cssText = `
                position: absolute;
                left: ${Math.random() * 200 + 50}px;
                top: ${Math.random() * 200 + 50}px;
                font-size: 48px;
                cursor: move;
                user-select: none;
                z-index: 1000;
                transition: transform 0.2s;
            `;
            assetElement.textContent = asset;
            assetElement.title = `Asset: ${asset} (Doble clic para editar tama√±o)`;
            
            // Hacer el elemento draggable
            makeDraggable(assetElement);
            
            // Doble clic para cambiar tama√±o
            assetElement.addEventListener('dblclick', function() {
                const currentSize = parseInt(this.style.fontSize) || 48;
                const sizes = [24, 32, 48, 64, 96, 128];
                const currentIndex = sizes.indexOf(currentSize);
                const nextIndex = (currentIndex + 1) % sizes.length;
                this.style.fontSize = sizes[nextIndex] + 'px';
                showNotificationMessage(`üìè Tama√±o cambiado a ${sizes[nextIndex]}px`, 'info');
            });
            
            // Clic derecho para opciones
            assetElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showAssetContextMenu(e, assetElement);
            });
            
            canvas.appendChild(assetElement);
            assetElement.classList.add('wiggle');
            showNotificationMessage(`‚ú® Asset "${asset}" agregado al canvas`, 'success');
            
            // Cerrar modal si est√° abierto
            closeModal('assetsModal');
        }

        function showAssetContextMenu(e, assetElement) {
            // Crear men√∫ contextual para el asset
            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.cssText = `
                position: fixed;
                left: ${e.clientX}px;
                top: ${e.clientY}px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                padding: 8px 0;
                font-size: 14px;
            `;
            
            contextMenu.innerHTML = `
                <div onclick="changeAssetColor()" style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                    üé® Cambiar color
                </div>
                <div onclick="duplicateAsset()" style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                    üìÑ Duplicar
                </div>
                <div onclick="rotateAsset()" style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                    üîÑ Rotar
                </div>
                <div onclick="deleteAssetElement()" style="padding: 8px 16px; cursor: pointer; color: #d32f2f;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='white'">
                    üóëÔ∏è Eliminar
                </div>
            `;
            
            document.body.appendChild(contextMenu);
            
            // Variables para las funciones del men√∫
            window.currentContextAsset = assetElement;
            
            // Funci√≥n para cambiar color
            window.changeAssetColor = function() {
                const colors = ['#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
                const currentColor = assetElement.style.color || '#000000';
                const currentIndex = colors.indexOf(currentColor);
                const nextIndex = (currentIndex + 1) % colors.length;
                assetElement.style.color = colors[nextIndex];
                removeContextMenu();
            };
            
            // Funci√≥n para duplicar
            window.duplicateAsset = function() {
                const clone = assetElement.cloneNode(true);
                clone.style.left = (parseInt(assetElement.style.left) + 50) + 'px';
                clone.style.top = (parseInt(assetElement.style.top) + 50) + 'px';
                makeDraggable(clone);
                canvas.appendChild(clone);
                removeContextMenu();
                showNotificationMessage('üìÑ Asset duplicado', 'success');
            };
            
            // Funci√≥n para rotar
            window.rotateAsset = function() {
                const currentRotation = assetElement.style.transform.match(/rotate\\((.+?)deg\\)/);
                const rotation = currentRotation ? parseInt(currentRotation[1]) : 0;
                const newRotation = (rotation + 45) % 360;
                assetElement.style.transform = `rotate(${newRotation}deg)`;
                removeContextMenu();
            };
            
            // Funci√≥n para eliminar
            window.deleteAssetElement = function() {
                if (confirm('¬øEliminar este asset del canvas?')) {
                    assetElement.remove();
                    showNotificationMessage('üóëÔ∏è Asset eliminado', 'info');
                }
                removeContextMenu();
            };
            
            // Funci√≥n para remover men√∫
            window.removeContextMenu = function() {
                if (contextMenu.parentNode) {
                    contextMenu.parentNode.removeChild(contextMenu);
                }
            };
            
            // Cerrar al hacer clic fuera
            setTimeout(() => {
                document.addEventListener('click', removeContextMenu, { once: true });
            }, 100);
        }

        function startAssetDrag(event, asset) {
            event.dataTransfer.setData('text/plain', asset);
            event.dataTransfer.effectAllowed = 'copy';
        }

        function uploadCustomAssets(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const customAsset = document.createElement('div');
                        customAsset.className = 'custom-asset-element';
                        customAsset.style.cssText = `
                            position: absolute;
                            left: ${Math.random() * 200 + 50}px;
                            top: ${Math.random() * 200 + 50}px;
                            width: 64px;
                            height: 64px;
                            background-image: url(${e.target.result});
                            background-size: cover;
                            background-position: center;
                            border-radius: 8px;
                            cursor: move;
                            user-select: none;
                            z-index: 1000;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        `;
                        customAsset.title = `Imagen personalizada: ${file.name}`;
                        
                        makeDraggable(customAsset);
                        canvas.appendChild(customAsset);
                        customAsset.classList.add('wiggle');
                    };
                    reader.readAsDataURL(file);
                }
            });
            showNotificationMessage(`üìÅ ${files.length} imagen(es) personalizada(s) agregada(s)`, 'success');
        }

        // ====== SISTEMA DE USUARIOS Y COLABORACI√ìN COMPLETO ======
        
        // Estructura de datos para usuarios y colaboraci√≥n
        let currentUser = null;
        let collaborativeProjects = {};
        let onlineUsers = {};
        let projectPermissions = {};
        let collaborationSession = null;
        
        // Simulaci√≥n de base de datos de usuarios (en producci√≥n ser√≠a API)
        let usersDatabase = {
            users: JSON.parse(localStorage.getItem('meowboard_users') || '{}'),
            projects: JSON.parse(localStorage.getItem('meowboard_collaborative_projects') || '{}'),
            sessions: JSON.parse(localStorage.getItem('meowboard_sessions') || '{}')
        };

        // Sistema de autenticaci√≥n
        function showAuthModal() {
            let modal = document.getElementById('authModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'authModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üë§ Acceso a Meowboard</h3>
                            <button class="modal-close" onclick="closeModal('authModal')">√ó</button>
                        </div>
                        <div class="auth-content" style="padding: 20px;">
                            <!-- Tabs de Login/Registro -->
                            <div style="display: flex; margin-bottom: 20px;">
                                <button id="loginTab" onclick="switchAuthTab('login')" style="
                                    flex: 1; padding: 12px; border: none; background: #4CAF50; color: white; 
                                    border-radius: 8px 0 0 8px; cursor: pointer; font-size: 14px;
                                ">üîë Iniciar Sesi√≥n</button>
                                <button id="registerTab" onclick="switchAuthTab('register')" style="
                                    flex: 1; padding: 12px; border: none; background: #f5f5f5; color: #333; 
                                    border-radius: 0 8px 8px 0; cursor: pointer; font-size: 14px;
                                ">üìù Registrarse</button>
                            </div>
                            
                            <!-- Formulario de Login -->
                            <div id="loginForm" style="display: block;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìß Email:</label>
                                    <input type="email" id="loginEmail" placeholder="usuario@ejemplo.com" style="
                                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;
                                    ">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üîí Contrase√±a:</label>
                                    <input type="password" id="loginPassword" placeholder="Tu contrase√±a segura" style="
                                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;
                                    ">
                                </div>
                                <button onclick="performLogin()" style="
                                    width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; 
                                    border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 10px;
                                ">üöÄ Entrar a Meowboard</button>
                                <div style="text-align: center;">
                                    <a href="#" onclick="showPasswordReset()" style="color: #666; text-decoration: none; font-size: 13px;">
                                        ¬øOlvidaste tu contrase√±a?
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Formulario de Registro -->
                            <div id="registerForm" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ Nombre completo:</label>
                                    <input type="text" id="registerName" placeholder="Tu nombre completo" style="
                                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;
                                    ">
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìß Email:</label>
                                    <input type="email" id="registerEmail" placeholder="usuario@ejemplo.com" style="
                                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;
                                    ">
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üîí Contrase√±a:</label>
                                    <input type="password" id="registerPassword" placeholder="M√≠nimo 8 caracteres" style="
                                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;
                                    ">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">üé® Avatar:</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <div onclick="selectAvatar('üò∫')" class="avatar-option" data-avatar="üò∫">üò∫</div>
                                        <div onclick="selectAvatar('üò∏')" class="avatar-option" data-avatar="üò∏">üò∏</div>
                                        <div onclick="selectAvatar('üòª')" class="avatar-option" data-avatar="üòª">üòª</div>
                                        <div onclick="selectAvatar('üê±')" class="avatar-option" data-avatar="üê±">üê±</div>
                                        <div onclick="selectAvatar('üòº')" class="avatar-option" data-avatar="üòº">üòº</div>
                                        <div onclick="selectAvatar('üòΩ')" class="avatar-option" data-avatar="üòΩ">üòΩ</div>
                                    </div>
                                </div>
                                <button onclick="performRegister()" style="
                                    width: 100%; padding: 12px; background: #FF6B9D; color: white; border: none; 
                                    border-radius: 8px; font-size: 16px; cursor: pointer;
                                ">‚ú® Crear Cuenta</button>
                            </div>
                            
                            <!-- Demo login -->
                            <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; text-align: center;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 10px;">ÔøΩ Modo Demo - Sin servidor</div>
                                <button onclick="createDemoUser()" style="
                                    padding: 8px 15px; background: #2196F3; color: white; border: none; 
                                    border-radius: 6px; cursor: pointer; font-size: 13px;
                                ">üéÆ Probar como Usuario Demo</button>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        .avatar-option {
                            width: 40px; height: 40px; font-size: 24px; display: flex; align-items: center; 
                            justify-content: center; border: 2px solid #ddd; border-radius: 50%; cursor: pointer; 
                            transition: all 0.3s;
                        }
                        .avatar-option:hover, .avatar-option.selected {
                            border-color: #4CAF50; background: #e8f5e8; transform: scale(1.1);
                        }
                    </style>
                `;
                document.body.appendChild(modal);
            }
            modal.style.display = 'block';
        }

        function switchAuthTab(type) {
            document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = type === 'register' ? 'block' : 'none';
            
            document.getElementById('loginTab').style.background = type === 'login' ? '#4CAF50' : '#f5f5f5';
            document.getElementById('loginTab').style.color = type === 'login' ? 'white' : '#333';
            document.getElementById('registerTab').style.background = type === 'register' ? '#FF6B9D' : '#f5f5f5';
            document.getElementById('registerTab').style.color = type === 'register' ? 'white' : '#333';
        }

        let selectedAvatar = 'üò∫';
        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.avatar === avatar) opt.classList.add('selected');
            });
        }

        function performLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotificationMessage('‚ö†Ô∏è Por favor completa todos los campos', 'warning');
                return;
            }
            
            // Verificar credenciales
            const user = usersDatabase.users[email];
            if (user && user.password === password) {
                currentUser = user;
                localStorage.setItem('meowboard_current_session', JSON.stringify({
                    userId: email,
                    loginTime: Date.now(),
                    sessionId: generateSessionId()
                }));
                
                updateUserInterface();
                closeModal('authModal');
                showNotificationMessage(`üéâ ¬°Bienvenido de vuelta, ${user.name}!`, 'success');
                loadUserProjects();
            } else {
                showNotificationMessage('‚ùå Credenciales incorrectas', 'error');
            }
        }

        function performRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showNotificationMessage('‚ö†Ô∏è Por favor completa todos los campos', 'warning');
                return;
            }
            
            if (password.length < 8) {
                showNotificationMessage('‚ö†Ô∏è La contrase√±a debe tener m√≠nimo 8 caracteres', 'warning');
                return;
            }
            
            if (usersDatabase.users[email]) {
                showNotificationMessage('‚ö†Ô∏è Este email ya est√° registrado', 'warning');
                return;
            }
            
            // Crear nuevo usuario
            const newUser = {
                id: generateUserId(),
                name: name,
                email: email,
                password: password, // En producci√≥n se hashear√≠a
                avatar: selectedAvatar,
                joinDate: new Date().toISOString(),
                projects: [],
                collaborations: []
            };
            
            usersDatabase.users[email] = newUser;
            localStorage.setItem('meowboard_users', JSON.stringify(usersDatabase.users));
            
            currentUser = newUser;
            localStorage.setItem('meowboard_current_session', JSON.stringify({
                userId: email,
                loginTime: Date.now(),
                sessionId: generateSessionId()
            }));
            
            updateUserInterface();
            closeModal('authModal');
            showNotificationMessage(`‚ú® ¬°Cuenta creada exitosamente! Bienvenido ${name}`, 'success');
            loadUserProjects();
        }

        function createDemoUser() {
            const demoUser = {
                id: 'demo_' + Date.now(),
                name: 'Usuario Demo',
                email: 'demo@meowboard.com',
                avatar: 'üéÆ',
                joinDate: new Date().toISOString(),
                projects: [],
                collaborations: [],
                isDemo: true
            };
            
            currentUser = demoUser;
            updateUserInterface();
            closeModal('authModal');
            showNotificationMessage('üéÆ ¬°Modo demo activado! Todas las funciones disponibles', 'info');
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updateUserInterface() {
            if (currentUser) {
                // Actualizar bot√≥n de colaboraci√≥n
                const collabButton = document.querySelector('button[onclick="toggleChat()"]');
                if (collabButton) {
                    collabButton.innerHTML = `${currentUser.avatar} ${currentUser.name}`;
                    collabButton.onclick = () => showUserMenu();
                }
                
                // Mostrar indicador de usuario conectado
                showUserIndicator();
            }
        }

        function showUserIndicator() {
            let indicator = document.getElementById('userIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'userIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 25px;
                    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
                    z-index: 1500;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                indicator.onclick = () => showUserMenu();
                document.body.appendChild(indicator);
            }
            
            indicator.innerHTML = `
                <span style="font-size: 18px; margin-right: 8px;">${currentUser.avatar}</span>
                <span>${currentUser.name}</span>
                ${currentUser.isDemo ? '<span style="font-size: 10px; opacity: 0.8;"> (Demo)</span>' : ''}
            `;
        }

        function shareProject() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            showCollaborationModal();
        }

        function showCollaborationModal() {
            let modal = document.getElementById('collaborationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'collaborationModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">üë• Colaboraci√≥n en ${currentProject.name}</h3>
                            <button class="modal-close" onclick="closeModal('collaborationModal')">√ó</button>
                        </div>
                        <div class="collaboration-content" style="padding: 20px;">
                            <!-- Informaci√≥n del proyecto -->
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">üìã Informaci√≥n del Proyecto</div>
                                <div style="font-size: 13px; color: #1565c0;">
                                    <div>üë§ <strong>Propietario:</strong> ${currentUser.name} (${currentUser.email})</div>
                                    <div>üìÖ <strong>Creado:</strong> ${new Date(currentProject.createdAt || Date.now()).toLocaleDateString()}</div>
                                    <div>üë• <strong>Colaboradores:</strong> <span id="collaboratorCount">0</span></div>
                                </div>
                            </div>
                            
                            <!-- Invitar colaboradores -->
                            <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #7b1fa2;">‚úâÔ∏è Invitar Colaboradores</h4>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="email" id="inviteEmail" placeholder="email@ejemplo.com" style="
                                        flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;
                                    ">
                                    <select id="invitePermission" style="
                                        padding: 10px; border: 2px solid #ddd; border-radius: 6px; background: white;
                                    ">
                                        <option value="view">üëÅÔ∏è Ver</option>
                                        <option value="edit" selected>‚úèÔ∏è Editar</option>
                                        <option value="admin">‚öôÔ∏è Admin</option>
                                    </select>
                                    <button onclick="sendInvitation()" style="
                                        padding: 10px 20px; background: #9c27b0; color: white; border: none; 
                                        border-radius: 6px; cursor: pointer; white-space: nowrap;
                                    ">üì§ Invitar</button>
                                </div>
                                
                                <!-- Enlace p√∫blico -->
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <div style="margin-bottom: 8px; font-weight: bold; font-size: 13px;">üîó Enlace P√∫blico</div>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="publicLink" readonly 
                                               value="https://meowboard.com/project/${currentProject.id}?key=${generateShareKey()}" 
                                               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: #f9f9f9;">
                                        <button onclick="copyPublicLink()" style="
                                            padding: 8px 15px; background: #4caf50; color: white; border: none; 
                                            border-radius: 4px; cursor: pointer; font-size: 12px;
                                        ">üìã Copiar</button>
                                        <button onclick="togglePublicAccess()" style="
                                            padding: 8px 15px; background: #ff9800; color: white; border: none; 
                                            border-radius: 4px; cursor: pointer; font-size: 12px;
                                        ">üîê Privado</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lista de colaboradores activos -->
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #2e7d32;">üë• Colaboradores Activos</h4>
                                <div id="collaboratorsList" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                            
                            <!-- Configuraciones de colaboraci√≥n -->
                            <div style="background: #fff3e0; padding: 15px; border-radius: 10px;">
                                <h4 style="margin: 0 0 15px 0; color: #f57c00;">‚öôÔ∏è Configuraciones</h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="allowComments" checked>
                                        <span>üí¨ Permitir comentarios en elementos</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showCursors" checked>
                                        <span>üñ±Ô∏è Mostrar cursores de colaboradores</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="realTimeSync" checked>
                                        <span>‚ö° Sincronizaci√≥n en tiempo real</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="versionHistory" checked>
                                        <span>üìö Historial de versiones</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="startCollaborationSession()" style="
                                    flex: 1; padding: 12px; background: #4caf50; color: white; border: none; 
                                    border-radius: 8px; cursor: pointer; font-size: 16px;
                                ">üöÄ Iniciar Colaboraci√≥n</button>
                                <button onclick="showCollaborationHistory()" style="
                                    padding: 12px 20px; background: #2196f3; color: white; border: none; 
                                    border-radius: 8px; cursor: pointer;
                                ">üìä Historial</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            updateCollaboratorsList();
            modal.style.display = 'block';
        }

        function showUserMenu() {
            let menu = document.getElementById('userMenu');
            if (menu) {
                menu.remove();
                return;
            }
            
            menu = document.createElement('div');
            menu.id = 'userMenu';
            menu.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 15px;
                box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
                z-index: 2000;
                padding: 20px;
                min-width: 250px;
            `;
            
            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 48px; margin-bottom: 8px;">${currentUser.avatar}</div>
                    <div style="font-weight: bold; font-size: 16px;">${currentUser.name}</div>
                    <div style="font-size: 12px; color: #666;">${currentUser.email}</div>
                    ${currentUser.isDemo ? '<div style="font-size: 11px; color: #ff9800;">üëæ Modo Demo</div>' : ''}
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="showUserProjects()" style="
                        padding: 10px; background: #e3f2fd; border: 1px solid #2196f3; 
                        border-radius: 8px; cursor: pointer; text-align: left;
                    ">üìÅ Mis Proyectos</button>
                    
                    <button onclick="showCollaborations()" style="
                        padding: 10px; background: #f3e5f5; border: 1px solid #9c27b0; 
                        border-radius: 8px; cursor: pointer; text-align: left;
                    ">üë• Colaboraciones</button>
                    
                    <button onclick="showUserSettings()" style="
                        padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; 
                        border-radius: 8px; cursor: pointer; text-align: left;
                    ">‚öôÔ∏è Configuraci√≥n</button>
                    
                    <button onclick="logoutUser()" style="
                        padding: 10px; background: #ffebee; border: 1px solid #f44336; 
                        border-radius: 8px; cursor: pointer; text-align: left; color: #d32f2f;
                    ">üö™ Cerrar Sesi√≥n</button>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Cerrar al hacer clic fuera
            setTimeout(() => {
                document.addEventListener('click', function closeUserMenu(e) {
                    if (!menu.contains(e.target) && e.target.id !== 'userIndicator') {
                        menu.remove();
                        document.removeEventListener('click', closeUserMenu);
                    }
                }, { once: true });
            }, 100);
        }

        function sendInvitation() {
            const email = document.getElementById('inviteEmail').value;
            const permission = document.getElementById('invitePermission').value;
            
            if (!email) {
                showNotificationMessage('‚ö†Ô∏è Ingresa un email v√°lido', 'warning');
                return;
            }
            
            if (email === currentUser.email) {
                showNotificationMessage('‚ö†Ô∏è No puedes invitarte a ti mismo', 'warning');
                return;
            }
            
            // Verificar si el usuario existe (en modo offline simulamos)
            const targetUser = usersDatabase.users[email] || {
                email: email,
                name: 'Usuario Invitado',
                avatar: 'üë§',
                isInvited: true
            };
            
            // Agregar a colaboradores del proyecto
            if (!currentProject.collaborators) {
                currentProject.collaborators = [];
            }
            
            const existingCollaborator = currentProject.collaborators.find(c => c.email === email);
            if (existingCollaborator) {
                showNotificationMessage('‚ö†Ô∏è Este usuario ya es colaborador', 'warning');
                return;
            }
            
            const newCollaborator = {
                ...targetUser,
                permission: permission,
                invitedAt: new Date().toISOString(),
                invitedBy: currentUser.email,
                status: 'invited'
            };
            
            currentProject.collaborators.push(newCollaborator);
            saveProject();
            
            document.getElementById('inviteEmail').value = '';
            updateCollaboratorsList();
            showNotificationMessage(`‚úÖ Invitaci√≥n enviada a ${email}`, 'success');
            
            // Simular notificaci√≥n por email (en producci√≥n ser√≠a real)
            setTimeout(() => {
                showNotificationMessage(`üìß Email de invitaci√≥n enviado a ${email}`, 'info');
            }, 2000);
        }

        function updateCollaboratorsList() {
            const container = document.getElementById('collaboratorsList');
            const countElement = document.getElementById('collaboratorCount');
            
            if (!currentProject.collaborators) {
                currentProject.collaborators = [];
            }
            
            countElement.textContent = currentProject.collaborators.length;
            
            if (currentProject.collaborators.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                        üë• No hay colaboradores a√∫n.<br>
                        <small>¬°Invita a alguien para trabajar juntos!</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentProject.collaborators.map(collaborator => `
                <div style="
                    display: flex; align-items: center; justify-content: space-between; 
                    padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;
                ">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 24px;">${collaborator.avatar}</div>
                        <div>
                            <div style="font-weight: bold;">${collaborator.name}</div>
                            <div style="font-size: 12px; color: #666;">${collaborator.email}</div>
                            <div style="font-size: 11px; color: #999;">
                                ${getPermissionIcon(collaborator.permission)} ${getPermissionName(collaborator.permission)} ‚Ä¢ 
                                ${collaborator.status === 'invited' ? '‚è≥ Pendiente' : '‚úÖ Activo'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="changeCollaboratorPermission('${collaborator.email}')" style="
                            padding: 4px 8px; background: #2196f3; color: white; border: none; 
                            border-radius: 4px; cursor: pointer; font-size: 11px;
                        ">‚öôÔ∏è</button>
                        <button onclick="removeCollaborator('${collaborator.email}')" style="
                            padding: 4px 8px; background: #f44336; color: white; border: none; 
                            border-radius: 4px; cursor: pointer; font-size: 11px;
                        ">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function getPermissionIcon(permission) {
            return {
                'view': 'üëÅÔ∏è',
                'edit': '‚úèÔ∏è', 
                'admin': '‚öôÔ∏è'
            }[permission] || 'üë§';
        }

        function getPermissionName(permission) {
            return {
                'view': 'Ver',
                'edit': 'Editar',
                'admin': 'Administrador'
            }[permission] || 'Usuario';
        }

        function startCollaborationSession() {
            if (!currentProject.collaborators || currentProject.collaborators.length === 0) {
                showNotificationMessage('‚ö†Ô∏è Necesitas al menos un colaborador para iniciar sesi√≥n', 'warning');
                return;
            }
            
            collaborationSession = {
                id: generateSessionId(),
                projectId: currentProject.id,
                startTime: new Date().toISOString(),
                host: currentUser.email,
                participants: [currentUser.email],
                isActive: true
            };
            
            // Simular conexi√≥n en tiempo real
            showCollaborationIndicator();
            enableRealTimeFeatures();
            
            closeModal('collaborationModal');
            showNotificationMessage('üöÄ ¬°Colaboraci√≥n iniciada! Los colaboradores pueden unirse ahora', 'success');
            
            // Simular que colaboradores se unen
            setTimeout(() => {
                simulateCollaboratorJoining();
            }, 3000);
        }

        function showCollaborationIndicator() {
            let indicator = document.getElementById('collabIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'collabIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(45deg, #ff6b9d, #c44569);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 1400;
                    box-shadow: 0 2px 8px rgba(255, 107, 157, 0.4);
                    animation: pulse 2s infinite;
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.innerHTML = `
                <span style="display: inline-block; width: 8px; height: 8px; background: #4caf50; border-radius: 50%; margin-right: 6px; animation: blink 1s infinite;"></span>
                Colaboraci√≥n Activa
            `;
            
            // A√±adir estilos de animaci√≥n
            if (!document.getElementById('collabStyles')) {
                const style = document.createElement('style');
                style.id = 'collabStyles';
                style.textContent = `
                    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
                    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
                `;
                document.head.appendChild(style);
            }
        }

        function enableRealTimeFeatures() {
            // Habilitar cursores colaborativos
            document.addEventListener('mousemove', trackCursorMovement);
            
            // Habilitar comentarios en elementos
            enableElementComments();
            
            // Simular sincronizaci√≥n
            setInterval(syncCollaborativeChanges, 2000);
        }

        let lastCursorPosition = { x: 0, y: 0 };
        function trackCursorMovement(e) {
            lastCursorPosition = { x: e.clientX, y: e.clientY };
            
            // En producci√≥n, esto se enviar√≠a via WebSocket
            if (Math.random() < 0.1) { // Simular actualizaci√≥n ocasional
                showCollaboratorCursor(e.clientX, e.clientY);
            }
        }

        function showCollaboratorCursor(x, y) {
            let cursor = document.getElementById('collabCursor');
            if (!cursor) {
                cursor = document.createElement('div');
                cursor.id = 'collabCursor';
                cursor.style.cssText = `
                    position: fixed;
                    width: 20px;
                    height: 20px;
                    background: #ff6b9d;
                    border-radius: 50% 0 50% 50%;
                    transform: rotate(-45deg);
                    z-index: 9999;
                    pointer-events: none;
                    transition: all 0.1s ease;
                `;
                document.body.appendChild(cursor);
                
                const label = document.createElement('div');
                label.style.cssText = `
                    position: absolute;
                    top: 25px;
                    left: 25px;
                    background: #ff6b9d;
                    color: white;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 11px;
                    white-space: nowrap;
                `;
                label.textContent = 'Colaborador';
                cursor.appendChild(label);
            }
            
            cursor.style.left = (x + Math.random() * 100 - 50) + 'px';
            cursor.style.top = (y + Math.random() * 100 - 50) + 'px';
            
            // Auto-hide despu√©s de un tiempo
            clearTimeout(cursor.hideTimeout);
            cursor.hideTimeout = setTimeout(() => {
                cursor.style.opacity = '0';
            }, 3000);
            cursor.style.opacity = '1';
        }

        function syncCollaborativeChanges() {
            if (!collaborationSession || !collaborationSession.isActive) return;
            
            // Simular cambios de colaboradores
            if (Math.random() < 0.3) {
                const changes = [
                    'Un colaborador agreg√≥ un elemento',
                    'Se actualiz√≥ el t√≠tulo del proyecto',
                    'Un colaborador cambi√≥ el color de un elemento',
                    'Se agreg√≥ un comentario'
                ];
                
                const randomChange = changes[Math.floor(Math.random() * changes.length)];
                showNotificationMessage(`üîÑ ${randomChange}`, 'info');
            }
        }

        function generateShareKey() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function copyPublicLink() {
            const linkInput = document.getElementById('publicLink');
            linkInput.select();
            document.execCommand('copy');
            showNotificationMessage('üîó Enlace copiado al portapapeles', 'success');
        }

        function logoutUser() {
            if (confirm('¬øCerrar sesi√≥n y perder progreso no guardado?')) {
                currentUser = null;
                localStorage.removeItem('meowboard_current_session');
                
                // Limpiar UI
                document.getElementById('userIndicator')?.remove();
                document.getElementById('userMenu')?.remove();
                document.getElementById('collabIndicator')?.remove();
                document.getElementById('collabCursor')?.remove();
                
                // Resetear bot√≥n de colaboraci√≥n
                const collabButton = document.querySelector('button[onclick*="showUserMenu"]');
                if (collabButton) {
                    collabButton.innerHTML = 'üë• Colaboraci√≥n';
                    collabButton.onclick = () => showAuthModal();
                }
                
                showNotificationMessage('üëã Sesi√≥n cerrada exitosamente', 'info');
            }
        }

        // Verificar sesi√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const session = JSON.parse(localStorage.getItem('meowboard_current_session') || 'null');
            if (session && session.userId) {
                const user = usersDatabase.users[session.userId];
                if (user) {
                    currentUser = user;
                    updateUserInterface();
                }
            }
        });

        // ====== SISTEMA DE CHAT COLABORATIVO ======
        
        function toggleChat() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            let chatWidget = document.getElementById('collaborativeChatWidget');
            if (!chatWidget) {
                createCollaborativeChat();
            } else {
                chatWidget.style.display = chatWidget.style.display === 'none' ? 'flex' : 'none';
            }
        }

        function createCollaborativeChat() {
            const chatWidget = document.createElement('div');
            chatWidget.id = 'collaborativeChatWidget';
            chatWidget.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 320px;
                height: 450px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                display: flex;
                flex-direction: column;
                z-index: 2000;
                box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
                color: white;
            `;
            
            chatWidget.innerHTML = `
                <div style="
                    padding: 15px 20px 10px 20px;
                    border-bottom: 1px solid rgba(255,255,255,0.2);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div>
                        <div style="font-weight: bold; font-size: 16px;">üí¨ Chat Colaborativo</div>
                        <div style="font-size: 11px; opacity: 0.8;">
                            ${collaborationSession ? 
                                `üü¢ ${collaborationSession.participants.length} conectados` : 
                                'üî¥ Sin colaboraci√≥n activa'}
                        </div>
                    </div>
                    <button onclick="toggleChat()" style="
                        background: none; border: none; color: white; font-size: 18px; cursor: pointer;
                    ">√ó</button>
                </div>
                
                <div id="chatMessages" style="
                    flex: 1;
                    padding: 15px;
                    overflow-y: auto;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                "></div>
                
                <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="collabChatInput" placeholder="Escribe tu mensaje..." style="
                            flex: 1;
                            padding: 10px;
                            border: none;
                            border-radius: 20px;
                            background: rgba(255,255,255,0.2);
                            color: white;
                            font-size: 14px;
                        " onkeypress="if(event.key==='Enter') sendCollaborativeMessage()">
                        <button onclick="sendCollaborativeMessage()" style="
                            background: rgba(255,255,255,0.3);
                            border: none;
                            color: white;
                            padding: 10px 15px;
                            border-radius: 20px;
                            cursor: pointer;
                        ">üì§</button>
                    </div>
                    
                    <!-- Indicador de escritura -->
                    <div id="typingIndicator" style="
                        font-size: 11px;
                        opacity: 0.7;
                        margin-top: 5px;
                        display: none;
                    "></div>
                </div>
            `;
            
            document.body.appendChild(chatWidget);
            loadChatHistory();
        }

        function sendCollaborativeMessage() {
            const input = document.getElementById('collabChatInput');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            const messageObj = {
                id: Date.now(),
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: message,
                timestamp: new Date().toISOString(),
                projectId: currentProject.id
            };
            
            // Guardar en historial del proyecto
            if (!currentProject.chatHistory) {
                currentProject.chatHistory = [];
            }
            currentProject.chatHistory.push(messageObj);
            saveProject();
            
            displayCollaborativeMessage(messageObj);
            input.value = '';
            
            // Simular respuesta de colaborador
            if (collaborationSession && Math.random() < 0.4) {
                setTimeout(() => {
                    const collaborators = ['Ana Garc√≠a üë©‚Äçüíº', 'Carlos L√≥pez üë®‚Äçüé®', 'Mar√≠a Silva üë©‚Äçüíª'];
                    const randomCollaborator = collaborators[Math.floor(Math.random() * collaborators.length)];
                    const responses = [
                        'üëç Perfecto!',
                        'Me gusta esa idea',
                        '¬øQu√© opinas de cambiar el color?',
                        'Ya actualic√© esa secci√≥n',
                        '‚ú® Genial! Sigue as√≠',
                        '¬øPodemos revisar esto juntos?'
                    ];
                    
                    const autoReply = {
                        id: Date.now() + 1,
                        user: randomCollaborator.split(' ')[0],
                        avatar: randomCollaborator.split(' ')[2],
                        text: responses[Math.floor(Math.random() * responses.length)],
                        timestamp: new Date().toISOString(),
                        projectId: currentProject.id
                    };
                    
                    currentProject.chatHistory.push(autoReply);
                    displayCollaborativeMessage(autoReply);
                }, 1000 + Math.random() * 3000);
            }
        }

        function displayCollaborativeMessage(messageObj) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            const isOwnMessage = messageObj.user === currentUser.name;
            
            messageDiv.style.cssText = `
                display: flex;
                ${isOwnMessage ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
                margin-bottom: 8px;
            `;
            
            messageDiv.innerHTML = `
                <div style="
                    max-width: 70%;
                    background: ${isOwnMessage ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.2)'};
                    color: ${isOwnMessage ? '#333' : 'white'};
                    padding: 8px 12px;
                    border-radius: 15px;
                    font-size: 13px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                ">
                    ${!isOwnMessage ? `<div style="font-size: 10px; opacity: 0.7; margin-bottom: 3px;">${messageObj.avatar} ${messageObj.user}</div>` : ''}
                    <div>${messageObj.text}</div>
                    <div style="font-size: 10px; opacity: 0.6; text-align: right; margin-top: 3px;">
                        ${new Date(messageObj.timestamp).toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function loadChatHistory() {
            const container = document.getElementById('chatMessages');
            if (!container || !currentProject.chatHistory) return;
            
            container.innerHTML = '';
            
            currentProject.chatHistory.forEach(message => {
                displayCollaborativeMessage(message);
            });
        }

        // ====== SISTEMA DE COMENTARIOS EN ELEMENTOS ======
        
        function enableElementComments() {
            // Agregar listener para clic derecho en elementos
            canvas.addEventListener('contextmenu', function(e) {
                const element = e.target;
                if (element !== canvas && element.parentElement === canvas) {
                    e.preventDefault();
                    showElementCommentMenu(e, element);
                }
            });
        }

        function showElementCommentMenu(e, element) {
            // Remover men√∫s existentes
            document.querySelectorAll('.element-comment-menu').forEach(menu => menu.remove());
            
            const menu = document.createElement('div');
            menu.className = 'element-comment-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${e.clientX}px;
                top: ${e.clientY}px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                z-index: 10000;
                padding: 12px 0;
                min-width: 180px;
            `;
            
            menu.innerHTML = `
                <div onclick="addElementComment('${element.id || generateElementId(element)}')" style="
                    padding: 10px 16px; cursor: pointer; font-size: 14px;
                " onmouseover="this.style.background='#f0f8f0'" onmouseout="this.style.background='white'">
                    üí¨ Agregar Comentario
                </div>
                <div onclick="showElementComments('${element.id || generateElementId(element)}')" style="
                    padding: 10px 16px; cursor: pointer; font-size: 14px;
                " onmouseover="this.style.background='#f0f8f0'" onmouseout="this.style.background='white'">
                    üëÅÔ∏è Ver Comentarios
                </div>
                <div onclick="highlightElement('${element.id || generateElementId(element)}')" style="
                    padding: 10px 16px; cursor: pointer; font-size: 14px;
                " onmouseover="this.style.background='#f0f8f0'" onmouseout="this.style.background='white'">
                    ‚ú® Resaltar Elemento
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Cerrar al hacer clic fuera
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: true });
            }, 100);
        }

        function generateElementId(element) {
            if (!element.id) {
                element.id = 'element_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            return element.id;
        }

        function addElementComment(elementId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            const comment = prompt('üí¨ Agregar comentario:');
            if (!comment) return;
            
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Inicializar comentarios del proyecto
            if (!currentProject.elementComments) {
                currentProject.elementComments = {};
            }
            if (!currentProject.elementComments[elementId]) {
                currentProject.elementComments[elementId] = [];
            }
            
            const commentObj = {
                id: Date.now(),
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: comment,
                timestamp: new Date().toISOString()
            };
            
            currentProject.elementComments[elementId].push(commentObj);
            saveProject();
            
            // Mostrar indicador de comentario
            showCommentIndicator(element);
            
            showNotificationMessage('üí¨ Comentario agregado', 'success');
            
            // Cerrar men√∫
            document.querySelectorAll('.element-comment-menu').forEach(menu => menu.remove());
        }

        function showCommentIndicator(element) {
            // Remover indicador existente
            const existingIndicator = element.querySelector('.comment-indicator');
            if (existingIndicator) existingIndicator.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'comment-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                width: 20px;
                height: 20px;
                background: #FF6B9D;
                border: 2px solid white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                color: white;
                z-index: 1001;
                cursor: pointer;
            `;
            indicator.textContent = 'üí¨';
            indicator.onclick = (e) => {
                e.stopPropagation();
                showElementComments(element.id);
            };
            
            element.style.position = 'relative';
            element.appendChild(indicator);
        }

        function showElementComments(elementId) {
            const comments = currentProject.elementComments?.[elementId] || [];
            
            let modal = document.getElementById('commentsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'commentsModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 70vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">üí¨ Comentarios del Elemento</h3>
                        <button class="modal-close" onclick="closeModal('commentsModal')">√ó</button>
                    </div>
                    <div style="padding: 20px;">
                        <div id="commentsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            ${comments.length === 0 ? 
                                '<div style="text-align: center; color: #666; padding: 20px;">üìù No hay comentarios a√∫n</div>' :
                                comments.map(comment => `
                                    <div style="
                                        display: flex; gap: 10px; padding: 12px; background: #f8f9fa; 
                                        border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #4CAF50;
                                    ">
                                        <div style="font-size: 24px;">${comment.avatar}</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; font-size: 14px;">${comment.user}</div>
                                            <div style="margin: 5px 0; font-size: 13px;">${comment.text}</div>
                                            <div style="font-size: 11px; color: #666;">
                                                ${new Date(comment.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                        
                        ${currentUser ? `
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newCommentText" placeholder="Escribe un comentario..." style="
                                    flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;
                                ">
                                <button onclick="addCommentFromModal('${elementId}')" style="
                                    padding: 10px 20px; background: #4CAF50; color: white; border: none; 
                                    border-radius: 6px; cursor: pointer;
                                ">‚ûï Agregar</button>
                            </div>
                        ` : '<div style="text-align: center; color: #666;">Inicia sesi√≥n para comentar</div>'}
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Cerrar men√∫ contextual
            document.querySelectorAll('.element-comment-menu').forEach(menu => menu.remove());
        }

        function addCommentFromModal(elementId) {
            const input = document.getElementById('newCommentText');
            const comment = input.value.trim();
            
            if (!comment) return;
            
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Agregar comentario
            if (!currentProject.elementComments) {
                currentProject.elementComments = {};
            }
            if (!currentProject.elementComments[elementId]) {
                currentProject.elementComments[elementId] = [];
            }
            
            const commentObj = {
                id: Date.now(),
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: comment,
                timestamp: new Date().toISOString()
            };
            
            currentProject.elementComments[elementId].push(commentObj);
            saveProject();
            
            // Actualizar UI
            showCommentIndicator(element);
            input.value = '';
            
            // Recargar modal
            showElementComments(elementId);
            
            showNotificationMessage('üí¨ Comentario agregado', 'success');
        }

        // Inicializar comentarios al cargar proyecto
        function loadProjectComments() {
            if (!currentProject.elementComments) return;
            
            Object.keys(currentProject.elementComments).forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element && currentProject.elementComments[elementId].length > 0) {
                    showCommentIndicator(element);
                }
            });
        }

        function displayChatMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                margin-bottom: 10px;
                padding: 8px 12px;
                background: ${message.user === 'T√∫' ? '#FFB6D9' : '#f0f0f0'};
                color: ${message.user === 'T√∫' ? 'white' : '#333'};
                border-radius: 15px;
                font-size: 13px;
                max-width: 80%;
                align-self: ${message.user === 'T√∫' ? 'flex-end' : 'flex-start'};
                margin-left: ${message.user === 'T√∫' ? 'auto' : '0'};
            `;
            
            messageEl.innerHTML = `
                <strong>${message.user}</strong><br>
                ${message.text}<br>
                <small style="opacity: 0.7;">${message.timestamp.toLocaleTimeString()}</small>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getAutoReply(message) {
            const replies = [
                "¬°Genial! Me gusta esa idea üê±",
                "Interesante perspectiva! ¬øQu√© opinas de...? üí≠",
                "¬°Excelente punto! Podr√≠amos a√±adir... ‚ú®",
                "Me parece perfecto para el proyecto üéØ",
                "¬øHas considerado tambi√©n...? ü§î",
                "¬°Eso suena muy innovador! üöÄ"
            ];
            return replies[Math.floor(Math.random() * replies.length)];
        }

        function showCollaborators() {
            alert('üë• Colaboradores Activos:\n\nüê± T√∫ (Propietario)\nü§ñ Meowboard Bot (IA Assistant)\n\nüöß Funci√≥n completa pr√≥ximamente!');
        }

        function showVersionHistory() {
            alert('üìã Historial de Versiones:\n\nüìù √öltima modificaci√≥n: Ahora\nüíæ √öltimo guardado: ' + new Date().toLocaleString() + '\nüîÑ Cambios sin guardar: 0\n\nüöß Historial completo pr√≥ximamente!');
        }

        // ====== IMPORTAR/EXPORTAR ======
        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }

        function handleFileDrop(e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            processImportFiles(files);
            e.target.classList.remove('dragover');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.target.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('dragover');
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processImportFiles(files);
        }

        function processImportFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (file.type === 'application/json') {
                            // Importar JSON (formato Meowboard)
                            const data = JSON.parse(e.target.result);
                            importMeowboardData(data);
                        } else if (file.type === 'text/plain') {
                            // Importar texto plano
                            importTextFile(e.target.result, file.name);
                        } else {
                            // Otros tipos de archivo
                            showProjectSwitchMessage(`üìÅ Archivo "${file.name}" importado como enlace`);
                        }
                    } catch (error) {
                        console.error('Error importing file:', error);
                        showProjectSwitchMessage(`‚ùå Error al importar "${file.name}"`);
                    }
                };
                
                reader.readAsText(file);
            });
            
            closeModal('importModal');
        }

        function importMeowboardData(data) {
            if (data.elements) {
                data.elements.forEach((elementData, index) => {
                    setTimeout(() => {
                        const element = createElement(elementData);
                        if (element) {
                            // Posicionar en una nueva √°rea para no sobrelapar
                            element.style.left = (parseInt(element.style.left) + 50) + 'px';
                            element.style.top = (parseInt(element.style.top) + 50) + 'px';
                            canvas.appendChild(element);
                            makeDraggable(element);
                        }
                    }, index * 100);
                });
                
                showProjectSwitchMessage(`üì• ${data.elements.length} elementos importados`);
                saveBoard();
            }
        }

        function importTextFile(content, filename) {
            // Crear un bloque de texto con el contenido
            const textBlock = document.createElement('div');
            textBlock.className = 'text-block';
            
            const viewportCenterX = (-panX / zoomLevel) + (window.innerWidth / (2 * zoomLevel));
            const viewportCenterY = (-panY / zoomLevel) + (window.innerHeight / (2 * zoomLevel));
            
            textBlock.style.left = (viewportCenterX - 125) + 'px';
            textBlock.style.top = (viewportCenterY - 100) + 'px';
            
            textBlock.innerHTML = `
                <h3 contenteditable="true">üìÑ ${filename}</h3>
                <p contenteditable="true">${content.substring(0, 500)}${content.length > 500 ? '...' : ''}</p>
                <button class="note-close" onclick="removeElement(this.parentElement)" style="position: absolute; top: 10px; right: 10px;">√ó</button>
            `;
            
            canvas.appendChild(textBlock);
            makeDraggable(textBlock);
            textBlock.classList.add('wiggle');
            saveBoard();
        }

        function exportAs(format) {
            const projectData = {
                project: currentProject,
                elements: [],
                timestamp: new Date().toISOString()
            };
            
            // Recopilar todos los elementos
            canvas.querySelectorAll('.sticky-note, .text-block, .image-card, .link-card').forEach(element => {
                const data = {
                    type: element.className.split(' ')[0],
                    left: element.style.left,
                    top: element.style.top,
                    width: element.style.width,
                    height: element.style.height,
                    content: getElementContent(element)
                };
                projectData.elements.push(data);
            });
            
            switch (format) {
                case 'json':
                    downloadJSON(projectData);
                    break;
                case 'pdf':
                    generatePDF(projectData);
                    break;
                case 'html':
                    generateHTML(projectData);
                    break;
                case 'png':
                    generateImage();
                    break;
                default:
                    alert(`üöß Exportar a ${format.toUpperCase()}: Pr√≥ximamente disponible! üê±`);
            }
            
            closeModal('exportModal');
        }

        function downloadJSON(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}_backup.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showProjectSwitchMessage('üíæ Backup JSON descargado!');
        }

        function generatePDF(data) {
            // Simulaci√≥n - en una implementaci√≥n real usar√≠as una librer√≠a como jsPDF
            alert('üìÑ Generando PDF...\n\nüöß Pr√≥ximamente disponible!\n\nFunciones planeadas:\n‚Ä¢ PDF interactivo\n‚Ä¢ Conservar colores y dise√±o\n‚Ä¢ Enlaces clicables\n‚Ä¢ Optimizado para impresi√≥n');
        }

        function generateHTML(data) {
            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${currentProject.name} - Meowboard Export</title>
                <style>
                    body { font-family: 'Comfortaa', sans-serif; background: ${generateProjectGradient(currentProject.color)}; }
                    .element { position: absolute; padding: 10px; border-radius: 10px; }
                    .sticky-note { background: #FFFACD; border: 2px solid #FFD700; }
                    .text-block { background: white; border: 2px solid #A8E6CF; }
                </style>
            </head>
            <body>
                <h1>üê± ${currentProject.name}</h1>
            `;
            
            data.elements.forEach(element => {
                html += `<div class="element ${element.type}" style="left: ${element.left}; top: ${element.top};">`;
                if (element.content.title) html += `<h3>${element.content.title}</h3>`;
                if (element.content.text) html += `<p>${element.content.text}</p>`;
                if (element.content.content) html += `<p>${element.content.content}</p>`;
                html += `</div>`;
            });
            
            html += '</body></html>';
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}_export.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            showProjectSwitchMessage('üåê Sitio web generado!');
        }

        function generateImage() {
            // Capturar el canvas como imagen
            html2canvas(canvas).then(canvas => {
                const link = document.createElement('a');
                link.download = `${currentProject.name}_screenshot.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                showProjectSwitchMessage('üñºÔ∏è Imagen PNG descargada!');
            }).catch(() => {
                // Fallback si html2canvas no est√° disponible
                alert('üì∏ Captura de pantalla: Requiere librer√≠a adicional\n\nüöß Pr√≥ximamente disponible de forma nativa!');
            });    
        }

        // ====== ESTAD√çSTICAS ======
        function showStatsModal() {
            updateProductivityStats();
            document.getElementById('statsModal').style.display = 'flex';
        }

        function updateProductivityStats() {
            const totalElements = canvas.querySelectorAll('.sticky-note, .text-block, .image-card, .link-card').length;
            const currentSession = Math.floor((Date.now() - sessionStartTime) / (1000 * 60)); // minutos
            
            document.getElementById('totalElements').textContent = totalElements;
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('timeSpent').textContent = currentSession + 'm';
            
            // Calcular productividad basada en elementos creados vs tiempo
            const productivity = totalElements > 0 ? Math.min(100, Math.floor((totalElements / Math.max(1, currentSession)) * 10)) : 0;
            document.getElementById('productivity').textContent = productivity + '%';
        }

        function showBackupModal() {
            alert('üíæ Sistema de Backup Autom√°tico:\n\n‚úÖ Guardado local: Activo\nüîÑ Sincronizaci√≥n: Cada 30s\nüì± Backup offline: Disponible\n\nüöß Backup en la nube pr√≥ximamente!');
        }

        // Verificar compatibilidad del navegador para grabaci√≥n de video
        function checkVideoRecordingCompatibility() {
            const requirements = {
                getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                mediaRecorder: !!(window.MediaRecorder),
                blobSupport: !!(window.Blob && window.URL && window.URL.createObjectURL),
                webmVideo: !!(MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm')),
                webmAudio: !!(MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')),
                mp4Video: !!(MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/mp4')),
                mp4Audio: !!(MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/mp4;codecs=h264,aac')),
                httpsSecure: location.protocol === 'https:' || location.hostname === 'localhost'
            };
            
            const compatible = requirements.getUserMedia && requirements.mediaRecorder && requirements.blobSupport;
            
            // Verificar soporte espec√≠fico de audio
            const audioSupport = requirements.webmAudio || requirements.mp4Audio;
            
            if (!audioSupport) {
                console.warn('‚ö†Ô∏è Soporte de audio limitado en este navegador');
            }
            
            if (!compatible) {
                console.warn('üö® Funcionalidades de grabaci√≥n de video limitadas:', requirements);
                
                // Mostrar mensaje de compatibilidad si el usuario intenta usar grabaci√≥n
                const originalToggleVideoMethod = toggleVideoMethod;
                toggleVideoMethod = function(method) {
                    if (method === 'record' && !compatible) {
                        let message = '‚ö†Ô∏è Tu navegador no soporta grabaci√≥n de video/audio.';
                        if (!requirements.httpsSecure) {
                            message += ' Necesitas HTTPS para acceder a c√°mara/micr√≥fono.';
                        } else {
                            message += ' Usa Chrome, Firefox o Edge actualizado.';
                        }
                        showNotificationMessage(message, 'error');
                        return;
                    }
                    originalToggleVideoMethod(method);
                };
                
                return false;
            }
            
            // Mensaje espec√≠fico sobre capacidades
            if (audioSupport) {
                console.log('‚úÖ Grabaci√≥n de video y audio totalmente compatible');
            } else {
                console.log('‚úÖ Grabaci√≥n de video compatible (audio limitado)');
            }
            return true;
        }

        // Inicializar nuevas funcionalidades
        function initializeAdvancedFeatures() {
            // Verificar compatibilidad de grabaci√≥n de video
            checkVideoRecordingCompatibility();
            
            // Detectar estado de conexi√≥n
            window.addEventListener('online', () => {
                isOnline = true;
                showProjectSwitchMessage('üåê Conexi√≥n restaurada');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showProjectSwitchMessage('üì± Trabajando offline');
            });
            
            // Inicializar chat input
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Tracking de productividad
            setInterval(() => {
                lastActivity = Date.now();
                totalWorkTime += 1000; // 1 segundo
            }, 1000);
            
            // A√±adir compatibilidad con eventos touch para dispositivos m√≥viles
            if ('ontouchstart' in window) {
                console.log('üì± Dispositivo t√°ctil detectado - Habilitando soporte touch');
                
                // Convertir eventos touch en eventos mouse para mejor compatibilidad
                document.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    e.target.dispatchEvent(mouseEvent);
                });
                
                document.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // Prevenir scroll en m√≥vil
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    document.dispatchEvent(mouseEvent);
                });
                
                document.addEventListener('touchend', (e) => {
                    const mouseEvent = new MouseEvent('mouseup', {});
                    document.dispatchEvent(mouseEvent);
                });
            }
            
            // Optimizaci√≥n de rendimiento
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.duration > 50) { // Si una tarea toma m√°s de 50ms
                        console.log(`‚ö†Ô∏è Tarea lenta detectada: ${entry.name} - ${entry.duration}ms`);
                    }
                }
            });
            
            // Solo observar en navegadores que lo soporten
            if ('PerformanceObserver' in window) {
                try {
                    observer.observe({ entryTypes: ['measure', 'navigation'] });
                } catch (e) {
                    console.log('PerformanceObserver no disponible en este navegador');
                }
            }
        }

        // Funciones de utilidad para debugging y desarrollo
        window.MeowboardDebug = {
            // Funci√≥n para exportar datos del proyecto actual para debug
            exportCurrentProject: () => {
                if (!currentProject) return null;
                saveCurrentProjectData();
                return JSON.stringify(currentProject, null, 2);
            },
            
            // Funci√≥n para verificar estado del sistema
            getSystemStatus: () => {
                return {
                    browserCompatibility: checkVideoRecordingCompatibility(),
                    projectsCount: projects.length,
                    currentProject: currentProject?.name || 'None',
                    elementsOnCanvas: canvas.children.length,
                    autoSaveEnabled: isAutoSaveEnabled,
                    isOnline: isOnline
                };
            },
            
            // Funci√≥n para limpiar localStorage (para desarrollo)
            clearStorage: () => {
                if (confirm('üö® ¬øEst√°s seguro? Esto eliminar√° TODOS los proyectos guardados.')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // Event listeners para drag and drop
        document.addEventListener('mousemove', pan);
        document.addEventListener('mouseup', stopPan);

        // Prevenir el comportamiento por defecto del navegador
        document.addEventListener('dragstart', e => e.preventDefault());
        document.addEventListener('selectstart', e => {
            if (isDragging) e.preventDefault();
        });

        // Mostrar mensaje inicial si no hay elementos guardados
        window.addEventListener('load', () => {
            if (!localStorage.getItem('meoword-board')) {
                setTimeout(showWelcomeMessage, 1000);
            }
        });
    </script>
</body>
</html>